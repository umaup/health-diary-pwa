<!DOCTYPE html>
<html lang="zh-Hant">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
Â  <title>å¥åº·æ—¥èªŒ</title>
Â Â 
Â  <!-- PWA Manifest and Theme Color -->
Â  <meta name="theme-color" content="#f8fafc"/>
Â  <meta name="apple-mobile-web-app-capable" content="yes">
Â  <meta name="apple-mobile-web-app-status-bar-style" content="default">
Â  <meta name="apple-mobile-web-app-title" content="å¥åº·æ—¥èªŒ">
Â  <link rel="apple-touch-icon" href="https://placehold.co/192x192/3B82F6/FFFFFF?text=æ—¥èªŒ">

Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/dayjs"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/dayjs/plugin/relativeTime.js"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/dayjs/plugin/customParseFormat.js"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/dayjs/plugin/weekOfYear.js"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/dayjs/locale/zh-tw.js"></script>
Â  <script>
Â  Â  tailwind.config = { darkMode: 'class' };
Â  </script>
Â  <style>
Â  Â  :root { color-scheme: light; }
Â  Â  html.dark { color-scheme: dark; }
Â  Â  body {
Â  Â  Â  font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
Â  Â  Â  -webkit-tap-highlight-color: transparent;
Â  Â  }
Â  Â  .page { display: none; animation: fadeIn 0.3s ease-in-out; }
Â  Â  .page.active { display: block; }
Â  Â  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }

Â  Â  .nav-item {
Â  Â  Â  Â  border-bottom: 3px solid transparent;
Â  Â  Â  Â  transition: all 0.2s ease-in-out;
Â  Â  }
Â  Â  .nav-item.active {
Â  Â  Â  Â  border-bottom-color: #3B82F6;
Â  Â  }
Â  Â  .nav-item.active svg, .nav-item.active .nav-text {
Â  Â  Â  Â  color: #3B82F6;
Â  Â  }
Â  Â  .nav-item.active .nav-text {
Â  Â  Â  Â  font-weight: 600;
Â  Â  }

Â  Â  #toast-notification {
Â  Â  Â  position: fixed; top: -100px; left: 50%;
Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  transition: top 0.4s ease-in-out, opacity 0.4s ease-in-out;
Â  Â  Â  opacity: 0;
Â  Â  Â  z-index: 9999;
Â  Â  }
Â  Â  #toast-notification.show { top: 20px; opacity: 1; }

Â  Â  .bristol-item, .color-item { transition: all 0.2s ease-in-out; }
Â  Â  .bristol-item.bristol-selected {
Â  Â  Â  border-color: #3B82F6; background-color: #EFF6FF; transform: scale(1.05);
Â  Â  }
Â  Â  .color-item.bristol-selected {
Â  Â  Â  Â  border-color: #3B82F6; background-color: #EFF6FF;
Â  Â  }
Â  Â  html.dark .bristol-item.bristol-selected {
Â  Â  Â  background-color: #0b3a75; border-color: #60a5fa;
Â  Â  }
Â  Â  Â html.dark .color-item.bristol-selected {
Â  Â  Â  background-color: #0b3a75; border-color: #60a5fa;
Â  Â  }

Â  Â  .star-rating .star { color: #d1d5db; cursor: pointer; transition: color 0.2s; }
Â  Â  .star-rating .star:hover, .star-rating .star.selected { color: #f59e0b; }

Â  Â  .custom-checkbox:checked, .custom-radio:checked {
Â  Â  Â  background-color: #3B82F6;
Â  Â  Â  border-color: #3B82F6;
Â  Â  }
Â  Â  Â .custom-radio:checked {
Â  Â  Â  background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3ccircle cx='8' cy='8' r='3'/%3e%3c/svg%3e");
Â  Â  }

Â  Â  .option-button-group .option-button { transition: all 0.2s ease-in-out; }
Â  Â  .option-button-group .option-button.selected { background-color: #3B82F6; color: white; border-color: #3B82F6; }

Â  Â  .modal.hidden { display: none; }

Â  Â  .form-section { border-top-width: 1px; padding-top: 10px; margin-top: 10px; }
Â  Â  .form-section-label { display: inline-flex; align-items: center; gap: 6px; font-weight: 600; font-size: 0.9rem; }
Â  Â  .form-section-label svg { width: 16px; height: 16px; }

Â  Â  button:focus-visible, .option-button:focus-visible, .bristol-item:focus-visible, .color-item:focus-visible {
Â  Â  Â  outline: 2px solid #3B82F6; outline-offset: 2px;
Â  Â  }

Â  Â  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
Â  Â  .spinner { animation: spin 1s linear infinite; }
Â  Â Â 
Â  Â  .status-badge {
Â  Â  Â  Â  display: inline-flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  padding: 2px 8px;
Â  Â  Â  Â  border-radius: 9999px;
Â  Â  Â  Â  font-size: 11px;
Â  Â  Â  Â  font-weight: 600;
Â  Â  }
Â  Â  .status-badge-green { background-color: #D1FAE5; color: #065F46; }
Â  Â  .status-badge-orange { background-color: #FFEDD5; color: #9A3412; }
Â  Â  .status-badge-blue { background-color: #DBEAFE; color: #1E40AF; }
Â  Â  .status-badge-red { background-color: #FEE2E2; color: #991B1B; }
Â  Â Â 
Â  Â  .empty-state {
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  padding: 40px 20px;
Â  Â  Â  Â  border: 2px dashed #d1d5db;
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  color: #6b7280;
Â  Â  }
Â  Â  html.dark .empty-state {
Â  Â  Â  Â  border-color: #4b5563;
Â  Â  Â  Â  color: #9ca3af;
Â  Â  }
Â  Â  .empty-state svg {
Â  Â  Â  Â  margin: 0 auto 12px;
Â  Â  }
Â  </style>
</head>
<body class="bg-slate-100 dark:bg-slate-950 transition-colors duration-300">
Â  <div id="app" class="max-w-lg mx-auto bg-slate-50 dark:bg-slate-900 min-h-screen shadow-lg relative transition-colors duration-300 overflow-x-hidden">
Â  Â  <header id="app-header" class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm sticky top-0 z-10 shadow-sm transition-colors duration-300">
Â  Â  Â  <div id="app-header-top" class="text-slate-800 dark:text-slate-200 p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
Â  Â  Â  Â  <div class="w-10 h-10"></div> <!-- Placeholder for alignment -->
Â  Â  Â  Â  <h1 id="header-title" class="text-xl font-bold tracking-wide text-center">å¥åº·æ—¥èªŒ</h1>
Â  Â  Â  Â  <button id="theme-toggle" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors" aria-label="åˆ‡æ›ä¸»é¡Œ">
Â  Â  Â  Â  Â  <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
Â  Â  Â  Â  Â  <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
Â  Â  Â  Â  </button>
Â  Â  Â  </div>
Â  Â  Â  <nav id="app-nav" class="border-b border-slate-200 dark:border-slate-700 flex justify-around">
Â  Â  Â  Â  <button class="nav-item flex flex-col items-center justify-center w-full text-slate-500 dark:text-slate-400 py-2" data-page="log-page" aria-label="å‰å¾€æ—¥èªŒ">
Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
Â  Â  Â  Â  Â  <span class="nav-text text-xs mt-1">æ—¥èªŒ</span>
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <button class="nav-item flex flex-col items-center justify-center w-full text-slate-500 dark:text-slate-400 py-2" data-page="stats-page" aria-label="å‰å¾€çµ±è¨ˆ">
Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="m19 9-5 5-4-4-3 3"></path></svg>
Â  Â  Â  Â  Â  <span class="nav-text text-xs mt-1">çµ±è¨ˆ</span>
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <button class="nav-item flex flex-col items-center justify-center w-full text-slate-500 dark:text-slate-400 py-2" data-page="history-page" aria-label="å‰å¾€æ­·å²">
Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
Â  Â  Â  Â  Â  <span class="nav-text text-xs mt-1">æ­·å²</span>
Â  Â  Â  Â  </button>
Â  Â  Â  </nav>
Â  Â  </header>

Â  Â  <div id="toast-notification" class="px-6 py-3 rounded-full font-semibold text-white shadow-lg"></div>

Â  Â  <main class="p-4">
Â  Â  Â  <!-- ========= æ—¥èªŒé é¢ ========= -->
Â  Â  Â  <div id="log-page" class="page active">
Â  Â  Â  Â  <div class="space-y-6">
Â  Â  Â  Â  Â  <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm">
Â  Â  Â  Â  Â  Â  <label for="log-date" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">ğŸ—“ï¸ ç´€éŒ„æ—¥æœŸ</label>
Â  Â  Â  Â  Â  Â  <input type="date" id="log-date" class="w-full p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-200 rounded-md focus:ring-2 focus:ring-blue-500"/>
Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-4 text-slate-800 dark:text-slate-200">
Â  Â  Â  Â  Â  Â  <h2 class="text-lg font-semibold">ğŸ’© æ’ä¾¿ç´€éŒ„</h2>
Â  Â  Â  Â  Â  Â  <div id="bowel-status-options" class="option-button-group flex gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="option-button w-full py-2" data-value="yes">ä»Šå¤©æœ‰æ’ä¾¿</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="option-button w-full py-2" data-value="no">ä»Šå¤©ç„¡æ’ä¾¿</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="bowel-records-section" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="bowel-records-container" class="space-y-5 mt-4"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="add-bowel-record-btn" class="w-full mt-2 text-blue-600 font-semibold py-2 px-4 rounded-lg border-2 border-dashed border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/50 transition flex items-center justify-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" class="mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  æ–°å¢ä¸€ç­†æ’ä¾¿ç´€éŒ„
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  <!-- Swallowing Record Section -->
Â  Â  Â  Â  Â  <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-4 text-slate-800 dark:text-slate-200">
Â  Â  Â  Â  Â  Â  <h2 class="text-lg font-semibold">ğŸ² ååš¥ç´€éŒ„</h2>
Â  Â  Â  Â  Â  Â  <div id="swallowing-status-options" class="option-button-group flex gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="option-button w-full py-2" data-value="yes">ä»Šå¤©æœ‰å—†åˆ°</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="option-button w-full py-2" data-value="no">ä»Šå¤©ç„¡å—†åˆ°</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="swallowing-details-section" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="swallowing-records-container" class="space-y-5 mt-4"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="add-swallowing-record-btn" class="w-full mt-2 text-teal-600 font-semibold py-2 px-4 rounded-lg border-2 border-dashed border-teal-400 hover:bg-teal-50 dark:hover:bg-teal-900/50 transition flex items-center justify-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" class="mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  æ–°å¢ä¸€ç­†å—†åˆ°äº‹ä»¶
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm text-slate-800 dark:text-slate-200">
Â  Â  Â  Â  Â  Â  <h3 class="text-base font-semibold mb-2">ğŸ˜´ æ˜¨æ™šç¡çœ å“è³ª</h3>
Â  Â  Â  Â  Â  Â  <div id="sleep-quality-rating" class="star-rating flex items-center justify-center space-x-2 text-4xl"></div>
Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm text-slate-800 dark:text-slate-200">
Â  Â  Â  Â  Â  Â  <h3 class="text-base font-semibold mb-2">ğŸš½ æ˜¨æ™šèµ·åºŠå¦‚å»æ¬¡æ•¸</h3>
Â  Â  Â  Â  Â  Â  <div id="night-toilet-visits" class="option-button-group flex flex-wrap gap-2 justify-center">
Â  Â  Â  Â  Â  Â  Â  <!-- Buttons 0-5 will be generated by JS -->
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm text-slate-800 dark:text-slate-200">
Â  Â  Â  Â  Â  Â  <h3 class="text-base font-semibold mb-2">ğŸƒâ€â™‚ï¸ RBD ç—‡ç‹€ (æ˜¨æ™š)</h3>
Â  Â  Â  Â  Â  Â  <div id="rbd-symptoms" class="space-y-2"></div>
Â  Â  Â  Â  Â  Â  <textarea id="rbd-other-notes" rows="2" class="w-full mt-2 p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md hidden" placeholder="è«‹æè¿°å…¶ä»–ç—‡ç‹€"></textarea>
Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm text-slate-800 dark:text-slate-200">
Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-2">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-base font-semibold">ğŸ’Š ç”¨è—¥ç´€éŒ„</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="clear-meds-btn" class="text-xs text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">æ¸…é™¤</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <textarea id="medication-log" rows="3" class="w-full p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md" placeholder="è«‹è¨˜éŒ„æ‚¨ä»Šå¤©æœç”¨çš„è—¥ç‰©ã€æ™‚é–“å’ŒåŠ‘é‡ã€‚"></textarea>
Â  Â  Â  Â  Â  Â  <div id="common-meds-container" class="flex flex-wrap gap-2 mt-2"></div>
Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm text-slate-800 dark:text-slate-200">
Â  Â  Â  Â  Â  Â  <h3 class="text-base font-semibold mb-2">ğŸ“ æ¯æ—¥å‚™è¨»</h3>
Â  Â  Â  Â  Â  Â  <textarea id="daily-notes" rows="3" class="w-full p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md" placeholder="è¨˜éŒ„ä»»ä½•å…¶ä»–æƒ³è¨˜ä¸‹çš„äº‹æƒ…..."></textarea>
Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  <button id="save-log-button" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform active:scale-95 flex items-center justify-center text-lg">
Â  Â  Â  Â  Â  Â  <span id="save-log-button-content">
Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="mr-2 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
Â  Â  Â  Â  Â  Â  Â  å„²å­˜æœ¬æ—¥å®Œæ•´æ—¥èªŒ
Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <!-- ========= çµ±è¨ˆé  ========= -->
Â  Â  Â  <div id="stats-page" class="page space-y-6">
Â  Â  Â  Â  <div class="flex justify-between items-center bg-white dark:bg-slate-800 p-3 rounded-xl shadow-sm">
Â  Â  Â  Â  Â  <button id="prev-week-btn" class="px-3 py-2 rounded-md bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-800 dark:text-slate-200 transition-colors">&lt; ä¸Šä¸€é€±</button>
Â  Â  Â  Â  Â  <h2 id="stats-week-title" class="text-lg font-semibold text-slate-800 dark:text-slate-200 text-center">æœ¬é€±çµ±è¨ˆ</h2>
Â  Â  Â  Â  Â  <button id="next-week-btn" class="px-3 py-2 rounded-md bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-800 dark:text-slate-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>ä¸‹ä¸€é€± &gt;</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="stats-content" class="space-y-6">
Â  Â  Â  Â  Â  Â  <!-- Charts and analysis will be rendered here -->
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <!-- ========= æ­·å²é  ========= -->
Â  Â  Â  <div id="history-page" class="page">
Â  Â  Â  Â  <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm text-slate-800 dark:text-slate-200">
Â  Â  Â  Â  Â  <h2 class="text-lg font-semibold mb-4">ğŸ—‚ï¸ è³‡æ–™ç®¡ç†</h2>
Â  Â  Â  Â  Â  <p id="last-backup-info" class="text-xs text-center text-slate-500 dark:text-slate-400 mb-4"></p>
Â  Â  Â  Â  Â  <div class="space-y-2 mb-4">
Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-2 gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="import-csv-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center justify-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" class="mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  åŒ¯å…¥ CSV
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="export-csv-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center justify-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" class="mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  åŒ¯å‡ºç‚º CSV
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â <button id="manage-meds-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center justify-center mt-2">
Â  Â  Â  Â  Â  Â  Â  Â <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" class="mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
Â  Â  Â  Â  Â  Â  Â  Â ç®¡ç†å¸¸ç”¨è—¥ç‰©
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <button id="delete-all-data-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center justify-center mt-2">
Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" class="mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
Â  Â  Â  Â  Â  Â  Â  Â  åˆªé™¤å…¨éƒ¨æœ¬æ©Ÿè³‡æ–™
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <input type="file" id="import-file-input" class="hidden" accept=".csv, text/csv"/>
Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-4 mt-6">
Â  Â  Â  Â  Â  Â  <h2 class="text-lg font-semibold">ğŸ“œ æ‰€æœ‰æ—¥èªŒç´€éŒ„</h2>
Â  Â  Â  Â  Â  Â  <select id="week-filter" class="text-sm p-1 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md"></select>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div id="history-list" class="space-y-3"></div>
Â  Â  Â  Â  </section>
Â  Â  Â  </div>
Â  Â  </main>

Â  Â  <!-- Modals -->
Â  Â  <div id="confirmation-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
Â  Â  Â  <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 max-w-sm w-full">
Â  Â  Â  Â  <h3 id="modal-title" class="text-lg font-bold text-slate-800 dark:text-slate-200 mb-2"></h3>
Â  Â  Â  Â  <p id="modal-message" class="text-sm text-slate-600 dark:text-slate-400 mb-6"></p>
Â  Â  Â  Â  <div class="flex justify-end space-x-3">
Â  Â  Â  Â  Â  <button id="modal-cancel-btn" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 text-slate-800 dark:text-slate-200 rounded-md">å–æ¶ˆ</button>
Â  Â  Â  Â  Â  <button id="modal-confirm-btn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md">ç¢ºå®š</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="color-info-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
Â  Â  Â  <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 max-w-sm w-full">
Â  Â  Â  Â  <div class="flex justify-between items-center mb-2">
Â  Â  Â  Â  Â  Â  <h3 id="color-modal-title" class="text-lg font-bold text-slate-800 dark:text-slate-200"></h3>
Â  Â  Â  Â  Â  Â  <button id="color-modal-close-btn" class="text-slate-400 hover:text-slate-600">&times;</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <p id="color-modal-message" class="text-sm text-slate-600 dark:text-slate-400 mb-6"></p>
Â  Â  Â  Â  <div class="flex justify-end">
Â  Â  Â  Â  Â  <button id="color-modal-ok-btn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md">æˆ‘çŸ¥é“äº†</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="meds-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
Â  Â  Â  <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 max-w-sm w-full">
Â  Â  Â  Â  <div class="flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-bold text-slate-800 dark:text-slate-200">ç®¡ç†å¸¸ç”¨è—¥ç‰©</h3>
Â  Â  Â  Â  Â  Â  <button id="meds-modal-close-btn" class="text-slate-400 hover:text-slate-600">&times;</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="flex gap-2 mb-4">
Â  Â  Â  Â  Â  Â  <input type="text" id="new-med-input" class="flex-grow p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md" placeholder="è¼¸å…¥è—¥ç‰©åç¨±">
Â  Â  Â  Â  Â  Â  <button id="add-med-btn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md">æ–°å¢</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="meds-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
Â  Â  Â  </div>
Â  Â  </div>

Â  </div>

Â  <script>
Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  dayjs.extend(dayjs_plugin_relativeTime);
Â  Â  dayjs.extend(dayjs_plugin_customParseFormat);
Â  Â  dayjs.extend(dayjs_plugin_weekOfYear);
Â  Â  dayjs.locale('zh-tw');

Â  Â  function cleanInvisible(str) {
Â  Â  Â  if (str === null || str === undefined) return '';
Â  Â  Â  return String(str).replace(/\uFEFF/g, '').replace(/\r/g, '').replace(/\u200B/g, '').trim();
Â  Â  }
Â  Â Â 
Â  Â  function triggerHapticFeedback(ms = 50) {
Â  Â  Â  Â  if (navigator.vibrate) {
Â  Â  Â  Â  Â  Â  navigator.vibrate(ms);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  const bristolData = [
Â  Â  Â  { type: 1, d: "ä¸€é¡†é¡†åˆ†é–‹çš„å …æœå‹", svg: `<g fill="#754C24"><circle cx="8" cy="11" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="16" cy="11" r="2"/><circle cx="10" cy="7" r="2"/><circle cx="14" cy="7" r="2"/><path d="M9 11.5 a1 .5 0 0 0 2 0 a1 .5 0 0 0-2 0 M15 11.5 a1 .5 0 0 0 2 0 a1 .5 0 0 0-2 0 M11 7.5 a1 .5 0 0 0 2 0 a1 .5 0 0 0-2 0"/></g>`},
Â  Â  Â  { type: 2, d: "è¡¨é¢å‡¹å‡¸çš„é¦™è…¸å‹", svg: `<g fill="#8C5A3C"><path d="M6 13 C 6 9, 18 9, 18 13 S 17 15, 12 15 S 6 17, 6 13 Z"/><circle cx="8" cy="11" r="1.5"/><circle cx="11" cy="10.5" r="1.5"/><circle cx="14" cy="11" r="1.5"/><circle cx="16" cy="12.5" r="1.5"/><path d="M11 13.5 a1 .5 0 0 0 2 0 a1 .5 0 0 0-2 0"/></g>`},
Â  Â  Â  { type: 3, d: "è¡¨é¢æœ‰è£‚ç—•çš„é¦™è…¸å‹", svg: `<g fill="#A66D4A" stroke="#8C5A3C" stroke-width="0.5"><path d="M5 12 C 5 9, 19 9, 19 12 S 18 14, 12 14 S 5 15, 5 12 Z"/><path d="M8 10 l 1 3 M12 10 l 1 3 M16 10 l 1 3"/><path d="M11 12.5 a1 .5 0 0 0 2 0 a1 .5 0 0 0-2 0"/></g>`},
Â  Â  Â  { type: 4, d: "å…‰æ»‘ä¸”æŸ”è»Ÿçš„é¦™è…¸/è›‡å‹", svg: `<g fill="#C07E56"><path d="M5 12 C 5 9, 19 9, 19 12 S 18 14, 12 14 S 5 15, 5 12 Z"/><path d="M11 12.5 a1 .5 0 0 1 2 0 a1 .5 0 0 1-2 0"/></g>`},
Â  Â  Â  { type: 5, d: "æ–·é¢å…‰æ»‘çš„æŸ”è»Ÿå¡Šç‹€", svg: `<g fill="#D98F61"><circle cx="8" cy="12" r="3"/><circle cx="13" cy="13" r="3"/><circle cx="17" cy="11" r="3"/><path d="M7.5 12.5 a1 .5 0 0 1 2 0 a1 .5 0 0 1-2 0 M12.5 13.5 a1 .5 0 0 1 2 0 a1 .5 0 0 1-2 0"/></g>`},
Â  Â  Â  { type: 6, d: "é¬†è»Ÿã€é‚Šç·£ç ´ç¢çš„ç³Šç‹€", svg: `<g fill="#E6A06D"><path d="M6 12 C 6 8, 10 7, 12 9 C 14 11, 18 10, 18 12 S 14 15, 12 14 C 10 13, 6 16, 6 12 Z"/><path d="M11 12.5 a1 .5 0 0 0 2 0 a1 .5 0 0 0-2 0"/></g>`},
Â  Â  Â  { type: 7, d: "æ²’æœ‰å›ºé«”ã€å®Œå…¨å‘ˆæ¶²é«”ç‹€", svg: `<g fill="#F2B178"><path d="M5 13 C 5 10, 19 10, 19 13 S 15 16, 12 15 S 5 16, 5 13 Z"/><path d="M11 13.5 a1 .5 0 0 0 2 0 a1 .5 0 0 0-2 0"/></g>`}
Â  Â  ];
Â  Â  const bowelColorData = [
Â  Â  Â  { name: 'å•¡è‰²', colorHex: '#7B4F34', infoTitle: 'âœ… å¥åº·ã€æ­£å¸¸', infoText: 'æ­å–œï¼é€™æ˜¯æœ€å¥åº·çš„é¡è‰²ï¼Œè¡¨ç¤ºè†½æ±åˆ†æ³Œæ­£å¸¸ï¼Œæ¶ˆåŒ–ç³»çµ±é‹ä½œè‰¯å¥½ã€‚' },Â 
Â  Â  Â  { name: 'é»ƒè‰²', colorHex: '#DAA520', infoTitle: 'âœ… å¥åº·ã€æ­£å¸¸', infoText: 'é€™ä¹Ÿæ˜¯å¥åº·çš„é¡è‰²ï¼Œå¯èƒ½èˆ‡é£²é£Ÿä¸­è„‚è‚ªå«é‡è¼ƒé«˜æœ‰é—œï¼Œé€šå¸¸ç„¡éœ€æ“”å¿ƒã€‚' },
Â  Â  Â  { name: 'ç¶ è‰²', colorHex: '#5A6335', infoTitle: 'ğŸ’¡ é€šå¸¸æ­£å¸¸', infoText: 'åˆ¥æ“”å¿ƒï¼Œé€šå¸¸æ˜¯åƒäº†è¼ƒå¤šæ·±ç¶ è‰²è”¬èœï¼Œæˆ–æ˜¯é£Ÿç‰©æ¶ˆåŒ–é€Ÿåº¦è¼ƒå¿«ï¼Œè†½æ±ä¾†ä¸åŠåˆ†è§£æ‰€è‡´ã€‚' },Â 
Â  Â  Â  { name: 'ç´…è‰²', colorHex: '#9E2B25', infoTitle: 'âš ï¸ è«‹ç•™æ„', infoText: 'å¯èƒ½æ˜¯é£Ÿç‰©ï¼ˆå¦‚ç«é¾æœã€ç”œèœæ ¹ï¼‰é€ æˆçš„ï¼Œä½†ä¹Ÿå¯èƒ½æ˜¯ä¸‹æ¶ˆåŒ–é“å‡ºè¡€çš„è­¦è¨Šï¼Œéœ€æŒçºŒè§€å¯Ÿã€‚' },
Â  Â  Â  { name: 'é»‘è‰²', colorHex: '#1E1E1E', infoTitle: 'âš ï¸ è¦æ³¨æ„', infoText: 'å¯èƒ½æ˜¯åƒäº†éµåŠ‘ã€å«å¢¨é­šæ±çš„é£Ÿç‰©ï¼Œä½†ä¹Ÿå¯èƒ½æ˜¯ä¸Šæ¶ˆåŒ–é“å‡ºè¡€çš„å¾µå…†ï¼Œå»ºè­°æé«˜è­¦è¦ºã€‚' },Â 
Â  Â  Â  { name: 'ç°ç™½è‰²', colorHex: '#A9A9A9', infoTitle: 'ğŸš¨ éœ€è¦è­¦è¦º', infoText: 'é€™å¯èƒ½ä»£è¡¨è†½æ±åˆ†æ³Œä¸è¶³æˆ–è†½ç®¡é˜»å¡ï¼Œæ˜¯è¼ƒå±éšªçš„ä¿¡è™Ÿï¼Œå»ºè­°è«®è©¢é†«å¸«ã€‚' }
Â  Â  ];
Â  Â  const bowelVolumes = ['å°‘é‡', 'ä¸­ç­‰', 'å¤§é‡'];
Â  Â  const bowelDurations = ['10åˆ†é˜ä»¥ä¸Š', '3-10åˆ†é˜', '1-3åˆ†é˜'];
Â  Â  const bowelSymptoms = ['ç„¡', 'è‚šå­ç—›', 'èƒƒè„¹æ°£', 'å±çœ¼åœ¨ç‡’', 'è…¸çµç—›', 'è‚›é–€ç—›', 'è£¡æ€¥å¾Œé‡', 'ä¾¿æ„ç›ç„¶'];
Â  Â  const bowelAdditionalStatus = ['ç„¡', 'æ€µç›®è¡€è·¡', 'ä¾¿ä¸­æœ‰é»æ¶²', 'å¤§ä¾¿æƒ¡è‡­çƒ˜çƒ˜', 'å¤§ä¾¿é»ç¨ ', 'å¤§ä¾¿ç´°å¦‚ç­†', 'æ¶ˆåŒ–ä¸è‰¯'];
Â  Â  const rbdSymptomsList = [
Â  Â  Â  { id: 'none', label: 'ç„¡ç—‡ç‹€' }, { id: 'shouting', label: 'å¤§è²å«å–Š' },
Â  Â  Â  { id: 'movement', label: 'è‚¢é«”å‹•ä½œ' }, { id: 'vivid-dreams', label: 'ç”Ÿå‹•å¤¢å¢ƒ' },
Â  Â  Â  { id: 'sleep-talking', label: 'æ¿€å‹•å¤¢è©±' }, { id: 'self-injury', label: 'ä½¿è‡ªå·±å—å‚·' },
Â  Â  Â  { id: 'partner-injury', label: 'ä½¿ä¼´ä¾¶å—å‚·' }, { id: 'other', label: 'å…¶ä»–' }
Â  Â  ];
Â  Â  // Swallowing Record Data
Â  Â  const swallowingContexts = ['å–®ç¨', 'èˆ‡äººèŠå¤©', 'èµ°å‹•ä¸­', 'çœ‹è¢å¹•'];
Â  Â  const swallowingPostures = ['åç›´â‰¥90Â°', 'åŠèºº', 'èµ°å‹•'];
Â  Â  const swallowingDrinkTypes = ['æ¸…æ°´', 'èŒ¶', 'æ¹¯ï¼ˆç¨€ï¼‰', 'æ¿ƒç¨ é£²ï¼ˆå¢ç¨ å¾Œï¼‰'];
Â  Â  const swallowingSolidTypes = ['ä¹¾ç¡¬ï¼ˆé¤…ä¹¾/èŠ±ç”Ÿï¼‰', 'çº–ç¶­å¤šï¼ˆèœè‘‰ï¼‰', 'é¬†æ•£ï¼ˆç±³é£¯ï¼‰', 'é»ç¨ ï¼ˆå¹´ç³•ã€éº»ç³¬ï¼‰', 'è»Ÿè³ªï¼ˆè’¸è›‹ï¼‰', 'çµç¢', 'æ³¥ç‹€'];
Â  Â  const swallowingMedTypes = ['æ•´é¡†', 'ç¢¾ç¢', 'å«æœ', 'æ­æ°´é‡'];
Â  Â  const swallowingPortions = ['å°å£', 'ä¸­', 'å¤§å£'];
Â  Â  const swallowingSpeeds = ['æ…¢', 'ä¸­', 'å¿«'];
Â  Â  const swallowingDistractions = ['æ˜¯', 'å¦'];
Â  Â  const swallowingSymptoms = ['çªç„¶å’³', 'å—†å’³é€£çºŒ>30ç§’', 'æµæ·š', 'å™å¿ƒ/å˜”å', 'èƒ¸å£æ‚¶', 'è²éŸ³æ²™å•', 'ååš¥ç–¼ç—›'];
Â  Â  const swallowingSeverities = ['è¼•', 'ä¸­', 'é‡'];
Â  Â  const swallowingActions = ['æš«åœé€²é£Ÿ', 'å°‘é‡åˆ†æ¬¡å–æ°´', 'èª¿å§¿ï¼ˆåç›´/ä¸‹å·´å¾®æ”¶ï¼‰', 'èƒŒéƒ¨æ‹æ“Š', 'è…¹éƒ¨æ“ å£“ï¼ˆåƒ…å®Œå…¨é˜»å¡æ™‚ï¼‰', 'åœæ­¢ç•¶æ¬¡ç”¨é¤'];
Â  Â  const swallowingResults = ['è‡ªè¡Œæ¢å¾©', 'ä»ä¸é©â†’å°±é†«', 'ç•¶å¤©å¾ŒçºŒç—‡ç‹€ï¼ˆç™¼ç‡’ã€å–˜ã€æŒçºŒå’³å—½ï¼‰'];

Â  Â  let appState = {
Â  Â  Â  dailyLogs: {},
Â  Â  Â  commonMeds: [],
Â  Â  Â  lastBackupDate: null,
Â  Â  Â  currentDate: dayjs().format('YYYY-MM-DD'),
Â  Â  Â  currentPage: 'log-page',
Â  Â  Â  charts: { bowel: null, rbd: null, bowelTime: null, sleep: null, nightToilet: null, swallowing: null },
Â  Â  Â  statsWeekOffset: 0,
Â  Â  };

Â  Â  const DOM = {
Â  Â  Â  html: document.documentElement,
Â  Â  Â  headerTitle: document.getElementById('header-title'),
Â  Â  Â  pages: document.querySelectorAll('.page'),
Â  Â  Â  navItems: document.querySelectorAll('.nav-item'),
Â  Â  Â  toast: document.getElementById('toast-notification'),
Â  Â  Â  logDate: document.getElementById('log-date'),
Â  Â  Â  bowelStatusOptions: document.getElementById('bowel-status-options'),
Â  Â  Â  bowelRecordsSection: document.getElementById('bowel-records-section'),
Â  Â  Â  bowelRecordsContainer: document.getElementById('bowel-records-container'),
Â  Â  Â  addBowelRecordBtn: document.getElementById('add-bowel-record-btn'),
Â  Â  Â  // Swallowing DOM elements
Â  Â  Â  swallowingStatusOptions: document.getElementById('swallowing-status-options'),
Â  Â  Â  swallowingDetailsSection: document.getElementById('swallowing-details-section'),
Â  Â  Â  swallowingRecordsContainer: document.getElementById('swallowing-records-container'),
Â  Â  Â  addSwallowingRecordBtn: document.getElementById('add-swallowing-record-btn'),
Â  Â  Â  sleepQualityRating: document.getElementById('sleep-quality-rating'),
Â  Â  Â  nightToiletVisits: document.getElementById('night-toilet-visits'),
Â  Â  Â  rbdSymptoms: document.getElementById('rbd-symptoms'),
Â  Â  Â  rbdOtherNotes: document.getElementById('rbd-other-notes'),
Â  Â  Â  medicationLog: document.getElementById('medication-log'),
Â  Â  Â  clearMedsBtn: document.getElementById('clear-meds-btn'),
Â  Â  Â  commonMedsContainer: document.getElementById('common-meds-container'),
Â  Â  Â  dailyNotes: document.getElementById('daily-notes'),
Â  Â  Â  saveLogButton: document.getElementById('save-log-button'),
Â  Â  Â  saveLogButtonContent: document.getElementById('save-log-button-content'),
Â  Â  Â  statsPage: document.getElementById('stats-page'),
Â  Â  Â  statsContent: document.getElementById('stats-content'),
Â  Â  Â  historyList: document.getElementById('history-list'),
Â  Â  Â  weekFilter: document.getElementById('week-filter'),
Â  Â  Â  lastBackupInfo: document.getElementById('last-backup-info'),
Â  Â  Â  statsWeekTitle: document.getElementById('stats-week-title'),
Â  Â  Â  prevWeekBtn: document.getElementById('prev-week-btn'),
Â  Â  Â  nextWeekBtn: document.getElementById('next-week-btn'),
Â  Â  Â  exportCsvBtn: document.getElementById('export-csv-btn'),
Â  Â  Â  importCsvBtn: document.getElementById('import-csv-btn'),
Â  Â  Â  importFileInput: document.getElementById('import-file-input'),
Â  Â  Â  deleteAllDataBtn: document.getElementById('delete-all-data-btn'),
Â  Â  Â  confirmationModal: document.getElementById('confirmation-modal'),
Â  Â  Â  modalTitle: document.getElementById('modal-title'),
Â  Â  Â  modalMessage: document.getElementById('modal-message'),
Â  Â  Â  modalCancelBtn: document.getElementById('modal-cancel-btn'),
Â  Â  Â  modalConfirmBtn: document.getElementById('modal-confirm-btn'),
Â  Â  Â  colorInfoModal: document.getElementById('color-info-modal'),
Â  Â  Â  colorModalTitle: document.getElementById('color-modal-title'),
Â  Â  Â  colorModalMessage: document.getElementById('color-modal-message'),
Â  Â  Â  colorModalCloseBtn: document.getElementById('color-modal-close-btn'),
Â  Â  Â  colorModalOkBtn: document.getElementById('color-modal-ok-btn'),
Â  Â  Â  medsModal: document.getElementById('meds-modal'),
Â  Â  Â  medsModalCloseBtn: document.getElementById('meds-modal-close-btn'),
Â  Â  Â  newMedInput: document.getElementById('new-med-input'),
Â  Â  Â  addMedBtn: document.getElementById('add-med-btn'),
Â  Â  Â  medsList: document.getElementById('meds-list'),
Â  Â  Â  manageMedsBtn: document.getElementById('manage-meds-btn'),
Â  Â  Â  themeToggle: document.getElementById('theme-toggle'),
Â  Â  Â  themeIconSun: document.getElementById('theme-icon-sun'),
Â  Â  Â  themeIconMoon: document.getElementById('theme-icon-moon'),
Â  Â  };
Â  Â Â 
Â  Â  // --- Initialization ---
Â  Â  function init() {
Â  Â  Â  setupPWA();
Â  Â  Â  setupTheme();
Â  Â  Â  loadData();
Â  Â  Â  renderStaticComponents();
Â  Â  Â  setupEventListeners();
Â  Â  Â  setupGestureListeners();Â 
Â  Â  Â  DOM.logDate.value = dayjs(appState.currentDate).format('YYYY-MM-DD');
Â  Â  Â  loadLogForDate(appState.currentDate);
Â  Â  Â  navigateTo('log-page');
Â  Â  }

Â  Â  function setupPWA() {
Â  Â  Â  Â  const manifest = {
Â  Â  Â  Â  Â  Â  "name": "å¥åº·æ—¥èªŒ", "short_name": "å¥åº·æ—¥èªŒ", "start_url": ".",
Â  Â  Â  Â  Â  Â  "display": "standalone", "background_color": "#f8fafc", "theme_color": "#3B82F6",
Â  Â  Â  Â  Â  Â  "description": "æ‚¨çš„å€‹äººåŒ–å¥åº·èˆ‡æ’ä¾¿æ—¥èªŒã€‚",
Â  Â  Â  Â  Â  Â  "icons": [{"src": "https://placehold.co/192x192/3B82F6/FFFFFF?text=æ—¥èªŒ", "sizes": "192x192", "type": "image/png"}, {"src": "https://placehold.co/512x512/3B82F6/FFFFFF?text=æ—¥èªŒ", "sizes": "512x512", "type": "image/png"}]
Â  Â  Â  Â  };
Â  Â  Â  Â  const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
Â  Â  Â  Â  const manifestURL = URL.createObjectURL(manifestBlob);
Â  Â  Â  Â  if (!document.querySelector('link[rel="manifest"]')) {
Â  Â  Â  Â  Â  Â  const manifestLink = document.createElement('link');
Â  Â  Â  Â  Â  Â  manifestLink.rel = 'manifest';
Â  Â  Â  Â  Â  Â  manifestLink.href = manifestURL;
Â  Â  Â  Â  Â  Â  document.head.appendChild(manifestLink);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // --- Data Persistence (LocalStorage) ---
Â  Â  function loadData() {
Â  Â  Â  try {
Â  Â  Â  Â  const dataStr = localStorage.getItem('healthLogApp');
Â  Â  Â  Â  if (dataStr) {
Â  Â  Â  Â  Â  Â  const data = JSON.parse(dataStr);
Â  Â  Â  Â  Â  Â  appState.dailyLogs = data.logs || {};
Â  Â  Â  Â  Â  Â  appState.lastBackupDate = data.lastUpdated;
Â  Â  Â  Â  Â  Â  appState.commonMeds = data.commonMeds || [];
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {Â 
Â  Â  Â  Â  Â  console.error("ç„¡æ³•è®€å– localStorage è³‡æ–™:", error);Â 
Â  Â  Â  Â  Â  appState.dailyLogs = {};Â 
Â  Â  Â  Â  Â  appState.commonMeds = [];Â 
Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  function saveData() {
Â  Â  Â  Â  const dataToSave = {
Â  Â  Â  Â  Â  Â  logs: appState.dailyLogs,
Â  Â  Â  Â  Â  Â  commonMeds: appState.commonMeds,
Â  Â  Â  Â  Â  Â  lastUpdated: new Date().toISOString()
Â  Â  Â  Â  };
Â  Â  Â  Â  localStorage.setItem('healthLogApp', JSON.stringify(dataToSave));
Â  Â  Â  Â  appState.lastBackupDate = dataToSave.lastUpdated;
Â  Â  Â  Â  updateLastBackupInfo();
Â  Â  }

Â  Â  function getEmptyLog() {
Â  Â  Â  return { hadBowelMovement: false, bowel: [], hadSwallowingEvent: false, swallowing: [], sleep: 0, nightToiletVisits: -1, rbd: { symptoms: [], other: '' }, meds: '', dailyNotes: '' };
Â  Â  }
Â  Â  function getEmptyBowelRecord() {
Â  Â  Â  return { id: Date.now(), bowelTimeOfDay: '', types: [], color: '', volume: '', duration: '', notes: '', symptoms: [], additionalStatus: [] };
Â  Â  }
Â  Â  function getEmptySwallowingRecord() {
Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  id: Date.now(),
Â  Â  Â  Â  Â  Â  time: '', context: '', posture: '', drinkType: '', solidType: '',
Â  Â  Â  Â  Â  Â  medType: '', portion: '', speed: '', distraction: '', symptoms: [],
Â  Â  Â  Â  Â  Â  severity: '', action: '', result: '', notes: ''
Â  Â  Â  Â  };
Â  Â  }

Â  Â  function loadLogForDate(date) {
Â  Â  Â  const log = appState.dailyLogs[date] || getEmptyLog();
Â  Â  Â Â 
Â  Â  Â  DOM.bowelStatusOptions.querySelectorAll('.option-button').forEach(btn => {
Â  Â  Â  Â  Â  btn.classList.toggle('selected', (log.hadBowelMovement && btn.dataset.value === 'yes') || (!log.hadBowelMovement && btn.dataset.value === 'no'));
Â  Â  Â  });
Â  Â  Â  toggleBowelSection(log.hadBowelMovement);
Â  Â  Â  renderBowelForms(log.bowel || []);

Â  Â  Â  DOM.swallowingStatusOptions.querySelectorAll('.option-button').forEach(btn => {
Â  Â  Â  Â  Â  btn.classList.toggle('selected', (log.hadSwallowingEvent && btn.dataset.value === 'yes') || (!log.hadSwallowingEvent && btn.dataset.value === 'no'));
Â  Â  Â  });
Â  Â  Â  toggleSwallowingSection(log.hadSwallowingEvent);
Â  Â  Â  renderSwallowingForms(log.swallowing || []);
Â  Â  Â Â 
Â  Â  Â  updateStars(log.sleep);
Â  Â  Â  DOM.nightToiletVisits.querySelectorAll('.option-button').forEach(btn => {
Â  Â  Â  Â  btn.classList.toggle('selected', parseInt(btn.dataset.value, 10) === log.nightToiletVisits);
Â  Â  Â  });
Â  Â  Â  const rbdCheckboxes = DOM.rbdSymptoms.querySelectorAll('input[type="checkbox"]');
Â  Â  Â  rbdCheckboxes.forEach(input => {
Â  Â  Â  Â  input.checked = log.rbd?.symptoms?.includes(input.id) || false;
Â  Â  Â  Â  input.disabled = false;
Â  Â  Â  });
Â  Â  Â  updateRbdCheckboxStates();
Â  Â  Â  DOM.rbdOtherNotes.value = log.rbd?.other || '';
Â  Â  Â  DOM.rbdOtherNotes.classList.toggle('hidden', !log.rbd?.symptoms?.includes('other'));
Â  Â  Â  DOM.medicationLog.value = log.meds;
Â  Â  Â  DOM.dailyNotes.value = log.dailyNotes;
Â  Â  Â  renderCommonMeds();
Â  Â  }

Â  Â  async function saveLogForDate(date) {
Â  Â  Â  Â  if (!validateLogForm()) return;
Â  Â  Â  Â  triggerHapticFeedback();
Â  Â  Â  Â  const originalContent = DOM.saveLogButtonContent.innerHTML;
Â  Â  Â  Â  DOM.saveLogButton.disabled = true;
Â  Â  Â  Â  DOM.saveLogButtonContent.innerHTML = `<svg class="spinner w-6 h-6 mr-2 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>å„²å­˜ä¸­...`;
Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, 500));
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- Gather Bowel Data ---
Â  Â  Â  Â  const hadBowelMovement = DOM.bowelStatusOptions.querySelector('.selected')?.dataset.value === 'yes';
Â  Â  Â  Â  let bowelRecords = [];
Â  Â  Â  Â  if (hadBowelMovement) {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.bowel-record-form').forEach(form => {
Â  Â  Â  Â  Â  Â  Â  Â  const getSelected = (container) => Array.from(container.querySelectorAll('.selected')).map(btn => btn.dataset.value);
Â  Â  Â  Â  Â  Â  Â  Â  bowelRecords.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: form.dataset.id,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bowelTimeOfDay: form.querySelector('.bowel-time-of-day').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  types: Array.from(form.querySelectorAll('.bristol-item.bristol-selected')).map(item => parseInt(item.dataset.type)),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: form.querySelector('.color-item.bristol-selected')?.dataset.value || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  volume: form.querySelector('.volume-options .selected')?.dataset.value || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  duration: form.querySelector('.duration-options .selected')?.dataset.value || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  notes: form.querySelector('.bowel-notes').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  symptoms: getSelected(form.querySelector('.symptoms-options')),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  additionalStatus: getSelected(form.querySelector('.status-options'))
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Gather Swallowing Data ---
Â  Â  Â  Â  const hadSwallowingEvent = DOM.swallowingStatusOptions.querySelector('.selected')?.dataset.value === 'yes';
Â  Â  Â  Â  let swallowingRecords = [];
Â  Â  Â  Â  if (hadSwallowingEvent) {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.swallowing-record-form').forEach(form => {
Â  Â  Â  Â  Â  Â  Â  Â  const getSelectedValues = (selector) => Array.from(form.querySelectorAll(`${selector}:checked`)).map(el => el.value);
Â  Â  Â  Â  Â  Â  Â  Â  swallowingRecords.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: form.dataset.id,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  time: form.querySelector('.swallowing-time').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  context: getSelectedValues('input[name^="swallowing-context-"]:checked')[0] || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  posture: getSelectedValues('input[name^="swallowing-posture-"]:checked')[0] || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  drinkType: getSelectedValues('input[name^="swallowing-drinkType-"]:checked')[0] || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  solidType: getSelectedValues('input[name^="swallowing-solidType-"]:checked')[0] || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  medType: getSelectedValues('input[name^="swallowing-medType-"]:checked')[0] || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  portion: getSelectedValues('input[name^="swallowing-portion-"]:checked')[0] || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  speed: getSelectedValues('input[name^="swallowing-speed-"]:checked')[0] || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  distraction: getSelectedValues('input[name^="swallowing-distraction-"]:checked')[0] || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  symptoms: getSelectedValues('input[name^="swallowing-symptoms-"]:checked'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  severity: getSelectedValues('input[name^="swallowing-severity-"]:checked')[0] || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  action: getSelectedValues('input[name^="swallowing-action-"]:checked')[0] || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result: getSelectedValues('input[name^="swallowing-result-"]:checked')[0] || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  notes: form.querySelector('.swallowing-notes').value
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  appState.dailyLogs[date] = {
Â  Â  Â  Â  Â  Â  hadBowelMovement,
Â  Â  Â  Â  Â  Â  bowel: bowelRecords,
Â  Â  Â  Â  Â  Â  hadSwallowingEvent,
Â  Â  Â  Â  Â  Â  swallowing: swallowingRecords,
Â  Â  Â  Â  Â  Â  sleep: DOM.sleepQualityRating.querySelectorAll('.star.selected').length,
Â  Â  Â  Â  Â  Â  nightToiletVisits: parseInt(document.querySelector('#night-toilet-visits .selected')?.dataset.value, 10) ?? -1,
Â  Â  Â  Â  Â  Â  rbd: {
Â  Â  Â  Â  Â  Â  Â  Â  symptoms: Array.from(document.querySelectorAll('#rbd-symptoms input:checked')).map(el => el.id),
Â  Â  Â  Â  Â  Â  Â  Â  other: DOM.rbdOtherNotes.value
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  meds: DOM.medicationLog.value,
Â  Â  Â  Â  Â  Â  dailyNotes: DOM.dailyNotes.value
Â  Â  Â  Â  };

Â  Â  Â  Â  saveData();
Â  Â  Â  Â  DOM.saveLogButtonContent.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="mr-2 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>å„²å­˜æˆåŠŸï¼`;
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  DOM.saveLogButton.disabled = false;
Â  Â  Â  Â  Â  Â  DOM.saveLogButtonContent.innerHTML = originalContent;
Â  Â  Â  Â  Â  Â  showToast('æœ¬æ—¥æ—¥èªŒå·²å„²å­˜ï¼', 'success');
Â  Â  Â  Â  }, 1200);
Â  Â  }

Â  Â  function renderStaticComponents() {
Â  Â  Â  DOM.sleepQualityRating.innerHTML = '';
Â  Â  Â  for (let i = 1; i <= 5; i++) DOM.sleepQualityRating.innerHTML += `<span class="star" data-value="${i}">&#9733;</span>`;
Â  Â  Â Â 
Â  Â  Â  DOM.nightToiletVisits.innerHTML = '';
Â  Â  Â  for (let i = 0; i <= 5; i++) {
Â  Â  Â  Â  DOM.nightToiletVisits.innerHTML += `<button type="button" class="option-button text-sm py-2 px-4 rounded-lg border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700" data-value="${i}">${i} æ¬¡</button>`;
Â  Â  Â  }

Â  Â  Â  DOM.rbdSymptoms.innerHTML = rbdSymptomsList.map(s => `<label class="flex items-center has-[:disabled]:text-slate-400"><input type="checkbox" id="${s.id}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 custom-checkbox mr-2"> ${s.label}</label>`).join('');
Â  Â  }
Â  Â  function renderBowelForms(records = []) {
Â  Â  Â  DOM.bowelRecordsContainer.innerHTML = '';
Â  Â  Â  const hadBowelMovement = DOM.bowelStatusOptions.querySelector('.selected')?.dataset.value === 'yes';
Â  Â  Â  if (records.length === 0 && hadBowelMovement) {
Â  Â  Â  Â  Â  records.push(getEmptyBowelRecord());
Â  Â  Â  }
Â  Â  Â  records.forEach((record, index) => DOM.bowelRecordsContainer.insertAdjacentHTML('beforeend', createBowelFormHTML(record, index + 1)));
Â  Â  }
Â  Â  function renderSwallowingForms(records = []) {
Â  Â  Â  Â  DOM.swallowingRecordsContainer.innerHTML = '';
Â  Â  Â  Â  const hadSwallowingEvent = DOM.swallowingStatusOptions.querySelector('.selected')?.dataset.value === 'yes';
Â  Â  Â  Â  if (records.length === 0 && hadSwallowingEvent) {
Â  Â  Â  Â  Â  Â  records.push(getEmptySwallowingRecord());
Â  Â  Â  Â  }
Â  Â  Â  Â  records.forEach((record, index) => DOM.swallowingRecordsContainer.insertAdjacentHTML('beforeend', createSwallowingFormHTML(record, index + 1)));
Â  Â  }

Â  Â  function createBowelFormHTML(record, index) {
Â  Â  Â  return `<div class="bowel-record-form border-t-2 border-slate-200 dark:border-slate-700 pt-4" data-id="${record.id}">
Â  Â  Â  Â  <div class="flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  <h4 class="font-semibold text-md text-slate-700 dark:text-slate-300">ç¬¬ ${index} ç­†æ’ä¾¿ç´€éŒ„</h4>
Â  Â  Â  Â  Â  Â  ${index > 1 ? `<button class="remove-bowel-record-btn text-sm font-medium text-red-500 hover:text-red-700">åˆªé™¤æ­¤ç­†</button>` : ''}
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  <div class="form-section !mt-0 !pt-0 !border-t-0">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-section-label text-slate-600 dark:text-slate-400">(1) â° æ’ä¾¿æ™‚é–“é»</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" class="bowel-time-of-day w-full p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-200 rounded-md mt-2" value="${record.bowelTimeOfDay || ''}">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="form-section">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-section-label text-slate-600 dark:text-slate-400">(2) ğŸ’© å¸ƒé‡Œæ–¯æ‰˜å¤§ä¾¿åˆ†é¡æ³•</label>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-3 gap-2 mt-2">${bristolData.map(item => `<div class="bristol-item p-2 rounded-lg border-2 border-slate-200 dark:border-slate-600 cursor-pointer text-center flex flex-col justify-start items-center ${record.types.includes(item.type) ? 'bristol-selected' : ''}" data-type="${item.type}" tabindex="0"><svg viewBox="0 0 24 18" class="w-12 h-10 mx-auto mb-1">${item.svg}</svg><p class="font-semibold text-xs text-slate-800 dark:text-slate-200">é¡å‹ ${item.type}</p><p class="text-[10px] text-slate-500 dark:text-slate-400 leading-tight mt-1">${item.d}</p></div>`).join('')}</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  ${createOptionGroup('(3) ğŸ¨ é¡è‰²', 'color-options', bowelColorData.map(c => c.name), record.color, false, true)}
Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-2 gap-3">
Â  Â  Â  Â  Â  Â  Â  Â  ${createOptionGroup('(4) ğŸ“ æ’ä¾¿é‡', 'volume-options', bowelVolumes, record.volume, false)}
Â  Â  Â  Â  Â  Â  Â  Â  ${createOptionGroup('(5) â±ï¸ æ’ä¾¿è€—æ™‚', 'duration-options', bowelDurations, record.duration, false)}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  ${createOptionGroup('(6) ğŸ˜– ç—‡ç‹€', 'symptoms-options', bowelSymptoms, record.symptoms, true)}
Â  Â  Â  Â  Â  Â  ${createOptionGroup('(7) âœ¨ é™„åŠ ç‹€æ…‹', 'status-options', bowelAdditionalStatus, record.additionalStatus, true)}
Â  Â  Â  Â  Â  Â  <div class="form-section">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-section-label text-slate-600 dark:text-slate-400">(8) ğŸ—’ï¸ å‚™è¨»</label>
Â  Â  Â  Â  Â  Â  Â  Â  <textarea class="bowel-notes w-full p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-200 rounded-md mt-2">${record.notes || ''}</textarea>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>`;
Â  Â  }

Â  Â  function createSwallowingFormHTML(record, index) {
Â  Â  Â  Â  const id = record.id || Date.now();
Â  Â  Â  Â  const createRadioGroup = (label, name, options, selected) => `
Â  Â  Â  Â  Â  Â  <div class="form-section">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-section-label text-slate-600 dark:text-slate-400">${label}</label>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-wrap gap-x-4 gap-y-2 mt-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${options.map(opt => `<label class="flex items-center text-sm"><input type="radio" name="${name}-${id}" value="${opt}" class="custom-radio mr-2" ${opt === selected ? 'checked' : ''}>${opt}</label>`).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const createCheckboxGroup = (label, name, options, selected) => `
Â  Â  Â  Â  Â  Â  <div class="form-section">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-section-label text-slate-600 dark:text-slate-400">${label}</label>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-wrap gap-x-4 gap-y-2 mt-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${options.map(opt => `<label class="flex items-center text-sm"><input type="checkbox" name="${name}-${id}" value="${opt}" class="custom-checkbox mr-2" ${selected.includes(opt) ? 'checked' : ''}>${opt}</label>`).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>`;

Â  Â  Â  Â  return `
Â  Â  Â  Â  <div class="swallowing-record-form border-t-2 border-teal-200 dark:border-teal-700 pt-4" data-id="${id}">
Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="font-semibold text-md text-teal-700 dark:text-teal-300">ç¬¬ ${index} ç­†å—†åˆ°äº‹ä»¶</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="remove-swallowing-record-btn text-sm font-medium text-red-500 hover:text-red-700">åˆªé™¤æ­¤ç­†</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-section !mt-0 !pt-0 !border-t-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-section-label text-slate-600 dark:text-slate-400">â° äº‹ä»¶æ™‚é–“</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" class="swallowing-time w-full p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-200 rounded-md mt-2" value="${record.time || ''}">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  ${createRadioGroup('ğŸ½ï¸ ç”¨é¤/å–æ°´æƒ…å¢ƒ', 'swallowing-context', swallowingContexts, record.context)}
Â  Â  Â  Â  Â  Â  Â  Â  ${createRadioGroup('ğŸ§˜ å§¿å‹¢', 'swallowing-posture', swallowingPostures, record.posture)}
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-section-label text-slate-600 dark:text-slate-400">ğŸ² é£Ÿç‰©/é£²å“é¡å‹</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pl-4 mt-2 space-y-3 border-l-2 dark:border-slate-600">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${createRadioGroup('ğŸ’§ é£²æ°´', 'swallowing-drinkType', swallowingDrinkTypes, record.drinkType)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${createRadioGroup('ğŸš å›ºé«”', 'swallowing-solidType', swallowingSolidTypes, record.solidType)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${createRadioGroup('ğŸ’Š è—¥ç‰©', 'swallowing-medType', swallowingMedTypes, record.medType)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-2 gap-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${createRadioGroup('ğŸ¤ ä»½é‡', 'swallowing-portion', swallowingPortions, record.portion)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${createRadioGroup('ğŸƒâ€â™€ï¸ é€Ÿåº¦', 'swallowing-speed', swallowingSpeeds, record.speed)}
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  ${createRadioGroup('ğŸ—£ï¸ ç™¼ç”Ÿæ™‚æ˜¯å¦èªªè©±/å¤§ç¬‘/åˆ†å¿ƒ', 'swallowing-distraction', swallowingDistractions, record.distraction)}
Â  Â  Â  Â  Â  Â  Â  Â  ${createCheckboxGroup('ğŸ¥µ å—†å’³/å—†åˆ°ç—‡ç‹€', 'swallowing-symptoms', swallowingSymptoms, record.symptoms)}
Â  Â  Â  Â  Â  Â  Â  Â  ${createRadioGroup('ğŸ“Š åš´é‡åº¦åˆ†ç´š', 'swallowing-severity', swallowingSeverities, record.severity)}
Â  Â  Â  Â  Â  Â  Â  Â  ${createRadioGroup('ï¸ ç¾å ´è™•ç½®', 'swallowing-action', swallowingActions, record.action)}
Â  Â  Â  Â  Â  Â  Â  Â  ${createRadioGroup('ğŸ“ˆ çµæœ', 'swallowing-result', swallowingResults, record.result)}
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-section-label text-slate-600 dark:text-slate-400">ğŸ—’ï¸ å‚™è¨» (å¯èƒ½èª˜å› )</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea class="swallowing-notes w-full p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-200 rounded-md mt-2" placeholder="å¤ªä¹¾ã€å¤ªå¤§å£ã€é‚Šè¬›è©±ã€å‡ç‰™é¬†ã€è—¥éŒ å¤ªå¤§ç­‰...">${record.notes || ''}</textarea>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>`;
Â  Â  }

Â  Â  function createOptionGroup(label, className, options, selectedValues, isMultiSelect, isColorGrid = false) {
Â  Â  Â  Â  const groupClass = isMultiSelect ? `option-button-group ${className} multi-select-group flex flex-wrap gap-2` : `option-button-group ${className} flex flex-wrap gap-2`;
Â  Â  Â  Â  let buttons;

Â  Â  Â  Â  if (isColorGrid) {
Â  Â  Â  Â  Â  Â  buttons = `<div class="color-options grid grid-cols-3 gap-2 mt-2">${bowelColorData.map(color => `<div class="color-item p-2 rounded-lg border-2 border-slate-200 dark:border-slate-600 cursor-pointer text-center flex flex-col items-center justify-center ${selectedValues === color.name ? 'bristol-selected' : ''}" data-value="${color.name}"><div class="w-10 h-10 rounded-full mb-1" style="background-color:${color.colorHex};"></div><p class="text-xs text-slate-600 dark:text-slate-400">${color.name}</p></div>`).join('')}</div>`;
Â  Â  Â  Â  Â  Â  return `<div class="form-section"><label class="form-section-label text-slate-600 dark:text-slate-400">${label}</label>${buttons}</div>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  buttons = options.map(opt => `<button type="button" class="option-button text-sm py-1 px-3 rounded-full border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 ${(Array.isArray(selectedValues) ? selectedValues.includes(opt) : opt === selectedValues) ? 'selected' : ''}" data-value="${opt}">${opt}</button>`).join('');
Â  Â  Â  Â  Â  Â  return `<div class="form-section"><label class="form-section-label text-slate-600 dark:text-slate-400">${label}</label><div class="${groupClass} mt-2">${buttons}</div></div>`;
Â  Â  Â  Â  }
Â  Â  }


Â  Â  function getBowelStatus(types) {
Â  Â  Â  Â  if (!types || types.length === 0) return null;
Â  Â  Â  Â  const avg = types.reduce((a, b) => a + b, 0) / types.length;
Â  Â  Â  Â  if (avg >= 3 && avg < 5) return { text: 'å¥åº·', colorClass: 'status-badge-green', icon: 'âœ…' };
Â  Â  Â  Â  if (avg < 3) return { text: 'ä¾¿ç§˜', colorClass: 'status-badge-orange', icon: 'âš ï¸' };
Â  Â  Â  Â  if (avg >= 5) return { text: 'è…¹ç€‰', colorClass: 'status-badge-blue', icon: 'ğŸ’§' };
Â  Â  Â  Â  return null;
Â  Â  }

Â  Â  function renderHistoryList(filterWeek = 'all') {
Â  Â  Â  const sortedDates = Object.keys(appState.dailyLogs).sort().reverse();
Â  Â  Â Â 
Â  Â  Â  const filteredDates = filterWeek === 'all'Â 
Â  Â  Â  Â  ? sortedDates
Â  Â  Â  Â  : sortedDates.filter(date => {
Â  Â  Â  Â  Â  Â  const [year, week] = filterWeek.split('-');
Â  Â  Â  Â  Â  Â  return dayjs(date).year() == year && dayjs(date).week() == week;
Â  Â  Â  Â  });

Â  Â  Â  if (filteredDates.length === 0) {
Â  Â  Â  Â  DOM.historyList.innerHTML = `<div class="empty-state">
Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1" class="text-slate-400 dark:text-slate-500"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
Â  Â  Â  Â  Â  Â  <h3 class="font-semibold">å°šç„¡ç´€éŒ„</h3>
Â  Â  Â  Â  Â  Â  <p class="text-sm mt-1">é–‹å§‹è¨˜éŒ„æ‚¨çš„ç¬¬ä¸€ç­†å¥åº·æ—¥èªŒå§ï¼</p>
Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  DOM.historyList.innerHTML = filteredDates.map(date => {
Â  Â  Â  Â  const log = appState.dailyLogs[date];
Â  Â  Â  Â  const sleep = log.sleep > 0 ? `${'â˜…'.repeat(log.sleep)}${'â˜†'.repeat(5 - log.sleep)}` : 'æœªè¨˜éŒ„';
Â  Â  Â  Â  const nightVisits = (log.nightToiletVisits !== undefined && log.nightToiletVisits > -1) ? `${log.nightToiletVisits} æ¬¡` : '0 æ¬¡';
Â  Â  Â  Â  const rbdText = log.rbd?.symptoms?.length > 0 ? log.rbd.symptoms.map(id => rbdSymptomsList.find(s => s.id === id)?.label || id).join('ã€ ') : 'ç„¡';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const swallowingSummary = !log.hadSwallowingEventÂ 
Â  Â  Â  Â  Â  Â  ? '<span class="text-slate-500 dark:text-slate-400 ml-5">ç•¶æ—¥ç„¡å—†åˆ°</span>'
Â  Â  Â  Â  Â  Â  : (log.swallowing && log.swallowing.length > 0Â 
Â  Â  Â  Â  Â  Â  Â  Â  ? `<ul class="list-none pl-5 space-y-1">${log.swallowing.map(s => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const severityBadge = s.severity ? `<span class="status-badge ${s.severity === 'é‡' ? 'status-badge-red' : (s.severity === 'ä¸­' ? 'status-badge-orange' : 'status-badge-blue')}">${s.severity}</span>` : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<li class="border-l-2 border-teal-200 dark:border-teal-700 pl-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center text-xs gap-2">${s.time ? `<b>${s.time}</b>` : ''}${severityBadge}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-slate-500 dark:text-slate-400 text-[11px]">${[s.context, s.solidType, s.drinkType].filter(Boolean).join(', ')}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </li>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join('')}</ul>`
Â  Â  Â  Â  Â  Â  Â  Â  : '<span class="text-slate-500 dark:text-slate-400 ml-5">æœ‰å—†åˆ°ï¼Œä½†æœªè¨˜éŒ„</span>');

Â  Â  Â  Â  return `<div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-lg text-slate-800 dark:text-slate-200">${dayjs(date).format('YYYY/MM/DD')}</p>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="edit-log-btn text-sm text-blue-600 hover:underline" data-date="${date}">æŸ¥çœ‹/ç·¨è¼¯</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="text-sm text-slate-700 dark:text-slate-300 space-y-2">
Â  Â  Â  Â  Â  Â  Â  Â  <p>ğŸ˜´ <b class="font-semibold">ç¡çœ :</b> ${sleep}</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p>ğŸš½ <b class="font-semibold">å¤œé–“å¦‚å»:</b> ${nightVisits}</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p>ğŸƒâ€â™‚ï¸ <b class="font-semibold">RBD ç—‡ç‹€:</b> ${rbdText}</p>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mb-1">ğŸ’© <b class="font-semibold">æ’ä¾¿ç´€éŒ„:</b></p>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${!log.hadBowelMovement ? '<span class="text-slate-500 dark:text-slate-400 ml-5">ç•¶æ—¥ç„¡æ’ä¾¿</span>' : (log.bowel && log.bowel.length > 0 ? `<ul class="list-none pl-5 space-y-1">${log.bowel.map(b => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const status = getBowelStatus(b.types);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const statusBadge = status ? `<span class="status-badge ${status.colorClass}">${status.icon} ${status.text}</span>` : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<li class="border-l-2 border-slate-200 dark:border-slate-700 pl-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center text-xs gap-2">${b.bowelTimeOfDay ? `<b>${b.bowelTimeOfDay}</b>` : ''}${statusBadge}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-slate-500 dark:text-slate-400 text-[11px]">é¡å‹ ${Array.isArray(b.types) && b.types.length ? b.types.join(', ') : '?'} (${b.color || 'N/A'}, ${b.volume || 'N/A'})</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </li>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join('')}</ul>` : '<span class="text-slate-500 dark:text-slate-400 ml-5">æœ‰æ’ä¾¿ï¼Œä½†æœªè¨˜éŒ„</span>')}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mb-1">ğŸ² <b class="font-semibold">ååš¥ç´€éŒ„:</b></p>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${swallowingSummary}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>`;
Â  Â  Â  }).join('');
Â  Â  }

Â  Â  function updateLastBackupInfo() {
Â  Â  Â  Â  if (appState.lastBackupDate) {
Â  Â  Â  Â  Â  Â  DOM.lastBackupInfo.textContent = `æœ€å¾Œå„²å­˜æ–¼ï¼š${dayjs(appState.lastBackupDate).format('YYYY/MM/DD HH:mm:ss')}`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  DOM.lastBackupInfo.textContent = 'å°šæœªæœ‰ä»»ä½•å„²å­˜ç´€éŒ„ã€‚';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function getChartColors() {
Â  Â  Â  const isDarkMode = DOM.html.classList.contains('dark');
Â  Â  Â  return { gridColor: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)', textColor: isDarkMode ? '#cbd5e1' : '#475569' };
Â  Â  }

Â  Â  function updateCharts() {
Â  Â  Â  const weekStart = dayjs().subtract(appState.statsWeekOffset, 'week').startOf('week');
Â  Â  Â  const weekEnd = dayjs().subtract(appState.statsWeekOffset, 'week').endOf('week');
Â  Â  Â  DOM.statsWeekTitle.textContent = `${weekStart.format('YYYY/MM/DD')} - ${weekEnd.format('MM/DD')}`;
Â  Â  Â  DOM.nextWeekBtn.disabled = appState.statsWeekOffset <= 0;
Â  Â  Â Â 
Â  Â  Â  const weekData = getWeekData(weekStart);Â 
Â  Â  Â  const hasAnyData = Object.values(weekData).some(arr => arr.some(val => val !== null && val !== 0 && (!Array.isArray(val) || val.length > 0)));

Â  Â  Â  if (!hasAnyData) {
Â  Â  Â  Â  DOM.statsContent.innerHTML = `<div class="empty-state">
Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1" class="text-slate-400 dark:text-slate-500"><path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>
Â  Â  Â  Â  Â  Â  <h3 class="font-semibold">æœ¬é€±å°šç„¡çµ±è¨ˆè³‡æ–™</h3>
Â  Â  Â  Â  Â  Â  <p class="text-sm mt-1">è«‹å…ˆæ–°å¢ä¸€äº›æ—¥èªŒç´€éŒ„ï¼</p>
Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  DOM.statsContent.innerHTML = `
Â  Â  Â  Â  <section id="ai-insight-section" class="bg-blue-50 dark:bg-blue-900/50 border-l-4 border-blue-500 p-4 rounded-r-lg shadow-sm space-y-2 text-blue-800 dark:text-blue-200">
Â  Â  Â  Â  Â  <h3 class="text-lg font-semibold flex items-center">âœ¨ æœ¬é€±æ´å¯Ÿ</h3>
Â  Â  Â  Â  Â  <div id="ai-insight-text" class="text-sm"></div>
Â  Â  Â  Â  </section>
Â  Â  Â  Â  <section id="bowel-analysis-section" class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-4 text-slate-800 dark:text-slate-200"></section>
Â  Â  Â  Â  <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-4 text-slate-800 dark:text-slate-200">
Â  Â  Â  Â  Â  <h3 class="text-lg font-semibold">ğŸ² ååš¥äº‹ä»¶çµ±è¨ˆ</h3>
Â  Â  Â  Â  Â  <div class="relative h-64 md:h-80"><canvas id="swallowing-chart"></canvas></div>
Â  Â  Â  Â  Â  <div id="stats-summary-swallowing" class="text-sm text-center text-slate-500 dark:text-slate-400 pt-2"></div>
Â  Â  Â  Â  </section>
Â  Â  Â  Â  <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-4 text-slate-800 dark:text-slate-200">
Â  Â  Â  Â  Â  <h3 class="text-lg font-semibold">ğŸ˜´ ç¡çœ å“è³ªè¶¨å‹¢</h3>
Â  Â  Â  Â  Â  <div class="relative h-64 md:h-80"><canvas id="sleep-chart"></canvas></div>
Â  Â  Â  Â  Â  <div id="stats-summary-sleep" class="text-sm text-center text-slate-500 dark:text-slate-400 pt-2"></div>
Â  Â  Â  Â  </section>
Â  Â  Â  Â  <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-4 text-slate-800 dark:text-slate-200">
Â  Â  Â  Â  Â  <h3 class="text-lg font-semibold">ğŸš½ å¤œé–“èµ·åºŠå¦‚å»æ¬¡æ•¸è¶¨å‹¢</h3>
Â  Â  Â  Â  Â  <div class="relative h-64 md:h-80"><canvas id="night-toilet-chart"></canvas></div>
Â  Â  Â  Â  Â  <div id="stats-summary-night-toilet" class="text-sm text-center text-slate-500 dark:text-slate-400 pt-2"></div>
Â  Â  Â  Â  </section>
Â  Â  Â  Â  <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-4 text-slate-800 dark:text-slate-200">
Â  Â  Â  Â  Â  <h3 class="text-lg font-semibold">â° æ’ä¾¿æ™‚é–“é»åˆ†ä½ˆ</h3>
Â  Â  Â  Â  Â  <div class="relative h-64 md:h-80"><canvas id="bowel-time-chart"></canvas></div>
Â  Â  Â  Â  </section>
Â  Â  Â  Â  <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-4 text-slate-800 dark:text-slate-200">
Â  Â  Â  Â  Â  <h3 class="text-lg font-semibold">ğŸ’© æ’ä¾¿é¡å‹è¶¨å‹¢</h3>
Â  Â  Â  Â  Â  <div class="relative h-64 md:h-80"><canvas id="bowel-chart"></canvas></div>
Â  Â  Â  Â  Â  <div id="stats-summary-bowel" class="text-sm text-center text-slate-500 dark:text-slate-400 pt-2"></div>
Â  Â  Â  Â  </section>
Â  Â  Â  Â  <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-4 text-slate-800 dark:text-slate-200">
Â  Â  Â  Â  Â  <h3 class="text-lg font-semibold">ğŸƒâ€â™‚ï¸ RBD ç—‡ç‹€çµ±è¨ˆ</h3>
Â  Â  Â  Â  Â  <div class="relative h-64 md:h-80"><canvas id="rbd-chart"></canvas></div>
Â  Â  Â  Â  Â  <div id="stats-summary-rbd" class="text-sm text-center text-slate-500 dark:text-slate-400 pt-2"></div>
Â  Â  Â  Â  </section>
Â  Â  Â  Â  <section id="health-tips-section" class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-3 text-slate-800 dark:text-slate-200"></section>
Â  Â  Â  `;
Â  Â  Â  // Re-assign DOM elements after re-rendering
Â  Â  Â  DOM.aiInsightText = document.getElementById('ai-insight-text');
Â  Â  Â  DOM.bowelAnalysisSection = document.getElementById('bowel-analysis-section');
Â  Â  Â  DOM.statsSummarySwallowing = document.getElementById('stats-summary-swallowing');
Â  Â  Â  DOM.statsSummarySleep = document.getElementById('stats-summary-sleep');
Â  Â  Â  DOM.statsSummaryNightToilet = document.getElementById('stats-summary-night-toilet');
Â  Â  Â  DOM.statsSummaryBowel = document.getElementById('stats-summary-bowel');
Â  Â  Â  DOM.statsSummaryRbd = document.getElementById('stats-summary-rbd');
Â  Â  Â  DOM.healthTipsSection = document.getElementById('health-tips-section');
Â  Â  Â Â 
Â  Â  Â  generateHealthInsights(weekData);Â 
Â  Â  Â  updateBowelAnalysis(weekStart);
Â  Â  Â  updateSwallowingChart(weekStart, weekData);
Â  Â  Â  updateSleepChart(weekStart, weekData);
Â  Â  Â  updateNightToiletChart(weekStart, weekData);
Â  Â  Â  updateBowelTimeChart(weekStart, weekData);
Â  Â  Â  updateBowelChart(weekStart, weekData);
Â  Â  Â  updateRbdChart(weekStart, weekData);
Â  Â  Â  renderStaticHealthTips();
Â  Â  }

Â  Â  function getWeekData(weekStart) {
Â  Â  Â  Â  const data = { labels: [], sleep: [], nightToilet: [], bowel: [], bowelCount: [], rbd: [], swallowingCount: [], dates: [] };
Â  Â  Â  Â  for (let i = 0; i < 7; i++) {
Â  Â  Â  Â  Â  Â  const date = weekStart.add(i, 'day');
Â  Â  Â  Â  Â  Â  const dateStr = date.format('YYYY-MM-DD');
Â  Â  Â  Â  Â  Â  const log = appState.dailyLogs[dateStr];
Â  Â  Â  Â  Â  Â  data.labels.push(date.format('M/D'));
Â  Â  Â  Â  Â  Â  data.dates.push(dateStr);
Â  Â  Â  Â  Â  Â  data.sleep.push(log ? log.sleep : null);
Â  Â  Â  Â  Â  Â  data.nightToilet.push(log && log.nightToiletVisits > -1 ? log.nightToiletVisits : null);
Â  Â  Â  Â  Â  Â  data.bowel.push(log && log.bowel && log.bowel.length > 0 ? log.bowel.flatMap(b => b.types) : null);
Â  Â  Â  Â  Â  Â  data.bowelCount.push(log && log.bowel ? log.bowel.length : 0);
Â  Â  Â  Â  Â  Â  data.rbd.push(log && log.rbd && log.rbd.symptoms.length > 0 && !log.rbd.symptoms.includes('none') ? log.rbd.symptoms.length : 0);
Â  Â  Â  Â  Â  Â  data.swallowingCount.push(log && log.swallowing ? log.swallowing.length : 0);
Â  Â  Â  Â  }
Â  Â  Â  Â  return data;
Â  Â  }

Â  Â  function generateHealthInsights(weekData) {
Â  Â  Â  Â  if (!DOM.aiInsightText) return;

Â  Â  Â  Â  const totalBowelMovements = weekData.bowelCount.reduce((a, b) => a + b, 0);
Â  Â  Â  Â  const totalSwallowingEvents = weekData.swallowingCount.reduce((a, b) => a + b, 0);

Â  Â  Â  Â  const validSleep = weekData.sleep.filter(s => s > 0);
Â  Â  Â  Â  const avgSleepText = validSleep.length > 0
Â  Â  Â  Â  Â  Â  ? `å¹³å‡ ${ (validSleep.reduce((a, b) => a + b, 0) / validSleep.length).toFixed(1) } é¡†æ˜Ÿ`
Â  Â  Â  Â  Â  Â  : 'ç„¡ç´€éŒ„';

Â  Â  Â  Â  const totalNightToilet = weekData.nightToilet.filter(n => n !== null).reduce((a, b) => a + b, 0);
Â  Â  Â  Â  const totalRbd = weekData.rbd.reduce((a, b) => a + b, 0);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const weekLabel = appState.statsWeekOffset === 0 ? 'æœ¬é€±' : 'è©²é€±';

Â  Â  Â  Â  DOM.aiInsightText.innerHTML = `
Â  Â  Â  Â  Â  Â  <ul class="list-disc list-inside space-y-1">
Â  Â  Â  Â  Â  Â  Â  Â  <li>ğŸ’© <b>æ’ä¾¿ç´€éŒ„ï¼š</b>${weekLabel}å…± ${totalBowelMovements} æ¬¡</li>
Â  Â  Â  Â  Â  Â  Â  Â  <li>ğŸ² <b>å—†åˆ°äº‹ä»¶ï¼š</b>${weekLabel}å…± ${totalSwallowingEvents} æ¬¡</li>
Â  Â  Â  Â  Â  Â  Â  Â  <li>ğŸ˜´ <b>ç¡çœ å“è³ªï¼š</b>${avgSleepText}</li>
Â  Â  Â  Â  Â  Â  Â  Â  <li>ğŸš½ <b>èµ·åºŠå¦‚å»ï¼š</b>${weekLabel}å…± ${totalNightToilet} æ¬¡</li>
Â  Â  Â  Â  Â  Â  Â  Â  <li>ğŸƒâ€â™‚ï¸ <b>RBD ç—‡ç‹€ï¼š</b>${weekLabel}å…± ${totalRbd} æ¬¡</li>
Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  `;
Â  Â  }

Â  Â  function updateBowelAnalysis(weekStart) {
Â  Â  Â  if (!DOM.bowelAnalysisSection) return;
Â  Â  Â  const allLogs = appState.dailyLogs;
Â  Â  Â  let lastBM = null;
Â  Â  Â  const sortedDates = Object.keys(allLogs).sort().reverse();
Â  Â  Â  for (const date of sortedDates) {
Â  Â  Â  Â  if (allLogs[date].bowel && allLogs[date].bowel.length > 0) {
Â  Â  Â  Â  Â  const sortedBMs = allLogs[date].bowel.filter(b => b.bowelTimeOfDay).sort((a, b) => b.bowelTimeOfDay.localeCompare(a.bowelTimeOfDay));
Â  Â  Â  Â  Â  if (sortedBMs.length > 0) { lastBM = dayjs(`${date} ${sortedBMs[0].bowelTimeOfDay}`); break; }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  const getStatsForPeriod = (startDate, endDate) => {
Â  Â  Â  Â  let totalBMs = 0, goodBMs = 0;
Â  Â  Â  Â  for (let d = startDate; d.isBefore(endDate) || d.isSame(endDate); d = d.add(1, 'day')) {
Â  Â  Â  Â  Â  const log = allLogs[d.format('YYYY-MM-DD')];
Â  Â  Â  Â  Â  if (log && log.bowel && log.bowel.length > 0) {
Â  Â  Â  Â  Â  Â  totalBMs += log.bowel.length;
Â  Â  Â  Â  Â  Â  log.bowel.forEach(b => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  const status = getBowelStatus(b.types);
Â  Â  Â  Â  Â  Â  Â  Â  if (status && status.text === 'å¥åº·') goodBMs++;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  return { totalBMs, goodBMs };
Â  Â  Â  };
Â  Â  Â  const currentWeekStats = getStatsForPeriod(weekStart, weekStart.add(6, 'day'));
Â  Â  Â  const previousWeekStats = getStatsForPeriod(weekStart.subtract(7, 'day'), weekStart.subtract(1, 'day'));
Â  Â  Â  const goodBMPercent = currentWeekStats.totalBMs > 0 ? Math.round((currentWeekStats.goodBMs / currentWeekStats.totalBMs) * 100) : 0;
Â  Â  Â  const prevGoodBMPercent = previousWeekStats.totalBMs > 0 ? Math.round((previousWeekStats.goodBMs / previousWeekStats.totalBMs) * 100) : 0;
Â  Â  Â  const weekLabel = appState.statsWeekOffset === 0 ? 'æœ¬é€±' : 'è©²é€±';
Â  Â  Â  DOM.bowelAnalysisSection.innerHTML = `<h3 class="text-lg font-semibold">ğŸ“Š æ’ä¾¿åˆ†æ</h3><p class="text-sm text-slate-600 dark:text-slate-400"><b>ä¸Šä¸€æ¬¡æ’ä¾¿ï¼š</b> ${lastBM ? lastBM.fromNow() : 'ç„¡ç´€éŒ„'}</p><div class="grid grid-cols-2 gap-4 text-center"><div class="bg-slate-100 dark:bg-slate-700 p-3 rounded-lg"><p class="text-2xl font-bold">${currentWeekStats.totalBMs} <span class="text-sm font-normal">æ¬¡</span></p><p class="text-xs text-slate-500 dark:text-slate-400">${weekLabel}</p><p class="text-xs text-slate-500 dark:text-slate-400 mt-1">ç›¸è¼ƒæ–¼å‰7å¤©çš„ ${previousWeekStats.totalBMs} æ¬¡</p></div><div class="bg-slate-100 dark:bg-slate-700 p-3 rounded-lg"><p class="text-2xl font-bold">${goodBMPercent}<span class="text-sm font-normal">%</span></p><p class="text-xs text-slate-500 dark:text-slate-400">${weekLabel}å¥åº·ä¾¿ä¾¿</p><p class="text-xs text-slate-500 dark:text-slate-400 mt-1">ç›¸è¼ƒæ–¼å‰7å¤©çš„ ${prevGoodBMPercent}%</p></div></div>`;
Â  Â  }
Â  Â  function updateSwallowingChart(weekStart, weekData) {
Â  Â  Â  Â  const canvas = document.getElementById('swallowing-chart');
Â  Â  Â  Â  if (!canvas) return;
Â  Â  Â  Â  const colors = getChartColors();
Â  Â  Â  Â  if (appState.charts.swallowing) appState.charts.swallowing.destroy();
Â  Â  Â  Â  appState.charts.swallowing = new Chart(canvas, {
Â  Â  Â  Â  Â  Â  type: 'bar',
Â  Â  Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  Â  Â  Â  labels: weekData.labels,
Â  Â  Â  Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label: 'å—†åˆ°æ¬¡æ•¸',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: weekData.swallowingCount,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: 'rgba(20, 184, 166, 0.6)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderColor: 'rgba(13, 148, 136, 1)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderWidth: 1
Â  Â  Â  Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  Â  Â  Â  maintainAspectRatio: false,
Â  Â  Â  Â  Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y: { beginAtZero: true, ticks: { stepSize: 1, color: colors.textColor }, grid: { color: colors.gridColor } },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  x: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } }
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  plugins: { legend: { display: false } }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  const totalEvents = weekData.swallowingCount.reduce((a, b) => a + b, 0);
Â  Â  Â  Â  DOM.statsSummarySwallowing.textContent = `æœ¬é€±å…±ç™¼ç”Ÿ ${totalEvents} æ¬¡å—†åˆ°äº‹ä»¶ã€‚`;
Â  Â  }
Â  Â  function updateSleepChart(weekStart, weekData) {
Â  Â  Â  const canvas = document.getElementById('sleep-chart');
Â  Â  Â  if (!canvas) return;
Â  Â  Â  const colors = getChartColors();
Â  Â  Â  if (appState.charts.sleep) appState.charts.sleep.destroy();
Â  Â  Â  appState.charts.sleep = new Chart(canvas, { type: 'line', data: { labels: weekData.labels, datasets: [{ label: 'ç¡çœ å“è³ª', data: weekData.sleep, borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', fill: true, tension: 0.3, spanGaps: true }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 1, max: 5, ticks: { stepSize: 1, color: colors.textColor }, grid: { color: colors.gridColor } }, x: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } } }, plugins: { legend: { display: false } } } });
Â  Â  Â  const validRecords = weekData.sleep.filter(p => p !== null && p > 0);
Â  Â  Â  DOM.statsSummarySleep.textContent = validRecords.length > 0 ? `æœ¬é€±å¹³å‡ç¡çœ å“è³ªç‚º ${(validRecords.reduce((a, b) => a + b, 0) / validRecords.length).toFixed(1)} é¡†æ˜Ÿã€‚` : 'æœ¬é€±æ²’æœ‰ç¡çœ å“è³ªç´€éŒ„ã€‚';
Â  Â  }
Â  Â  function updateNightToiletChart(weekStart, weekData) {
Â  Â  Â  const canvas = document.getElementById('night-toilet-chart');
Â  Â  Â  if (!canvas) return;
Â  Â  Â  const colors = getChartColors();
Â  Â  Â  if (appState.charts.nightToilet) appState.charts.nightToilet.destroy();
Â  Â  Â  appState.charts.nightToilet = new Chart(canvas, { type: 'bar', data: { labels: weekData.labels, datasets: [{ label: 'å¤œé–“å¦‚å»æ¬¡æ•¸', data: weekData.nightToilet, backgroundColor: 'rgba(139, 92, 246, 0.6)', borderColor: 'rgba(139, 92, 246, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, color: colors.textColor }, grid: { color: colors.gridColor } }, x: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } } }, plugins: { legend: { display: false } } } });
Â  Â  Â  const validRecords = weekData.nightToilet.filter(p => p !== null);
Â  Â  Â  DOM.statsSummaryNightToilet.textContent = validRecords.length > 0 ? `æœ¬é€±å¹³å‡å¤œé–“å¦‚å» ${(validRecords.reduce((a, b) => a + b, 0) / validRecords.length).toFixed(1)} æ¬¡ã€‚` : 'æœ¬é€±æ²’æœ‰å¤œé–“å¦‚å»ç´€éŒ„ã€‚';
Â  Â  }
Â  Â  function updateBowelTimeChart(weekStart, weekData) {
Â  Â  Â  const canvas = document.getElementById('bowel-time-chart');
Â  Â  Â  if (!canvas) return;
Â  Â  Â  const colors = getChartColors();
Â  Â  Â  const datasets = [];
Â  Â  Â  weekData.dates.forEach((dateStr, i) => {
Â  Â  Â  Â  const log = appState.dailyLogs[dateStr];
Â  Â  Â  Â  if (log && log.bowel && log.bowel.length > 0) {
Â  Â  Â  Â  Â  log.bowel.forEach(b => {
Â  Â  Â  Â  Â  Â  if (b.bowelTimeOfDay) {
Â  Â  Â  Â  Â  Â  Â  const time = dayjs(b.bowelTimeOfDay, 'HH:mm');
Â  Â  Â  Â  Â  Â  Â  datasets.push({ x: i, y: time.hour() + time.minute() / 60, types: Array.isArray(b.types) ? b.types.join(', ') : '' });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  if (appState.charts.bowelTime) appState.charts.bowelTime.destroy();
Â  Â  Â  appState.charts.bowelTime = new Chart(canvas, { type: 'scatter', data: { datasets: [{ label: 'æ’ä¾¿æ™‚é–“', data: datasets, backgroundColor: 'rgba(59, 130, 246, 0.7)', pointRadius: 6, pointHoverRadius: 8 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'linear', position: 'bottom', ticks: { color: colors.textColor, stepSize: 1, callback: (value) => weekData.labels[value] || '' }, grid: { display: false } }, y: { reverse: true, min: 0, max: 24, ticks: { color: colors.textColor, stepSize: 3, callback: (value) => `${String(value).padStart(2, '0')}:00` }, grid: { color: colors.gridColor } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => { const d = c.dataset.data[c.dataIndex]; const h = Math.floor(d.y); const m = Math.round((d.y - h) * 60); return `æ™‚é–“: ${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')} (é¡å‹: ${d.types})`; } } } } } });
Â  Â  }
Â  Â  function updateBowelChart(weekStart, weekData) {
Â  Â  Â  const canvas = document.getElementById('bowel-chart');
Â  Â  Â  if (!canvas) return;
Â  Â  Â  const colors = getChartColors();
Â  Â  Â  const dataPoints = weekData.bowel.map(dayBowel => {
Â  Â  Â  Â  if (dayBowel && dayBowel.length > 0) return dayBowel.reduce((a, b) => a + b, 0) / dayBowel.length;
Â  Â  Â  Â  return null;
Â  Â  Â  });
Â  Â  Â  if (appState.charts.bowel) appState.charts.bowel.destroy();
Â  Â  Â  appState.charts.bowel = new Chart(canvas, { type: 'line', data: { labels: weekData.labels, datasets: [{ label: 'å¸ƒé‡Œæ–¯æ‰˜åˆ†é¡', data: dataPoints, borderColor: '#3B82F6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.3, spanGaps: true }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 1, max: 7, ticks: { stepSize: 1, color: colors.textColor }, grid: { color: colors.gridColor } }, x: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } } }, plugins: { legend: { display: false } } } });
Â  Â  Â  const validRecords = dataPoints.filter(p => p !== null);
Â  Â  Â  DOM.statsSummaryBowel.textContent = validRecords.length > 0 ? `æœ¬é€±å¹³å‡é¡å‹ç‚º ${(validRecords.reduce((a, b) => a + b, 0) / validRecords.length).toFixed(1)}ã€‚` : 'æœ¬é€±æ²’æœ‰æ’ä¾¿ç´€éŒ„ã€‚';
Â  Â  }
Â  Â  function updateRbdChart(weekStart, weekData) {
Â  Â  Â  const canvas = document.getElementById('rbd-chart');
Â  Â  Â  if (!canvas) return;
Â  Â  Â  const colors = getChartColors();
Â  Â  Â  const rbdSymptomMap = rbdSymptomsList.reduce((acc, s) => ({...acc, [s.id]: s.label}), {});
Â  Â  Â  const tooltipLabels = weekData.dates.map(dateStr => {
Â  Â  Â  Â  Â  const log = appState.dailyLogs[dateStr];
Â  Â  Â  Â  Â  if (log && Array.isArray(log.rbd.symptoms) && log.rbd.symptoms.length > 0 && !log.rbd.symptoms.includes('none')) {
Â  Â  Â  Â  Â  Â  Â  return log.rbd.symptoms.map(id => rbdSymptomMap[id] || id).join('ã€ ');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  return 'ç„¡ç—‡ç‹€';
Â  Â  Â  });
Â  Â  Â  if (appState.charts.rbd) appState.charts.rbd.destroy();
Â  Â  Â  appState.charts.rbd = new Chart(canvas, { type: 'bar', data: { labels: weekData.labels, datasets: [{ label: 'ç—‡ç‹€æ¬¡æ•¸', data: weekData.rbd, backgroundColor: 'rgba(239, 68, 68, 0.6)', borderColor: 'rgba(239, 68, 68, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, color: colors.textColor }, grid: { color: colors.gridColor } }, x: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.parsed.y} æ¬¡`, afterLabel: (c) => tooltipLabels[c.dataIndex] } } } } });
Â  Â  Â  DOM.statsSummaryRbd.textContent = `æœ¬é€±å…±è¨˜éŒ„ ${weekData.rbd.reduce((a, b) => a + b, 0)} æ¬¡RBDç›¸é—œç—‡ç‹€ã€‚`;
Â  Â  }
Â  Â Â 
Â  Â  function renderStaticHealthTips() {
Â  Â  Â  Â  if (!DOM.healthTipsSection) return;
Â  Â  Â  Â  DOM.healthTipsSection.innerHTML = `<h3 class="text-lg font-semibold">ğŸ’¡ å¥åº·å°æç¤º</h3><ul class="text-sm text-slate-600 dark:text-slate-400 space-y-2 list-disc list-inside"><li><b>ç†æƒ³ä¾¿ä¾¿ï¼š</b>ä»¥ã€Œå¸ƒé‡Œæ–¯æ‰˜å¤§ä¾¿åˆ†é¡æ³•ã€ç¬¬3â€“4å‹ç‚ºä½³ï¼Œç‰¹åˆ¥æ˜¯ç¬¬4å‹æœ€ç†æƒ³ã€‚</li><li><b>æ³¨æ„è­¦è¨Šï¼š</b>ç¬¬1â€“2å‹åç¡¬å¯èƒ½ä¾¿ç¥•ï¼›ç¬¬6â€“7å‹åç¨€å±¬è…¹ç€‰ï¼Œè‹¥æŒçºŒå‡ºç¾å»ºè­°å°±é†«ã€‚</li><li><b>å¥åº·é »ç‡ï¼š</b>ä¸€é€±ç´„7æ¬¡ã€å½¢æ…‹å¤šåœ¨ç¬¬3â€“4å‹ï¼Œé€šå¸¸ä»£è¡¨è…¸é“åŠŸèƒ½ä½³ã€‚</li><li><b>é¡è‰²è§€å¯Ÿï¼š</b>é»ƒè¤/æ£•è‰²å¸¸è¦‹ï¼›è‹¥æŒçºŒé»‘ã€ç´…æˆ–ç°ç™½è‰²éœ€æé«˜è­¦è¦ºã€‚</li><li><b>ç”Ÿæ´»ç¿’æ…£ï¼š</b>å½¢ç‹€å—æ°´åˆ†èˆ‡çº–ç¶­å½±éŸ¿å¤§ï¼›è¦å¾‹é‹å‹•èˆ‡æ’ä¾¿ç¿’æ…£åŒæ¨£é‡è¦ã€‚</li><li><b>å¤œé–“å¦‚å»ï¼š</b>å¹´è¼•äººæ¯æ™š 0-1 æ¬¡å±¬æ­£å¸¸ï¼›å¹´é•·è€… 1-2 æ¬¡å°šå±¬æ™®éã€‚è‹¥é•·æœŸé«˜æ–¼ 2 æ¬¡ä¸”å½±éŸ¿ç¡çœ ï¼Œå»ºè­°è«®è©¢é†«å¸«ã€‚</li></ul>`;
Â  Â  }

Â  Â  function setupEventListeners() {
Â  Â  Â  DOM.logDate.addEventListener('change', e => { appState.currentDate = e.target.value; loadLogForDate(appState.currentDate); });
Â  Â  Â Â 
Â  Â  Â  DOM.bowelStatusOptions.addEventListener('click', e => {
Â  Â  Â  Â  Â  const button = e.target.closest('.option-button');
Â  Â  Â  Â  Â  if (button) {
Â  Â  Â  Â  Â  Â  Â  DOM.bowelStatusOptions.querySelectorAll('.option-button').forEach(btn => btn.classList.remove('selected'));
Â  Â  Â  Â  Â  Â  Â  button.classList.add('selected');
Â  Â  Â  Â  Â  Â  Â  toggleBowelSection(button.dataset.value === 'yes');
Â  Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  DOM.addBowelRecordBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  DOM.bowelRecordsContainer.insertAdjacentHTML('beforeend', createBowelFormHTML(getEmptyBowelRecord(), DOM.bowelRecordsContainer.children.length + 1));
Â  Â  Â  });
Â  Â  Â  DOM.bowelRecordsContainer.addEventListener('click', e => {
Â  Â  Â  Â  const t = e.target;
Â  Â  Â  Â  const bristolItem = t.closest('.bristol-item'); if (bristolItem) bristolItem.classList.toggle('bristol-selected');
Â  Â  Â  Â  const colorItem = t.closest('.color-item');Â 
Â  Â  Â  Â  if (colorItem) {Â 
Â  Â  Â  Â  Â  Â  const g = colorItem.closest('.color-options');Â 
Â  Â  Â  Â  Â  Â  g.querySelectorAll('.color-item').forEach(i => i.classList.remove('bristol-selected'));Â 
Â  Â  Â  Â  Â  Â  colorItem.classList.add('bristol-selected');
Â  Â  Â  Â  Â  Â  const colorName = colorItem.dataset.value;
Â  Â  Â  Â  Â  Â  const colorInfo = bowelColorData.find(c => c.name === colorName);
Â  Â  Â  Â  Â  Â  if (colorInfo) showColorInfoModal(colorInfo);
Â  Â  Â  Â  }
Â  Â  Â  Â  const optionButton = t.closest('.option-button'); if (optionButton) { const g = optionButton.closest('.option-button-group'); if (g.classList.contains('multi-select-group')) { if (optionButton.dataset.value === 'ç„¡') { g.querySelectorAll('.option-button').forEach(b => b.classList.remove('selected')); optionButton.classList.add('selected'); } else { const n = g.querySelector('[data-value="ç„¡"]'); if (n) n.classList.remove('selected'); optionButton.classList.toggle('selected'); } } else { g.querySelectorAll('.option-button').forEach(b => b.classList.remove('selected')); optionButton.classList.add('selected'); } }
Â  Â  Â  Â  const removeBtn = t.closest('.remove-bowel-record-btn');
Â  Â  Â  Â  if (removeBtn) {
Â  Â  Â  Â  Â  Â  showConfirmation('åˆªé™¤ç´€éŒ„', 'æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ç­†æ’ä¾¿ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚', () => {
Â  Â  Â  Â  Â  Â  Â  Â  removeBtn.closest('.bowel-record-form').remove();
Â  Â  Â  Â  Â  Â  Â  Â  DOM.bowelRecordsContainer.querySelectorAll('h4').forEach((h, i) => h.textContent = `ç¬¬ ${i + 1} ç­†ç´€éŒ„`);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  DOM.swallowingStatusOptions.addEventListener('click', e => {
Â  Â  Â  Â  const button = e.target.closest('.option-button');
Â  Â  Â  Â  if (button) {
Â  Â  Â  Â  Â  Â  DOM.swallowingStatusOptions.querySelectorAll('.option-button').forEach(btn => btn.classList.remove('selected'));
Â  Â  Â  Â  Â  Â  button.classList.add('selected');
Â  Â  Â  Â  Â  Â  toggleSwallowingSection(button.dataset.value === 'yes');
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  DOM.addSwallowingRecordBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  DOM.swallowingRecordsContainer.insertAdjacentHTML('beforeend', createSwallowingFormHTML(getEmptySwallowingRecord(), DOM.swallowingRecordsContainer.children.length + 1));
Â  Â  Â  });
Â  Â  Â  DOM.swallowingRecordsContainer.addEventListener('click', e => {
Â  Â  Â  Â  const removeBtn = e.target.closest('.remove-swallowing-record-btn');
Â  Â  Â  Â  if (removeBtn) {
Â  Â  Â  Â  Â  Â  showConfirmation('åˆªé™¤äº‹ä»¶', 'æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ç­†ååš¥äº‹ä»¶å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚', () => {
Â  Â  Â  Â  Â  Â  Â  Â  removeBtn.closest('.swallowing-record-form').remove();
Â  Â  Â  Â  Â  Â  Â  Â  DOM.swallowingRecordsContainer.querySelectorAll('h4').forEach((h, i) => h.textContent = `ç¬¬ ${i + 1} ç­†ååš¥äº‹ä»¶`);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  DOM.sleepQualityRating.addEventListener('click', e => { if (e.target.classList.contains('star')) updateStars(e.target.dataset.value); });
Â  Â  Â  DOM.nightToiletVisits.addEventListener('click', e => {
Â  Â  Â  Â  const button = e.target.closest('.option-button');
Â  Â  Â  Â  if (button) {
Â  Â  Â  Â  Â  DOM.nightToiletVisits.querySelectorAll('.option-button').forEach(btn => btn.classList.remove('selected'));
Â  Â  Â  Â  Â  button.classList.add('selected');
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  DOM.rbdSymptoms.addEventListener('change', () => { const o = DOM.rbdSymptoms.querySelector('#other'); updateRbdCheckboxStates(); DOM.rbdOtherNotes.classList.toggle('hidden', !o.checked); if (!o.checked) DOM.rbdOtherNotes.value = ''; });
Â  Â  Â  DOM.saveLogButton.addEventListener('click', () => saveLogForDate(appState.currentDate));
Â  Â  Â  DOM.navItems.forEach(item => item.addEventListener('click', () => { triggerHapticFeedback(30); navigateTo(item.dataset.page); }));
Â  Â  Â  DOM.historyList.addEventListener('click', e => { const b = e.target.closest('.edit-log-btn'); if (b) { appState.currentDate = b.dataset.date; DOM.logDate.value = appState.currentDate; loadLogForDate(appState.currentDate); navigateTo('log-page'); } });
Â  Â  Â  DOM.prevWeekBtn.addEventListener('click', () => { appState.statsWeekOffset++; updateCharts(); });
Â  Â  Â  DOM.nextWeekBtn.addEventListener('click', () => { if (appState.statsWeekOffset > 0) { appState.statsWeekOffset--; updateCharts(); } });
Â  Â  Â  DOM.exportCsvBtn.addEventListener('click', exportDataAsCsv);Â 
Â  Â  Â  DOM.importCsvBtn.addEventListener('click', () => DOM.importFileInput.click());
Â  Â  Â  DOM.importFileInput.addEventListener('change', importData);
Â  Â  Â  DOM.deleteAllDataBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  showConfirmation('åˆªé™¤å…¨éƒ¨è³‡æ–™', 'æ‚¨ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰æ—¥èªŒç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œå°‡ç„¡æ³•å¾©åŸï¼', () => {
Â  Â  Â  Â  Â  Â  Â  appState.dailyLogs = {};
Â  Â  Â  Â  Â  Â  Â  appState.commonMeds = [];
Â  Â  Â  Â  Â  Â  Â  saveData();
Â  Â  Â  Â  Â  Â  Â  renderHistoryList();
Â  Â  Â  Â  Â  Â  Â  populateWeekFilter();
Â  Â  Â  Â  Â  Â  Â  showToast('æ‰€æœ‰è³‡æ–™å·²æˆåŠŸåˆªé™¤ï¼', 'success');
Â  Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  Â  DOM.themeToggle.addEventListener('click', toggleTheme);
Â  Â  Â  DOM.modalCancelBtn.addEventListener('click', () => DOM.confirmationModal.classList.add('hidden'));
Â  Â  Â  DOM.colorModalCloseBtn.addEventListener('click', () => DOM.colorInfoModal.classList.add('hidden'));
Â  Â  Â  DOM.colorModalOkBtn.addEventListener('click', () => DOM.colorInfoModal.classList.add('hidden'));
Â  Â  Â  DOM.manageMedsBtn.addEventListener('click', openMedsModal);
Â  Â  Â  DOM.medsModalCloseBtn.addEventListener('click', () => DOM.medsModal.classList.add('hidden'));
Â  Â  Â  DOM.addMedBtn.addEventListener('click', addCommonMed);
Â  Â  Â  DOM.medsList.addEventListener('click', e => {Â 
Â  Â  Â  Â  Â  const deleteBtn = e.target.closest('.delete-med-btn');
Â  Â  Â  Â  Â  if(deleteBtn) {
Â  Â  Â  Â  Â  Â  Â  const medName = deleteBtn.dataset.med;
Â  Â  Â  Â  Â  Â  Â  showConfirmation('åˆªé™¤å¸¸ç”¨è—¥ç‰©', `æ‚¨ç¢ºå®šè¦åˆªé™¤ã€Œ${medName}ã€å—ï¼Ÿ`, () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  deleteCommonMed(medName);
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  DOM.clearMedsBtn.addEventListener('click', () => { DOM.medicationLog.value = ''; });
Â  Â  Â  DOM.commonMedsContainer.addEventListener('click', e => { if(e.target.classList.contains('common-med-btn')) addMedToLog(e.target.dataset.med); });
Â  Â  Â  DOM.weekFilter.addEventListener('change', e => renderHistoryList(e.target.value));
Â  Â  }

Â  Â  function setupGestureListeners() {
Â  Â  Â  Â  let touchStartX = 0; let touchEndX = 0; const swipeThreshold = 50;Â 
Â  Â  Â  Â  DOM.statsPage.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
Â  Â  Â  Â  DOM.statsPage.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; handleSwipe(); }, { passive: true });
Â  Â  Â  Â  function handleSwipe() {
Â  Â  Â  Â  Â  Â  const swipeDistance = touchEndX - startX;
Â  Â  Â  Â  Â  Â  if (Math.abs(swipeDistance) < swipeThreshold) return;Â 
Â  Â  Â  Â  Â  Â  if (swipeDistance > 0) { DOM.prevWeekBtn.click(); }Â 
Â  Â  Â  Â  Â  Â  else { if (!DOM.nextWeekBtn.disabled) { DOM.nextWeekBtn.click(); } }
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function navigateTo(pageId) {
Â  Â  Â  appState.currentPage = pageId;
Â  Â  Â  DOM.pages.forEach(p => p.classList.toggle('active', p.id === pageId));
Â  Â  Â  const titles = { 'log-page': 'ğŸ“ å¥åº·æ—¥èªŒ', 'stats-page': 'ğŸ“Š çµ±è¨ˆåœ–è¡¨', 'history-page': 'ğŸ“œ æ­·å²ç´€éŒ„' };
Â  Â  Â  DOM.headerTitle.textContent = titles[pageId] || 'å¥åº·æ—¥èªŒ';
Â  Â  Â  DOM.navItems.forEach(item => item.classList.toggle('active', item.dataset.page === pageId));
Â  Â  Â  if (pageId === 'history-page') { populateWeekFilter(); renderHistoryList(); updateLastBackupInfo(); }
Â  Â  Â  else if (pageId === 'stats-page') { appState.statsWeekOffset = 0; updateCharts(); }
Â  Â  Â  else if (pageId === 'log-page') { renderCommonMeds(); }
Â  Â  }
Â  Â  function updateStars(v) { DOM.sleepQualityRating.querySelectorAll('.star').forEach(s => s.classList.toggle('selected', Number(s.dataset.value) <= Number(v))); }
Â  Â  function updateRbdCheckboxStates() {
Â  Â  Â  const n = DOM.rbdSymptoms.querySelector('#none'), o = DOM.rbdSymptoms.querySelectorAll('input:not(#none)');
Â  Â  Â  if (n.checked) { o.forEach(c => { c.checked = false; c.disabled = true; }); }Â 
Â  Â  Â  else { const a = Array.from(o).some(c => c.checked); n.disabled = a; o.forEach(c => { c.disabled = false; }); }
Â  Â  }
Â  Â  function toggleBowelSection(show) {
Â  Â  Â  DOM.bowelRecordsSection.classList.toggle('hidden', !show);
Â  Â  Â  if (show && DOM.bowelRecordsContainer.children.length === 0) {
Â  Â  Â  Â  Â  renderBowelForms([]);
Â  Â  Â  }
Â  Â  }
Â  Â  function toggleSwallowingSection(show) {
Â  Â  Â  Â  DOM.swallowingDetailsSection.classList.toggle('hidden', !show);
Â  Â  Â  Â  if (show && DOM.swallowingRecordsContainer.children.length === 0) {
Â  Â  Â  Â  Â  Â  renderSwallowingForms([getEmptySwallowingRecord()]);
Â  Â  Â  Â  }
Â  Â  }
Â  Â  let toastTimer;
Â  Â  function showToast(message, type = 'error') {
Â  Â  Â  clearTimeout(toastTimer);
Â  Â  Â  const t = DOM.toast;
Â  Â  Â  t.textContent = message;
Â  Â  Â  const c = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
Â  Â  Â  t.className = 'px-6 py-3 rounded-full font-semibold text-white shadow-lg';
Â  Â  Â  t.classList.add(c[type], 'show');
Â  Â  Â  toastTimer = setTimeout(() => t.classList.remove('show'), 4000);
Â  Â  }
Â  Â  function showConfirmation(title, message, onConfirm) {
Â  Â  Â  Â  DOM.modalTitle.textContent = title;
Â  Â  Â  Â  DOM.modalMessage.textContent = message;
Â  Â  Â  Â  DOM.confirmationModal.classList.remove('hidden');
Â  Â  Â  Â  const confirmHandler = () => { onConfirm(); DOM.confirmationModal.classList.add('hidden'); };
Â  Â  Â  Â  DOM.modalConfirmBtn.replaceWith(DOM.modalConfirmBtn.cloneNode(true));
Â  Â  Â  Â  DOM.modalConfirmBtn = document.getElementById('modal-confirm-btn');
Â  Â  Â  Â  DOM.modalConfirmBtn.addEventListener('click', confirmHandler, { once: true });
Â  Â  }
Â  Â  function showColorInfoModal(colorInfo) {
Â  Â  Â  Â  DOM.colorModalTitle.textContent = colorInfo.infoTitle;
Â  Â  Â  Â  DOM.colorModalMessage.textContent = colorInfo.infoText;
Â  Â  Â  Â  DOM.colorInfoModal.classList.remove('hidden');
Â  Â  }

Â  Â  function setupTheme() {
Â  Â  Â  const savedTheme = localStorage.getItem('theme');
Â  Â  Â  const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
Â  Â  Â  if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
Â  Â  Â  Â  DOM.html.classList.add('dark'); DOM.themeIconSun.classList.remove('hidden');
Â  Â  Â  } else {
Â  Â  Â  Â  DOM.html.classList.remove('dark'); DOM.themeIconMoon.classList.remove('hidden');
Â  Â  Â  }
Â  Â  }
Â  Â  function toggleTheme() {
Â  Â  Â  const isDark = DOM.html.classList.toggle('dark');
Â  Â  Â  localStorage.setItem('theme', isDark ? 'dark' : 'light');
Â  Â  Â  DOM.themeIconSun.classList.toggle('hidden', !isDark);
Â  Â  Â  DOM.themeIconMoon.classList.toggle('hidden', isDark);
Â  Â  Â  if (appState.currentPage === 'stats-page') updateCharts();
Â  Â  }

Â  Â  function validateLogForm() {
Â  Â  Â  const missing = [];
Â  Â  Â  if (DOM.sleepQualityRating.querySelectorAll('.star.selected').length === 0) missing.push('æ˜¨æ™šç¡çœ å“è³ª');
Â  Â  Â  if (document.querySelector('#night-toilet-visits .selected') === null) missing.push('å¤œé–“å¦‚å»æ¬¡æ•¸');
Â  Â  Â  if (document.querySelectorAll('#rbd-symptoms input:checked').length === 0) missing.push('RBD ç—‡ç‹€');
Â  Â  Â Â 
Â  Â  Â  if (!DOM.bowelStatusOptions.querySelector('.selected')) missing.push('æ’ä¾¿ç‹€æ³');
Â  Â  Â  if (!DOM.swallowingStatusOptions.querySelector('.selected')) missing.push('ååš¥ç‹€æ³');

Â  Â  Â  if (missing.length > 0) { showToast(`è«‹å®Œæˆä»¥ä¸‹æ¬„ä½ï¼š${missing.join('ã€')}`, 'error'); return false; }
Â  Â  Â  return true;
Â  Â  }
Â  Â Â 
Â  Â  function formatCsvCell(value) {
Â  Â  Â  Â  const strValue = String(value).replace(/"/g, '""');
Â  Â  Â  Â  if (strValue.includes(',') || strValue.includes('"') || strValue.includes('\n')) return `"${strValue}"`;
Â  Â  Â  Â  return strValue;
Â  Â  }

Â  Â  function exportDataAsCsv() {
Â  Â  Â  Â  const headers = ['date', 'hadBowelMovement', 'bowelRecords', 'hadSwallowingEvent', 'swallowingRecords', 'sleep', 'nightToiletVisits', 'rbdSymptoms', 'rbdOther', 'meds', 'dailyNotes'];
Â  Â  Â  Â  const csvRows = [headers.join(',')];
Â  Â  Â  Â  const sortedDates = Object.keys(appState.dailyLogs).sort();
Â  Â  Â  Â  for (const date of sortedDates) {
Â  Â  Â  Â  Â  Â  const log = appState.dailyLogs[date];
Â  Â  Â  Â  Â  Â  const exportedVisits = (log.nightToiletVisits === -1 || log.nightToiletVisits == null) ? '' : log.nightToiletVisits;
Â  Â  Â  Â  Â  Â  const row = [
Â  Â  Â  Â  Â  Â  Â  Â  dayjs(date).format('YYYY/MM/DD'),
Â  Â  Â  Â  Â  Â  Â  Â  log.hadBowelMovement,
Â  Â  Â  Â  Â  Â  Â  Â  JSON.stringify(log.bowel || []),
Â  Â  Â  Â  Â  Â  Â  Â  log.hadSwallowingEvent,
Â  Â  Â  Â  Â  Â  Â  Â  JSON.stringify(log.swallowing || []),
Â  Â  Â  Â  Â  Â  Â  Â  log.sleep || 0,
Â  Â  Â  Â  Â  Â  Â  Â  exportedVisits,
Â  Â  Â  Â  Â  Â  Â  Â  JSON.stringify(log.rbd ? log.rbd.symptoms : []),
Â  Â  Â  Â  Â  Â  Â  Â  log.rbd ? log.rbd.other : '',
Â  Â  Â  Â  Â  Â  Â  Â  log.meds || '',
Â  Â  Â  Â  Â  Â  Â  Â  log.dailyNotes || ''
Â  Â  Â  Â  Â  Â  ].map(formatCsvCell).join(',');
Â  Â  Â  Â  Â  Â  csvRows.push(row);
Â  Â  Â  Â  }
Â  Â  Â  Â  const csvString = csvRows.join('\n');
Â  Â  Â  Â  const blob = new Blob([`\uFEFF${csvString}`], { type: 'text/csv;charset=utf-8;' });
Â  Â  Â  Â  const fileName = `health_log_${dayjs().format('YYYYMMDD_HHmmss')}.csv`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  link.setAttribute('href', url);
Â  Â  Â  Â  link.setAttribute('download', fileName);
Â  Â  Â  Â  link.style.visibility = 'hidden';
Â  Â  Â  Â  document.body.appendChild(link);
Â  Â  Â  Â  link.click();
Â  Â  Â  Â  document.body.removeChild(link);
Â  Â  Â  Â  showToast('è³‡æ–™å·²é–‹å§‹ä¸‹è¼‰ï¼', 'success');
Â  Â  }

Â  Â  function importData(event) {
Â  Â  Â  Â  const file = event.target.files[0]; if (!file) return;
Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onload = (e) => {
Â  Â  Â  Â  Â  Â  function parseCSV(csvString) {
Â  Â  Â  Â  Â  Â  Â  Â  const rows = []; let currentRow = []; let currentField = ''; let inQuotes = false;
Â  Â  Â  Â  Â  Â  Â  Â  const cleanedString = csvString.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < cleanedString.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const char = cleanedString[i];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (inQuotes) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (char === '"' && (i + 1 === cleanedString.length || cleanedString[i + 1] !== '"')) { inQuotes = false; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (char === '"' && cleanedString[i + 1] === '"') { currentField += '"'; i++; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else { currentField += char; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (char === '"') { inQuotes = true; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (char === ',') { currentRow.push(currentField); currentField = ''; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (char === '\n') { currentRow.push(currentField); rows.push(currentRow); currentRow = []; currentField = ''; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else { currentField += char; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (currentField || currentRow.length > 0) { currentRow.push(currentField); rows.push(currentRow); }
Â  Â  Â  Â  Â  Â  Â  Â  return rows.filter(row => row.length > 1 || (row.length === 1 && row[0] !== ''));
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const rows = parseCSV(e.target.result);
Â  Â  Â  Â  Â  Â  if (rows.length < 2) { showToast('CSV æª”æ¡ˆç‚ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¢ºã€‚', 'error'); return; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const headers = rows.shift().map(cleanInvisible);
Â  Â  Â  Â  Â  Â  const requiredHeaders = ['date'];
Â  Â  Â  Â  Â  Â  if (!requiredHeaders.every(h => headers.includes(h))) { showToast('CSV æª”æ¡ˆç¼ºå°‘å¿…è¦çš„ "date" æ¬„ä½ã€‚', 'error'); return; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const importedLogs = {}; let errorCount = 0;
Â  Â  Â  Â  Â  Â  rows.forEach((values, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const rowData = headers.reduce((obj, h, i) => ({...obj, [h]: values[i] || ''}), {});
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dateString = rowData.date.trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!dateString) throw new Error(`ç¬¬ ${index + 2} è¡Œæ—¥æœŸç‚ºç©ºã€‚`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const parsedDate = dayjs(dateString, ['YYYY/MM/DD', 'YYYY-MM-DD', 'YYYY/M/D'], true);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!parsedDate.isValid()) throw new Error(`æ—¥æœŸæ ¼å¼ç„¡æ•ˆ: "${dateString}"`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const date = parsedDate.format('YYYY-MM-DD');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const visits = parseInt(rowData.nightToiletVisits, 10);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  importedLogs[date] = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hadBowelMovement: rowData.hadBowelMovement === 'true',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bowel: JSON.parse(rowData.bowelRecords || '[]'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hadSwallowingEvent: rowData.hadSwallowingEvent === 'true',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  swallowing: JSON.parse(rowData.swallowingRecords || '[]'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sleep: parseInt(rowData.sleep, 10) || 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nightToiletVisits: isNaN(visits) ? -1 : visits,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rbd: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  symptoms: JSON.parse(rowData.rbdSymptoms || '[]'),Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  other: rowData.rbdOther || ''Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  meds: rowData.meds || '',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dailyNotes: rowData.dailyNotes || ''
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  } catch (err) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorCount++;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error(`ç„¡æ³•è§£æç¬¬ ${index + 2} è¡Œ:`, err, "Row data:", values);Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if(errorCount > 0) showToast(`åŒ¯å…¥å®Œæˆï¼Œä½†æœ‰ ${errorCount} è¡Œè³‡æ–™è§£æå¤±æ•—ã€‚è«‹æª¢æŸ¥æ§åˆ¶å°ã€‚`, 'error');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  showConfirmation('åŒ¯å…¥è³‡æ–™', `æˆåŠŸè§£æ ${Object.keys(importedLogs).length} ç­†ç´€éŒ„ã€‚ç¢ºå®šè¦åŒ¯å…¥ä¸¦è¦†è“‹ç¾æœ‰è³‡æ–™å—ï¼Ÿ`, () => {
Â  Â  Â  Â  Â  Â  Â  Â  Object.assign(appState.dailyLogs, importedLogs);
Â  Â  Â  Â  Â  Â  Â  Â  saveData();
Â  Â  Â  Â  Â  Â  Â  Â  showToast('è³‡æ–™åŒ¯å…¥æˆåŠŸï¼', 'success');
Â  Â  Â  Â  Â  Â  Â  Â  if (appState.currentPage === 'history-page') { populateWeekFilter(); renderHistoryList(); }
Â  Â  Â  Â  Â  Â  Â  Â  loadLogForDate(appState.currentDate);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };
Â  Â  Â  Â  reader.onerror = () => showToast('ç„¡æ³•è®€å–æª”æ¡ˆã€‚', 'error');
Â  Â  Â  Â  reader.readAsText(file);
Â  Â  Â  Â  event.target.value = '';
Â  Â  }
Â  Â Â 
Â  Â  // Medication Management Functions
Â  Â  function openMedsModal() {
Â  Â  Â  Â  renderMedsList();
Â  Â  Â  Â  DOM.medsModal.classList.remove('hidden');
Â  Â  Â  Â  DOM.newMedInput.focus();
Â  Â  }

Â  Â  function renderMedsList() {
Â  Â  Â  Â  DOM.medsList.innerHTML = appState.commonMeds.map(med => `
Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center p-2 bg-slate-100 dark:bg-slate-700 rounded-md">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-slate-800 dark:text-slate-200">${med}</span>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="delete-med-btn text-red-500 hover:text-red-700 text-xs" data-med="${med}">åˆªé™¤</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `).join('');
Â  Â  }

Â  Â  function addCommonMed() {
Â  Â  Â  Â  const medName = DOM.newMedInput.value.trim();
Â  Â  Â  Â  if (medName && !appState.commonMeds.includes(medName)) {
Â  Â  Â  Â  Â  Â  appState.commonMeds.push(medName);
Â  Â  Â  Â  Â  Â  saveData();
Â  Â  Â  Â  Â  Â  renderMedsList();
Â  Â  Â  Â  Â  Â  renderCommonMeds();
Â  Â  Â  Â  Â  Â  DOM.newMedInput.value = '';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function deleteCommonMed(medName) {
Â  Â  Â  Â  appState.commonMeds = appState.commonMeds.filter(med => med !== medName);
Â  Â  Â  Â  saveData();
Â  Â  Â  Â  renderMedsList();
Â  Â  Â  Â  renderCommonMeds();
Â  Â  }
Â  Â Â 
Â  Â  function renderCommonMeds() {
Â  Â  Â  Â  DOM.commonMedsContainer.innerHTML = appState.commonMeds.map(med =>Â 
Â  Â  Â  Â  Â  Â  `<button class="common-med-btn text-xs py-1 px-3 rounded-full bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200" data-med="${med}">${med}</button>`
Â  Â  Â  Â  ).join('');
Â  Â  }
Â  Â Â 
Â  Â  function addMedToLog(medName) {
Â  Â  Â  Â  const currentLog = DOM.medicationLog.value;
Â  Â  Â  Â  const separator = currentLog.length > 0 && !/\s$/.test(currentLog) ? ', ' : '';
Â  Â  Â  Â  DOM.medicationLog.value += separator + medName;
Â  Â  Â  Â  DOM.medicationLog.focus();
Â  Â  }

Â  Â  // Week Filter Functions
Â  Â  function populateWeekFilter() {
Â  Â  Â  Â  const weeks = new Set();
Â  Â  Â  Â  Object.keys(appState.dailyLogs).forEach(date => {
Â  Â  Â  Â  Â  Â  const d = dayjs(date);
Â  Â  Â  Â  Â  Â  weeks.add(`${d.year()}-${d.week()}`);
Â  Â  Â  Â  });

Â  Â  Â  Â  const sortedWeeks = Array.from(weeks).sort((a, b) => b.localeCompare(a));
Â  Â  Â  Â Â 
Â  Â  Â  Â  DOM.weekFilter.innerHTML = '<option value="all">å…¨éƒ¨ç´€éŒ„</option>';
Â  Â  Â  Â  sortedWeeks.forEach(weekStr => {
Â  Â  Â  Â  Â  Â  const [year, week] = weekStr.split('-');
Â  Â  Â  Â  Â  Â  const weekStart = dayjs().year(year).week(week).startOf('week').format('MM/DD');
Â  Â  Â  Â  Â  Â  const weekEnd = dayjs().year(year).week(week).endOf('week').format('MM/DD');
Â  Â  Â  Â  Â  Â  DOM.weekFilter.innerHTML += `<option value="${weekStr}">${year}å¹´ (${weekStart} - ${weekEnd})</option>`;
Â  Â  Â  Â  });
Â  Â  }

Â  Â  init();
Â  });
Â  </script>
</body>
</html>
