<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>å¥åº·æ—¥èªŒ</title>
  
  <!-- PWA Manifest and Theme Color -->
  <meta name="theme-color" content="#f8fafc"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="å¥åº·æ—¥èªŒ">
  <link rel="apple-touch-icon" href="https://placehold.co/192x192/3B82F6/FFFFFF?text=æ—¥èªŒ">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs/plugin/relativeTime.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs/plugin/customParseFormat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs/plugin/weekOfYear.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs/locale/zh-tw.js"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
  <style>
    :root { color-scheme: light; }
    html.dark { color-scheme: dark; }
    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    .page { display: none; animation: fadeIn 0.3s ease-in-out; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }

    .nav-item {
        border-bottom: 3px solid transparent;
        transition: all 0.2s ease-in-out;
    }
    .nav-item.active {
        border-bottom-color: #3B82F6;
    }
    .nav-item.active svg, .nav-item.active .nav-text {
        color: #3B82F6;
    }
    .nav-item.active .nav-text {
        font-weight: 600;
    }

    #toast-notification {
      position: fixed; top: -100px; left: 50%;
      transform: translateX(-50%);
      transition: top 0.4s ease-in-out, opacity 0.4s ease-in-out;
      opacity: 0;
      z-index: 9999;
    }
    #toast-notification.show { top: 20px; opacity: 1; }

    .bristol-item, .color-item { transition: all 0.2s ease-in-out; }
    .bristol-item.bristol-selected {
      border-color: #3B82F6; background-color: #EFF6FF; transform: scale(1.05);
    }
    .color-item.bristol-selected {
        border-color: #3B82F6; background-color: #EFF6FF;
    }
    html.dark .bristol-item.bristol-selected {
      background-color: #0b3a75; border-color: #60a5fa;
    }
     html.dark .color-item.bristol-selected {
      background-color: #0b3a75; border-color: #60a5fa;
    }

    .star-rating .star { color: #d1d5db; cursor: pointer; transition: color 0.2s; }
    .star-rating .star:hover, .star-rating .star.selected { color: #f59e0b; }

    .custom-radio:checked {
      background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3ccircle cx='8' cy='8' r='3'/%3e%3c/svg%3e");
      background-color: #3B82F6;
      border-color: #3B82F6;
    }

    .option-button-group .option-button { transition: all 0.2s ease-in-out; }
    .option-button-group .option-button.selected { background-color: #3B82F6; color: white; border-color: #3B82F6; }

    .modal.hidden { display: none; }

    .form-section { border-top-width: 1px; padding-top: 10px; margin-top: 10px; }
    .form-section-label { display: inline-flex; align-items: center; gap: 6px; font-weight: 600; font-size: 0.9rem; }
    .form-section-label svg { width: 16px; height: 16px; }

    button:focus-visible, .option-button:focus-visible, .bristol-item:focus-visible, .color-item:focus-visible {
      outline: 2px solid #3B82F6; outline-offset: 2px;
    }

    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .spinner { animation: spin 1s linear infinite; }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 9999px;
        font-size: 11px;
        font-weight: 600;
    }
    .status-badge-green { background-color: #D1FAE5; color: #065F46; }
    .status-badge-orange { background-color: #FFEDD5; color: #9A3412; }
    .status-badge-blue { background-color: #DBEAFE; color: #1E40AF; }
    
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        border: 2px dashed #d1d5db;
        border-radius: 12px;
        color: #6b7280;
    }
    html.dark .empty-state {
        border-color: #4b5563;
        color: #9ca3af;
    }
    .empty-state svg {
        margin: 0 auto 12px;
    }
  </style>
</head>
<body class="bg-slate-100 dark:bg-slate-950 transition-colors duration-300">
  <div id="app" class="max-w-lg mx-auto bg-slate-50 dark:bg-slate-900 min-h-screen shadow-lg relative transition-colors duration-300 overflow-x-hidden">
    <header id="app-header" class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm sticky top-0 z-10 shadow-sm transition-colors duration-300">
      <div id="app-header-top" class="text-slate-800 dark:text-slate-200 p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
        <div class="w-10 h-10"></div> <!-- Placeholder for alignment -->
        <h1 id="header-title" class="text-xl font-bold tracking-wide text-center">å¥åº·æ—¥èªŒ</h1>
        <button id="theme-toggle" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors" aria-label="åˆ‡æ›ä¸»é¡Œ">
          <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
          <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        </button>
      </div>
      <nav id="app-nav" class="border-b border-slate-200 dark:border-slate-700 flex justify-around">
        <button class="nav-item flex flex-col items-center justify-center w-full text-slate-500 dark:text-slate-400 py-2" data-page="log-page" aria-label="å‰å¾€æ—¥èªŒ">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
          <span class="nav-text text-xs mt-1">æ—¥èªŒ</span>
        </button>
        <button class="nav-item flex flex-col items-center justify-center w-full text-slate-500 dark:text-slate-400 py-2" data-page="stats-page" aria-label="å‰å¾€çµ±è¨ˆ">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="m19 9-5 5-4-4-3 3"></path></svg>
          <span class="nav-text text-xs mt-1">çµ±è¨ˆ</span>
        </button>
        <button class="nav-item flex flex-col items-center justify-center w-full text-slate-500 dark:text-slate-400 py-2" data-page="history-page" aria-label="å‰å¾€æ­·å²">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          <span class="nav-text text-xs mt-1">æ­·å²</span>
        </button>
      </nav>
    </header>

    <div id="toast-notification" class="px-6 py-3 rounded-full font-semibold text-white shadow-lg"></div>

    <main class="p-4">
      <!-- ========= æ—¥èªŒé é¢ ========= -->
      <div id="log-page" class="page active">
        <div class="space-y-6">
          <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm">
            <label for="log-date" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">ğŸ—“ï¸ ç´€éŒ„æ—¥æœŸ</label>
            <input type="date" id="log-date" class="w-full p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-200 rounded-md focus:ring-2 focus:ring-blue-500"/>
          </section>

          <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-4 text-slate-800 dark:text-slate-200">
            <h2 class="text-lg font-semibold">ğŸ’© æ’ä¾¿ç´€éŒ„</h2>
            <div id="bowel-status-options" class="option-button-group flex gap-2">
                <button type="button" class="option-button w-full py-2" data-value="yes">ä»Šå¤©æœ‰æ’ä¾¿</button>
                <button type="button" class="option-button w-full py-2" data-value="no">ä»Šå¤©ç„¡æ’ä¾¿</button>
            </div>
            <div id="bowel-records-section" class="hidden">
                <div id="bowel-records-container" class="space-y-5 mt-4"></div>
                <button id="add-bowel-record-btn" class="w-full mt-2 text-blue-600 font-semibold py-2 px-4 rounded-lg border-2 border-dashed border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/50 transition flex items-center justify-center">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" class="mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                  æ–°å¢ä¸€ç­†æ’ä¾¿ç´€éŒ„
                </button>
            </div>
          </section>

          <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm text-slate-800 dark:text-slate-200">
            <h3 class="text-base font-semibold mb-2">ğŸ˜´ æ˜¨æ™šç¡çœ å“è³ª</h3>
            <div id="sleep-quality-rating" class="star-rating flex items-center justify-center space-x-2 text-4xl"></div>
          </section>

          <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm text-slate-800 dark:text-slate-200">
            <h3 class="text-base font-semibold mb-2">ğŸš½ æ˜¨æ™šèµ·åºŠå¦‚å»æ¬¡æ•¸</h3>
            <div id="night-toilet-visits" class="option-button-group flex flex-wrap gap-2 justify-center">
              <!-- Buttons 0-5 will be generated by JS -->
            </div>
          </section>

          <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm text-slate-800 dark:text-slate-200">
            <h3 class="text-base font-semibold mb-2">ğŸƒâ€â™‚ï¸ RBD ç—‡ç‹€ (æ˜¨æ™š)</h3>
            <div id="rbd-symptoms" class="space-y-2"></div>
            <textarea id="rbd-other-notes" rows="2" class="w-full mt-2 p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md hidden" placeholder="è«‹æè¿°å…¶ä»–ç—‡ç‹€"></textarea>
          </section>

          <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm text-slate-800 dark:text-slate-200">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-base font-semibold">ğŸ’Š ç”¨è—¥ç´€éŒ„</h3>
                <button id="clear-meds-btn" class="text-xs text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">æ¸…é™¤</button>
            </div>
            <textarea id="medication-log" rows="3" class="w-full p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md" placeholder="è«‹è¨˜éŒ„æ‚¨ä»Šå¤©æœç”¨çš„è—¥ç‰©ã€æ™‚é–“å’ŒåŠ‘é‡ã€‚"></textarea>
            <div id="common-meds-container" class="flex flex-wrap gap-2 mt-2"></div>
          </section>

          <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm text-slate-800 dark:text-slate-200">
            <h3 class="text-base font-semibold mb-2">ğŸ“ æ¯æ—¥å‚™è¨»</h3>
            <textarea id="daily-notes" rows="3" class="w-full p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md" placeholder="è¨˜éŒ„ä»»ä½•å…¶ä»–æƒ³è¨˜ä¸‹çš„äº‹æƒ…..."></textarea>
          </section>

          <button id="save-log-button" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform active:scale-95 flex items-center justify-center text-lg">
            <span id="save-log-button-content">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="mr-2 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
              å„²å­˜æœ¬æ—¥å®Œæ•´æ—¥èªŒ
            </span>
          </button>
        </div>
      </div>

      <!-- ========= çµ±è¨ˆé  ========= -->
      <div id="stats-page" class="page space-y-6">
        <div class="flex justify-between items-center bg-white dark:bg-slate-800 p-3 rounded-xl shadow-sm">
          <button id="prev-week-btn" class="px-3 py-2 rounded-md bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-800 dark:text-slate-200 transition-colors">&lt; ä¸Šä¸€é€±</button>
          <h2 id="stats-week-title" class="text-lg font-semibold text-slate-800 dark:text-slate-200 text-center">æœ¬é€±çµ±è¨ˆ</h2>
          <button id="next-week-btn" class="px-3 py-2 rounded-md bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-800 dark:text-slate-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>ä¸‹ä¸€é€± &gt;</button>
        </div>
        <div id="stats-content" class="space-y-6">
            <!-- Charts and analysis will be rendered here -->
        </div>
      </div>

      <!-- ========= æ­·å²é  ========= -->
      <div id="history-page" class="page">
        <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm text-slate-800 dark:text-slate-200">
          <h2 class="text-lg font-semibold mb-4">ğŸ—‚ï¸ è³‡æ–™ç®¡ç†</h2>
          <p id="last-backup-info" class="text-xs text-center text-slate-500 dark:text-slate-400 mb-4"></p>
          <div class="space-y-2 mb-4">
            <button id="manage-meds-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" class="mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
              ç®¡ç†å¸¸ç”¨è—¥ç‰©
            </button>
            <div class="grid grid-cols-2 gap-2">
                <button id="import-csv-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" class="mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    åŒ¯å…¥ CSV
                </button>
                <button id="export-csv-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" class="mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    åŒ¯å‡ºç‚º CSV
                </button>
            </div>
          </div>
          <input type="file" id="import-file-input" class="hidden" accept=".csv, text/csv"/>
          <div class="flex justify-between items-center mb-4 mt-6">
            <h2 class="text-lg font-semibold">ğŸ“œ æ‰€æœ‰æ—¥èªŒç´€éŒ„</h2>
            <select id="week-filter" class="text-sm p-1 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md"></select>
          </div>
          <div id="history-list" class="space-y-3"></div>
        </section>
      </div>
    </main>

    <!-- Modals -->
    <div id="confirmation-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
      <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 max-w-sm w-full">
        <h3 id="modal-title" class="text-lg font-bold text-slate-800 dark:text-slate-200 mb-2"></h3>
        <p id="modal-message" class="text-sm text-slate-600 dark:text-slate-400 mb-6"></p>
        <div class="flex justify-end space-x-3">
          <button id="modal-cancel-btn" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 text-slate-800 dark:text-slate-200 rounded-md">å–æ¶ˆ</button>
          <button id="modal-confirm-btn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md">ç¢ºå®š</button>
        </div>
      </div>
    </div>
    
    <div id="color-info-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
      <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 max-w-sm w-full">
        <div class="flex justify-between items-center mb-2">
            <h3 id="color-modal-title" class="text-lg font-bold text-slate-800 dark:text-slate-200"></h3>
            <button id="color-modal-close-btn" class="text-slate-400 hover:text-slate-600">&times;</button>
        </div>
        <p id="color-modal-message" class="text-sm text-slate-600 dark:text-slate-400 mb-6"></p>
        <div class="flex justify-end">
          <button id="color-modal-ok-btn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md">æˆ‘çŸ¥é“äº†</button>
        </div>
      </div>
    </div>

    <div id="meds-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
      <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 max-w-sm w-full">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-slate-800 dark:text-slate-200">ç®¡ç†å¸¸ç”¨è—¥ç‰©</h3>
            <button id="meds-modal-close-btn" class="text-slate-400 hover:text-slate-600">&times;</button>
        </div>
        <div class="flex gap-2 mb-4">
            <input type="text" id="new-med-input" class="flex-grow p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md" placeholder="è¼¸å…¥è—¥ç‰©åç¨±">
            <button id="add-med-btn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md">æ–°å¢</button>
        </div>
        <div id="meds-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
      </div>
    </div>

  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    dayjs.extend(dayjs_plugin_relativeTime);
    dayjs.extend(dayjs_plugin_customParseFormat);
    dayjs.extend(dayjs_plugin_weekOfYear);
    dayjs.locale('zh-tw');

    function cleanInvisible(str) {
      if (str === null || str === undefined) return '';
      return String(str).replace(/\uFEFF/g, '').replace(/\r/g, '').replace(/\u200B/g, '').trim();
    }
    
    function triggerHapticFeedback(ms = 50) {
        if (navigator.vibrate) {
            navigator.vibrate(ms);
        }
    }

    const bristolData = [
      { type: 1, d: "ä¸€é¡†é¡†åˆ†é–‹çš„å …æœå‹", svg: `<g fill="#754C24"><circle cx="8" cy="11" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="16" cy="11" r="2"/><circle cx="10" cy="7" r="2"/><circle cx="14" cy="7" r="2"/><path d="M9 11.5 a1 .5 0 0 0 2 0 a1 .5 0 0 0-2 0 M15 11.5 a1 .5 0 0 0 2 0 a1 .5 0 0 0-2 0 M11 7.5 a1 .5 0 0 0 2 0 a1 .5 0 0 0-2 0"/></g>`},
      { type: 2, d: "è¡¨é¢å‡¹å‡¸çš„é¦™è…¸å‹", svg: `<g fill="#8C5A3C"><path d="M6 13 C 6 9, 18 9, 18 13 S 17 15, 12 15 S 6 17, 6 13 Z"/><circle cx="8" cy="11" r="1.5"/><circle cx="11" cy="10.5" r="1.5"/><circle cx="14" cy="11" r="1.5"/><circle cx="16" cy="12.5" r="1.5"/><path d="M11 13.5 a1 .5 0 0 0 2 0 a1 .5 0 0 0-2 0"/></g>`},
      { type: 3, d: "è¡¨é¢æœ‰è£‚ç—•çš„é¦™è…¸å‹", svg: `<g fill="#A66D4A" stroke="#8C5A3C" stroke-width="0.5"><path d="M5 12 C 5 9, 19 9, 19 12 S 18 14, 12 14 S 5 15, 5 12 Z"/><path d="M8 10 l 1 3 M12 10 l 1 3 M16 10 l 1 3"/><path d="M11 12.5 a1 .5 0 0 0 2 0 a1 .5 0 0 0-2 0"/></g>`},
      { type: 4, d: "å…‰æ»‘ä¸”æŸ”è»Ÿçš„é¦™è…¸/è›‡å‹", svg: `<g fill="#C07E56"><path d="M5 12 C 5 9, 19 9, 19 12 S 18 14, 12 14 S 5 15, 5 12 Z"/><path d="M11 12.5 a1 .5 0 0 1 2 0 a1 .5 0 0 1-2 0"/></g>`},
      { type: 5, d: "æ–·é¢å…‰æ»‘çš„æŸ”è»Ÿå¡Šç‹€", svg: `<g fill="#D98F61"><circle cx="8" cy="12" r="3"/><circle cx="13" cy="13" r="3"/><circle cx="17" cy="11" r="3"/><path d="M7.5 12.5 a1 .5 0 0 1 2 0 a1 .5 0 0 1-2 0 M12.5 13.5 a1 .5 0 0 1 2 0 a1 .5 0 0 1-2 0"/></g>`},
      { type: 6, d: "é¬†è»Ÿã€é‚Šç·£ç ´ç¢çš„ç³Šç‹€", svg: `<g fill="#E6A06D"><path d="M6 12 C 6 8, 10 7, 12 9 C 14 11, 18 10, 18 12 S 14 15, 12 14 C 10 13, 6 16, 6 12 Z"/><path d="M11 12.5 a1 .5 0 0 0 2 0 a1 .5 0 0 0-2 0"/></g>`},
      { type: 7, d: "æ²’æœ‰å›ºé«”ã€å®Œå…¨å‘ˆæ¶²é«”ç‹€", svg: `<g fill="#F2B178"><path d="M5 13 C 5 10, 19 10, 19 13 S 15 16, 12 15 S 5 16, 5 13 Z"/><path d="M11 13.5 a1 .5 0 0 0 2 0 a1 .5 0 0 0-2 0"/></g>`}
    ];
    const bowelColorData = [
      { name: 'å•¡è‰²', colorHex: '#7B4F34', infoTitle: 'âœ… å¥åº·ã€æ­£å¸¸', infoText: 'æ­å–œï¼é€™æ˜¯æœ€å¥åº·çš„é¡è‰²ï¼Œè¡¨ç¤ºè†½æ±åˆ†æ³Œæ­£å¸¸ï¼Œæ¶ˆåŒ–ç³»çµ±é‹ä½œè‰¯å¥½ã€‚' }, 
      { name: 'é»ƒè‰²', colorHex: '#DAA520', infoTitle: 'âœ… å¥åº·ã€æ­£å¸¸', infoText: 'é€™ä¹Ÿæ˜¯å¥åº·çš„é¡è‰²ï¼Œå¯èƒ½èˆ‡é£²é£Ÿä¸­è„‚è‚ªå«é‡è¼ƒé«˜æœ‰é—œï¼Œé€šå¸¸ç„¡éœ€æ“”å¿ƒã€‚' },
      { name: 'ç¶ è‰²', colorHex: '#5A6335', infoTitle: 'ğŸ’¡ é€šå¸¸æ­£å¸¸', infoText: 'åˆ¥æ“”å¿ƒï¼Œé€šå¸¸æ˜¯åƒäº†è¼ƒå¤šæ·±ç¶ è‰²è”¬èœï¼Œæˆ–æ˜¯é£Ÿç‰©æ¶ˆåŒ–é€Ÿåº¦è¼ƒå¿«ï¼Œè†½æ±ä¾†ä¸åŠåˆ†è§£æ‰€è‡´ã€‚' }, 
      { name: 'ç´…è‰²', colorHex: '#9E2B25', infoTitle: 'âš ï¸ è«‹ç•™æ„', infoText: 'å¯èƒ½æ˜¯é£Ÿç‰©ï¼ˆå¦‚ç«é¾æœã€ç”œèœæ ¹ï¼‰é€ æˆçš„ï¼Œä½†ä¹Ÿå¯èƒ½æ˜¯ä¸‹æ¶ˆåŒ–é“å‡ºè¡€çš„è­¦è¨Šï¼Œéœ€æŒçºŒè§€å¯Ÿã€‚' },
      { name: 'é»‘è‰²', colorHex: '#1E1E1E', infoTitle: 'âš ï¸ è¦æ³¨æ„', infoText: 'å¯èƒ½æ˜¯åƒäº†éµåŠ‘ã€å«å¢¨é­šæ±çš„é£Ÿç‰©ï¼Œä½†ä¹Ÿå¯èƒ½æ˜¯ä¸Šæ¶ˆåŒ–é“å‡ºè¡€çš„å¾µå…†ï¼Œå»ºè­°æé«˜è­¦è¦ºã€‚' }, 
      { name: 'ç°ç™½è‰²', colorHex: '#A9A9A9', infoTitle: 'ğŸš¨ éœ€è¦è­¦è¦º', infoText: 'é€™å¯èƒ½ä»£è¡¨è†½æ±åˆ†æ³Œä¸è¶³æˆ–è†½ç®¡é˜»å¡ï¼Œæ˜¯è¼ƒå±éšªçš„ä¿¡è™Ÿï¼Œå»ºè­°è«®è©¢é†«å¸«ã€‚' }
    ];
    const bowelVolumes = ['å°‘é‡', 'ä¸­ç­‰', 'å¤§é‡'];
    const bowelDurations = ['10åˆ†é˜ä»¥ä¸Š', '3-10åˆ†é˜', '1-3åˆ†é˜'];
    const bowelSymptoms = ['ç„¡', 'è‚šå­ç—›', 'èƒƒè„¹æ°£', 'å±çœ¼åœ¨ç‡’', 'è…¸çµç—›', 'è‚›é–€ç—›', 'è£¡æ€¥å¾Œé‡', 'ä¾¿æ„ç›ç„¶'];
    const bowelAdditionalStatus = ['ç„¡', 'æ€µç›®è¡€è·¡', 'ä¾¿ä¸­æœ‰é»æ¶²', 'å¤§ä¾¿æƒ¡è‡­çƒ˜çƒ˜', 'å¤§ä¾¿é»ç¨ ', 'å¤§ä¾¿ç´°å¦‚ç­†', 'æ¶ˆåŒ–ä¸è‰¯'];
    const rbdSymptomsList = [
      { id: 'none', label: 'ç„¡ç—‡ç‹€' }, { id: 'shouting', label: 'å¤§è²å«å–Š' },
      { id: 'movement', label: 'è‚¢é«”å‹•ä½œ' }, { id: 'vivid-dreams', label: 'ç”Ÿå‹•å¤¢å¢ƒ' },
      { id: 'sleep-talking', label: 'æ¿€å‹•å¤¢è©±' }, { id: 'self-injury', label: 'ä½¿è‡ªå·±å—å‚·' },
      { id: 'partner-injury', label: 'ä½¿ä¼´ä¾¶å—å‚·' }, { id: 'other', label: 'å…¶ä»–' }
    ];

    let appState = {
      dailyLogs: {},
      commonMeds: [],
      lastBackupDate: null,
      currentDate: dayjs().format('YYYY-MM-DD'),
      currentPage: 'log-page',
      charts: { bowel: null, rbd: null, bowelTime: null, sleep: null, nightToilet: null },
      statsWeekOffset: 0,
    };

    const DOM = {
      html: document.documentElement,
      headerTitle: document.getElementById('header-title'),
      pages: document.querySelectorAll('.page'),
      navItems: document.querySelectorAll('.nav-item'),
      toast: document.getElementById('toast-notification'),
      logDate: document.getElementById('log-date'),
      bowelStatusOptions: document.getElementById('bowel-status-options'),
      bowelRecordsSection: document.getElementById('bowel-records-section'),
      bowelRecordsContainer: document.getElementById('bowel-records-container'),
      addBowelRecordBtn: document.getElementById('add-bowel-record-btn'),
      sleepQualityRating: document.getElementById('sleep-quality-rating'),
      nightToiletVisits: document.getElementById('night-toilet-visits'),
      rbdSymptoms: document.getElementById('rbd-symptoms'),
      rbdOtherNotes: document.getElementById('rbd-other-notes'),
      medicationLog: document.getElementById('medication-log'),
      clearMedsBtn: document.getElementById('clear-meds-btn'),
      commonMedsContainer: document.getElementById('common-meds-container'),
      dailyNotes: document.getElementById('daily-notes'),
      saveLogButton: document.getElementById('save-log-button'),
      saveLogButtonContent: document.getElementById('save-log-button-content'),
      statsPage: document.getElementById('stats-page'),
      statsContent: document.getElementById('stats-content'),
      historyList: document.getElementById('history-list'),
      weekFilter: document.getElementById('week-filter'),
      lastBackupInfo: document.getElementById('last-backup-info'),
      statsWeekTitle: document.getElementById('stats-week-title'),
      prevWeekBtn: document.getElementById('prev-week-btn'),
      nextWeekBtn: document.getElementById('next-week-btn'),
      exportCsvBtn: document.getElementById('export-csv-btn'),
      importCsvBtn: document.getElementById('import-csv-btn'),
      importFileInput: document.getElementById('import-file-input'),
      confirmationModal: document.getElementById('confirmation-modal'),
      modalTitle: document.getElementById('modal-title'),
      modalMessage: document.getElementById('modal-message'),
      modalCancelBtn: document.getElementById('modal-cancel-btn'),
      modalConfirmBtn: document.getElementById('modal-confirm-btn'),
      colorInfoModal: document.getElementById('color-info-modal'),
      colorModalTitle: document.getElementById('color-modal-title'),
      colorModalMessage: document.getElementById('color-modal-message'),
      colorModalCloseBtn: document.getElementById('color-modal-close-btn'),
      colorModalOkBtn: document.getElementById('color-modal-ok-btn'),
      medsModal: document.getElementById('meds-modal'),
      medsModalCloseBtn: document.getElementById('meds-modal-close-btn'),
      newMedInput: document.getElementById('new-med-input'),
      addMedBtn: document.getElementById('add-med-btn'),
      medsList: document.getElementById('meds-list'),
      manageMedsBtn: document.getElementById('manage-meds-btn'),
      themeToggle: document.getElementById('theme-toggle'),
      themeIconSun: document.getElementById('theme-icon-sun'),
      themeIconMoon: document.getElementById('theme-icon-moon'),
    };
    
    function init() {
      setupPWA();
      setupTheme();
      loadData();
      renderStaticComponents();
      setupEventListeners();
      setupGestureListeners(); 
      DOM.logDate.value = dayjs(appState.currentDate).format('YYYY-MM-DD');
      loadLogForDate(appState.currentDate);
      navigateTo('log-page');
    }

    function setupPWA() {
        const manifest = {
            "name": "å¥åº·æ—¥èªŒ", "short_name": "å¥åº·æ—¥èªŒ", "start_url": ".",
            "display": "standalone", "background_color": "#f8fafc", "theme_color": "#3B82F6",
            "description": "æ‚¨çš„å€‹äººåŒ–å¥åº·èˆ‡æ’ä¾¿æ—¥èªŒã€‚",
            "icons": [{"src": "https://placehold.co/192x192/3B82F6/FFFFFF?text=æ—¥èªŒ", "sizes": "192x192", "type": "image/png"}, {"src": "https://placehold.co/512x512/3B82F6/FFFFFF?text=æ—¥èªŒ", "sizes": "512x512", "type": "image/png"}]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        if (!document.querySelector('link[rel="manifest"]')) {
            const manifestLink = document.createElement('link');
            manifestLink.rel = 'manifest';
            manifestLink.href = manifestURL;
            document.head.appendChild(manifestLink);
        }
    }

    function loadData() {
      try {
        const dataStr = localStorage.getItem('healthLogApp');
        if (dataStr) {
            const data = JSON.parse(dataStr);
            if (data.logs) {
                appState.dailyLogs = data.logs;
                appState.lastBackupDate = data.lastUpdated;
                appState.commonMeds = data.commonMeds || [];
            } else { // Handle very old format without logs wrapper
                appState.dailyLogs = data;
                appState.lastBackupDate = null;
                appState.commonMeds = [];
            }
        }
      } catch (error) { console.error("ç„¡æ³•è®€å– localStorage è³‡æ–™:", error); appState.dailyLogs = {}; appState.commonMeds = []; }
    }
    
    function saveData() {
        const dataToSave = {
            logs: appState.dailyLogs,
            commonMeds: appState.commonMeds,
            lastUpdated: new Date().toISOString()
        };
        localStorage.setItem('healthLogApp', JSON.stringify(dataToSave));
        appState.lastBackupDate = dataToSave.lastUpdated;
        updateLastBackupInfo();
    }

    function getEmptyLog() {
      return { hadBowelMovement: false, bowel: [], sleep: 0, nightToiletVisits: -1, rbd: { symptoms: [], other: '' }, meds: '', dailyNotes: '' };
    }
    function getEmptyBowelRecord() {
      return { id: Date.now(), bowelTimeOfDay: '', types: [], color: '', volume: '', duration: '', notes: '', symptoms: [], additionalStatus: [] };
    }

    function loadLogForDate(date) {
      const log = appState.dailyLogs[date] || getEmptyLog();
      
      DOM.bowelStatusOptions.querySelectorAll('.option-button').forEach(btn => {
          btn.classList.remove('selected');
          if ((log.hadBowelMovement && btn.dataset.value === 'yes') || (!log.hadBowelMovement && btn.dataset.value === 'no')) {
              btn.classList.add('selected');
          }
      });

      toggleBowelSection(log.hadBowelMovement);
      renderBowelForms(log.bowel);
      updateStars(log.sleep);
      DOM.nightToiletVisits.querySelectorAll('.option-button').forEach(btn => {
        btn.classList.toggle('selected', parseInt(btn.dataset.value, 10) === log.nightToiletVisits);
      });
      const rbdCheckboxes = DOM.rbdSymptoms.querySelectorAll('input[type="checkbox"]');
      rbdCheckboxes.forEach(input => {
        input.checked = log.rbd.symptoms.includes(input.id);
        input.disabled = false;
      });
      updateRbdCheckboxStates();
      DOM.rbdOtherNotes.value = log.rbd.other;
      DOM.rbdOtherNotes.classList.toggle('hidden', !log.rbd.symptoms.includes('other'));
      DOM.medicationLog.value = log.meds;
      DOM.dailyNotes.value = log.dailyNotes;
      renderCommonMeds();
    }

    async function saveLogForDate(date) {
        if (!validateLogForm()) return;
        triggerHapticFeedback();
        const originalContent = DOM.saveLogButtonContent.innerHTML;
        DOM.saveLogButton.disabled = true;
        DOM.saveLogButtonContent.innerHTML = `<svg class="spinner w-6 h-6 mr-2 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>å„²å­˜ä¸­...`;
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const selectedBowelStatus = DOM.bowelStatusOptions.querySelector('.selected')?.dataset.value;
        const hadBowelMovement = selectedBowelStatus === 'yes';
        
        let bowelRecords = [];
        if (hadBowelMovement) {
            document.querySelectorAll('.bowel-record-form').forEach(form => {
                const getSelected = (className) => Array.from(form.querySelectorAll(`.${className} .selected`)).map(btn => btn.dataset.value);
                bowelRecords.push({
                    id: form.dataset.id,
                    bowelTimeOfDay: form.querySelector('.bowel-time-of-day').value,
                    types: Array.from(form.querySelectorAll('.bristol-item.bristol-selected')).map(item => parseInt(item.dataset.type)),
                    color: form.querySelector('.color-item.bristol-selected')?.dataset.value || '',
                    volume: form.querySelector('.volume-options .selected')?.dataset.value || '',
                    duration: form.querySelector('.duration-options .selected')?.dataset.value || '',
                    notes: form.querySelector('.bowel-notes').value,
                    symptoms: getSelected('symptoms-options'),
                    additionalStatus: getSelected('status-options')
                });
            });
        }

        appState.dailyLogs[date] = {
            hadBowelMovement: hadBowelMovement,
            bowel: bowelRecords,
            sleep: DOM.sleepQualityRating.querySelectorAll('.star.selected').length,
            nightToiletVisits: parseInt(document.querySelector('#night-toilet-visits .selected')?.dataset.value, 10) ?? -1,
            rbd: {
                symptoms: Array.from(document.querySelectorAll('#rbd-symptoms input:checked')).map(el => el.id),
                other: DOM.rbdOtherNotes.value
            },
            meds: DOM.medicationLog.value,
            dailyNotes: DOM.dailyNotes.value
        };

        saveData();
        DOM.saveLogButtonContent.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="mr-2 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>å„²å­˜æˆåŠŸï¼`;
        setTimeout(() => {
            DOM.saveLogButton.disabled = false;
            DOM.saveLogButtonContent.innerHTML = originalContent;
            showToast('æœ¬æ—¥æ—¥èªŒå·²å„²å­˜ï¼', 'success');
        }, 1200);
    }

    function renderStaticComponents() {
      DOM.sleepQualityRating.innerHTML = '';
      for (let i = 1; i <= 5; i++) DOM.sleepQualityRating.innerHTML += `<span class="star" data-value="${i}">&#9733;</span>`;
      
      DOM.nightToiletVisits.innerHTML = '';
      for (let i = 0; i <= 5; i++) {
        DOM.nightToiletVisits.innerHTML += `<button type="button" class="option-button text-sm py-2 px-4 rounded-lg border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700" data-value="${i}">${i} æ¬¡</button>`;
      }

      DOM.rbdSymptoms.innerHTML = rbdSymptomsList.map(s => `<label class="flex items-center has-[:disabled]:text-slate-400"><input type="checkbox" id="${s.id}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 custom-checkbox mr-2"> ${s.label}</label>`).join('');
    }
    function renderBowelForms(records = []) {
      DOM.bowelRecordsContainer.innerHTML = '';
      const hadBowelMovement = DOM.bowelStatusOptions.querySelector('.selected')?.dataset.value === 'yes';
      if (records.length === 0 && hadBowelMovement) {
          records.push(getEmptyBowelRecord());
      }
      records.forEach((record, index) => DOM.bowelRecordsContainer.insertAdjacentHTML('beforeend', createBowelFormHTML(record, index + 1)));
    }
    function createBowelFormHTML(record, index) {
      return `<div class="bowel-record-form border-t-2 border-slate-200 dark:border-slate-700 pt-4" data-id="${record.id}"><div class="flex justify-between items-center mb-3"><h4 class="font-semibold text-md text-slate-700 dark:text-slate-300">ç¬¬ ${index} ç­†ç´€éŒ„</h4>${index > 1 ? `<button class="remove-bowel-record-btn text-sm font-medium text-red-500 hover:text-red-700">åˆªé™¤æ­¤ç­†</button>` : ''}</div><div class="form-section border-slate-200 dark:border-slate-700"><div class="grid grid-cols-3 gap-2">${bristolData.map(item => `<div class="bristol-item p-2 rounded-lg border-2 border-slate-200 dark:border-slate-600 cursor-pointer text-center flex flex-col justify-start items-center ${record.types.includes(item.type) ? 'bristol-selected' : ''}" data-type="${item.type}" tabindex="0"><svg viewBox="0 0 24 18" class="w-12 h-10 mx-auto mb-1">${item.svg}</svg><p class="font-semibold text-xs text-slate-800 dark:text-slate-200">é¡å‹ ${item.type}</p><p class="text-[10px] text-slate-500 dark:text-slate-400 leading-tight mt-1">${item.d}</p></div>`).join('')}</div></div><div class="space-y-3 mt-3"><div class="form-section border-slate-200 dark:border-slate-700"><label class="form-section-label text-slate-600 dark:text-slate-400">â° æ’ä¾¿æ™‚é–“é»</label><input type="time" class="bowel-time-of-day w-full p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-200 rounded-md" value="${record.bowelTimeOfDay || ''}"></div><div class="form-section border-slate-200 dark:border-slate-700"><label class="form-section-label text-slate-600 dark:text-slate-400">ğŸ¨ é¡è‰²</label><div class="color-options grid grid-cols-3 gap-2">${bowelColorData.map(color => `<div class="color-item p-2 rounded-lg border-2 border-slate-200 dark:border-slate-600 cursor-pointer text-center flex flex-col items-center justify-center ${record.color === color.name ? 'bristol-selected' : ''}" data-value="${color.name}"><div class="w-10 h-10 rounded-full mb-1" style="background-color:${color.colorHex};"></div><p class="text-xs text-slate-600 dark:text-slate-400">${color.name}</p></div>`).join('')}</div></div><div class="grid grid-cols-2 gap-3">${createOptionGroup('ğŸ“ æ’ä¾¿é‡', 'volume-options', bowelVolumes, record.volume, false)}${createOptionGroup('â±ï¸ æ’ä¾¿è€—æ™‚', 'duration-options', bowelDurations, record.duration, false)}</div>${createOptionGroup('ğŸ˜– ç—‡ç‹€', 'symptoms-options', bowelSymptoms, record.symptoms, true)}${createOptionGroup('âœ¨ é™„åŠ ç‹€æ…‹', 'status-options', bowelAdditionalStatus, record.additionalStatus, true)}<div class="form-section border-slate-200 dark:border-slate-700"><label class="form-section-label text-slate-600 dark:text-slate-400">ğŸ—’ï¸ å‚™è¨»</label><textarea class="bowel-notes w-full p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-200 rounded-md">${record.notes || ''}</textarea></div></div></div>`;
    }
    function createOptionGroup(label, className, options, selectedValues, isMultiSelect) {
      const groupClass = isMultiSelect ? `option-button-group ${className} multi-select-group flex flex-wrap gap-2` : `option-button-group ${className} flex flex-wrap gap-2`;
      const buttons = options.map(opt => `<button type="button" class="option-button text-sm py-1 px-3 rounded-full border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 ${(Array.isArray(selectedValues) ? selectedValues.includes(opt) : opt === selectedValues) ? 'selected' : ''}" data-value="${opt}">${opt}</button>`).join('');
      return `<div class="form-section border-slate-200 dark:border-slate-700"><label class="form-section-label text-sm text-slate-600 dark:text-slate-400">${label}</label><div class="${groupClass}">${buttons}</div></div>`;
    }

    function getBowelStatus(types) {
        if (!types || types.length === 0) return null;
        const avg = types.reduce((a, b) => a + b, 0) / types.length;
        if (avg >= 3 && avg < 5) return { text: 'å¥åº·', colorClass: 'status-badge-green', icon: 'âœ…' };
        if (avg < 3) return { text: 'ä¾¿ç§˜', colorClass: 'status-badge-orange', icon: 'âš ï¸' };
        if (avg >= 5) return { text: 'è…¹ç€‰', colorClass: 'status-badge-blue', icon: 'ğŸ’§' };
        return null;
    }

    function renderHistoryList(filterWeek = 'all') {
      const sortedDates = Object.keys(appState.dailyLogs).sort().reverse();
      
      const filteredDates = filterWeek === 'all' 
        ? sortedDates
        : sortedDates.filter(date => {
            const [year, week] = filterWeek.split('-');
            return dayjs(date).year() == year && dayjs(date).week() == week;
        });

      if (filteredDates.length === 0) {
        DOM.historyList.innerHTML = `<div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1" class="text-slate-400 dark:text-slate-500"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            <h3 class="font-semibold">å°šç„¡ç´€éŒ„</h3>
            <p class="text-sm mt-1">é–‹å§‹è¨˜éŒ„æ‚¨çš„ç¬¬ä¸€ç­†å¥åº·æ—¥èªŒå§ï¼</p>
        </div>`;
        return;
      }

      DOM.historyList.innerHTML = filteredDates.map(date => {
        const log = appState.dailyLogs[date];
        const sleep = log.sleep > 0 ? `${'â˜…'.repeat(log.sleep)}${'â˜†'.repeat(5 - log.sleep)}` : 'æœªè¨˜éŒ„';
        const nightVisits = (log.nightToiletVisits !== undefined && log.nightToiletVisits > 0) ? `${log.nightToiletVisits} æ¬¡` : '0 æ¬¡';
        const rbdText = log.rbd.symptoms.length > 0 ? log.rbd.symptoms.map(id => rbdSymptomsList.find(s => s.id === id)?.label || id).join('ã€ ') : 'ç„¡';
        
        return `<div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
            <div class="flex justify-between items-center mb-3">
                <p class="font-bold text-lg text-slate-800 dark:text-slate-200">${dayjs(date).format('YYYY/MM/DD')}</p>
                <button class="edit-log-btn text-sm text-blue-600 hover:underline" data-date="${date}">æŸ¥çœ‹/ç·¨è¼¯</button>
            </div>
            <div class="text-sm text-slate-700 dark:text-slate-300 space-y-2">
                <p>ğŸ˜´ <b class="font-semibold">ç¡çœ :</b> ${sleep}</p>
                <p>ğŸš½ <b class="font-semibold">å¤œé–“å¦‚å»:</b> ${nightVisits}</p>
                <p>ğŸƒâ€â™‚ï¸ <b class="font-semibold">RBD ç—‡ç‹€:</b> ${rbdText}</p>
                <div>
                    <p class="mb-1">ğŸ’© <b class="font-semibold">æ’ä¾¿ç´€éŒ„:</b></p> 
                    ${!log.hadBowelMovement ? '<span class="text-slate-500 dark:text-slate-400 ml-5">ç•¶æ—¥ç„¡æ’ä¾¿</span>' : (log.bowel && log.bowel.length > 0 ? `<ul class="list-none pl-5 space-y-1">${log.bowel.map(b => {
                        const status = getBowelStatus(b.types);
                        const statusBadge = status ? `<span class="status-badge ${status.colorClass}">${status.icon} ${status.text}</span>` : '';
                        return `<li class="border-l-2 border-slate-200 dark:border-slate-700 pl-2">
                                    <div class="flex items-center text-xs gap-2">${b.bowelTimeOfDay ? `<b>${b.bowelTimeOfDay}</b>` : ''}${statusBadge}</div>
                                    <div class="text-slate-500 dark:text-slate-400 text-[11px]">é¡å‹ ${Array.isArray(b.types) && b.types.length ? b.types.join(', ') : '?'} (${b.color || 'N/A'}, ${b.volume || 'N/A'})</div>
                                </li>`;
                    }).join('')}</ul>` : '<span class="text-slate-500 dark:text-slate-400 ml-5">æœªè¨˜éŒ„</span>')}
                </div>
            </div>
        </div>`;
      }).join('');
    }

    function updateLastBackupInfo() {
        if (appState.lastBackupDate) {
            DOM.lastBackupInfo.textContent = `æœ€å¾Œå‚™ä»½æ–¼ï¼š${dayjs(appState.lastBackupDate).format('YYYY/MM/DD HH:mm:ss')}`;
        } else {
            DOM.lastBackupInfo.textContent = 'å°šæœªæœ‰ä»»ä½•å‚™ä»½ç´€éŒ„ã€‚';
        }
    }

    function getChartColors() {
      const isDarkMode = DOM.html.classList.contains('dark');
      return { gridColor: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)', textColor: isDarkMode ? '#cbd5e1' : '#475569' };
    }

    function updateCharts() {
      const weekStart = dayjs().subtract(appState.statsWeekOffset, 'week').startOf('week');
      const weekEnd = dayjs().subtract(appState.statsWeekOffset, 'week').endOf('week');
      DOM.statsWeekTitle.textContent = `${weekStart.format('YYYY/MM/DD')} - ${weekEnd.format('MM/DD')}`;
      DOM.nextWeekBtn.disabled = appState.statsWeekOffset <= 0;
      
      const weekData = getWeekData(weekStart); 
      const hasAnyData = Object.values(weekData).some(arr => arr.some(val => val !== null && val !== 0 && (!Array.isArray(val) || val.length > 0)));

      if (!hasAnyData) {
        DOM.statsContent.innerHTML = `<div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1" class="text-slate-400 dark:text-slate-500"><path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>
            <h3 class="font-semibold">æœ¬é€±å°šç„¡çµ±è¨ˆè³‡æ–™</h3>
            <p class="text-sm mt-1">è«‹å…ˆæ–°å¢ä¸€äº›æ—¥èªŒç´€éŒ„ï¼</p>
        </div>`;
        return;
      }
      
      DOM.statsContent.innerHTML = `
        <section id="ai-insight-section" class="bg-blue-50 dark:bg-blue-900/50 border-l-4 border-blue-500 p-4 rounded-r-lg shadow-sm space-y-2 text-blue-800 dark:text-blue-200">
          <h3 class="text-lg font-semibold flex items-center">âœ¨ æœ¬é€±æ´å¯Ÿ</h3>
          <div id="ai-insight-text" class="text-sm"></div>
        </section>
        <section id="bowel-analysis-section" class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-4 text-slate-800 dark:text-slate-200"></section>
        <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-4 text-slate-800 dark:text-slate-200">
          <h3 class="text-lg font-semibold">ğŸ˜´ ç¡çœ å“è³ªè¶¨å‹¢</h3>
          <div class="relative h-64 md:h-80"><canvas id="sleep-chart"></canvas></div>
          <div id="stats-summary-sleep" class="text-sm text-center text-slate-500 dark:text-slate-400 pt-2"></div>
        </section>
        <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-4 text-slate-800 dark:text-slate-200">
          <h3 class="text-lg font-semibold">ğŸš½ å¤œé–“èµ·åºŠå¦‚å»æ¬¡æ•¸è¶¨å‹¢</h3>
          <div class="relative h-64 md:h-80"><canvas id="night-toilet-chart"></canvas></div>
          <div id="stats-summary-night-toilet" class="text-sm text-center text-slate-500 dark:text-slate-400 pt-2"></div>
        </section>
        <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-4 text-slate-800 dark:text-slate-200">
          <h3 class="text-lg font-semibold">â° æ’ä¾¿æ™‚é–“é»åˆ†ä½ˆ</h3>
          <div class="relative h-64 md:h-80"><canvas id="bowel-time-chart"></canvas></div>
        </section>
        <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-4 text-slate-800 dark:text-slate-200">
          <h3 class="text-lg font-semibold">ğŸ’© æ’ä¾¿é¡å‹è¶¨å‹¢</h3>
          <div class="relative h-64 md:h-80"><canvas id="bowel-chart"></canvas></div>
          <div id="stats-summary-bowel" class="text-sm text-center text-slate-500 dark:text-slate-400 pt-2"></div>
        </section>
        <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-4 text-slate-800 dark:text-slate-200">
          <h3 class="text-lg font-semibold">ğŸƒâ€â™‚ï¸ RBD ç—‡ç‹€çµ±è¨ˆ</h3>
          <div class="relative h-64 md:h-80"><canvas id="rbd-chart"></canvas></div>
          <div id="stats-summary-rbd" class="text-sm text-center text-slate-500 dark:text-slate-400 pt-2"></div>
        </section>
        <section id="health-tips-section" class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-3 text-slate-800 dark:text-slate-200"></section>
      `;
      // Re-assign DOM elements after re-rendering
      DOM.aiInsightText = document.getElementById('ai-insight-text');
      DOM.bowelAnalysisSection = document.getElementById('bowel-analysis-section');
      DOM.statsSummarySleep = document.getElementById('stats-summary-sleep');
      DOM.statsSummaryNightToilet = document.getElementById('stats-summary-night-toilet');
      DOM.statsSummaryBowel = document.getElementById('stats-summary-bowel');
      DOM.statsSummaryRbd = document.getElementById('stats-summary-rbd');
      DOM.healthTipsSection = document.getElementById('health-tips-section');
      
      generateHealthInsights(weekData); 
      updateBowelAnalysis(weekStart);
      updateSleepChart(weekStart, weekData);
      updateNightToiletChart(weekStart, weekData);
      updateBowelTimeChart(weekStart, weekData);
      updateBowelChart(weekStart, weekData);
      updateRbdChart(weekStart, weekData);
      renderStaticHealthTips();
    }

    function getWeekData(weekStart) {
        const data = { labels: [], sleep: [], nightToilet: [], bowel: [], bowelCount: [], rbd: [], dates: [] };
        for (let i = 0; i < 7; i++) {
            const date = weekStart.add(i, 'day');
            const dateStr = date.format('YYYY-MM-DD');
            const log = appState.dailyLogs[dateStr];
            data.labels.push(date.format('M/D'));
            data.dates.push(dateStr);
            data.sleep.push(log ? log.sleep : null);
            data.nightToilet.push(log && log.nightToiletVisits > -1 ? log.nightToiletVisits : null);
            data.bowel.push(log && log.bowel && log.bowel.length > 0 ? log.bowel.flatMap(b => b.types) : null);
            data.bowelCount.push(log && log.bowel ? log.bowel.length : 0);
            data.rbd.push(log && log.rbd && log.rbd.symptoms.length > 0 && !log.rbd.symptoms.includes('none') ? log.rbd.symptoms.length : 0);
        }
        return data;
    }

    function generateHealthInsights(weekData) {
        if (!DOM.aiInsightText) return;
        const totalBowelMovements = weekData.bowelCount.reduce((a, b) => a + b, 0);
        
        const validSleep = weekData.sleep.filter(s => s > 0);
        const avgSleepText = validSleep.length > 0 
            ? `å¹³å‡ ${ (validSleep.reduce((a, b) => a + b, 0) / validSleep.length).toFixed(1) } é¡†æ˜Ÿ`
            : 'ç„¡ç´€éŒ„';

        const totalNightToilet = weekData.nightToilet.filter(n => n !== null).reduce((a, b) => a + b, 0);
        const totalRbd = weekData.rbd.reduce((a, b) => a + b, 0);

        DOM.aiInsightText.innerHTML = `
            <ul class="list-disc list-inside space-y-1">
                <li>ğŸ’© <b>æ’ä¾¿ç´€éŒ„ï¼š</b>å…± ${totalBowelMovements} æ¬¡</li>
                <li>ğŸ˜´ <b>ç¡çœ å“è³ªï¼š</b>${avgSleepText}</li>
                <li>ğŸš½ <b>èµ·åºŠå¦‚å»æ¬¡æ•¸ï¼š</b>å…± ${totalNightToilet} æ¬¡</li>
                <li>ğŸƒâ€â™‚ï¸ <b>RBD ç—‡ç‹€ï¼š</b>å…± ${totalRbd} æ¬¡</li>
            </ul>
        `;
    }

    function updateBowelAnalysis(weekStart) {
      if (!DOM.bowelAnalysisSection) return;
      const allLogs = appState.dailyLogs;
      let lastBM = null;
      const sortedDates = Object.keys(allLogs).sort().reverse();
      for (const date of sortedDates) {
        if (allLogs[date].bowel && allLogs[date].bowel.length > 0) {
          const sortedBMs = allLogs[date].bowel.filter(b => b.bowelTimeOfDay).sort((a, b) => b.bowelTimeOfDay.localeCompare(a.bowelTimeOfDay));
          if (sortedBMs.length > 0) { lastBM = dayjs(`${date} ${sortedBMs[0].bowelTimeOfDay}`); break; }
        }
      }
      const getStatsForPeriod = (startDate, endDate) => {
        let totalBMs = 0, goodBMs = 0;
        for (let d = startDate; d.isBefore(endDate) || d.isSame(endDate); d = d.add(1, 'day')) {
          const log = allLogs[d.format('YYYY-MM-DD')];
          if (log && log.bowel && log.bowel.length > 0) {
            totalBMs += log.bowel.length;
            log.bowel.forEach(b => { 
                const status = getBowelStatus(b.types);
                if (status && status.text === 'å¥åº·') goodBMs++;
            });
          }
        }
        return { totalBMs, goodBMs };
      };
      const currentWeekStats = getStatsForPeriod(weekStart, weekStart.add(6, 'day'));
      const previousWeekStats = getStatsForPeriod(weekStart.subtract(7, 'day'), weekStart.subtract(1, 'day'));
      const goodBMPercent = currentWeekStats.totalBMs > 0 ? Math.round((currentWeekStats.goodBMs / currentWeekStats.totalBMs) * 100) : 0;
      const prevGoodBMPercent = previousWeekStats.totalBMs > 0 ? Math.round((previousWeekStats.goodBMs / previousWeekStats.totalBMs) * 100) : 0;
      const weekLabel = appState.statsWeekOffset === 0 ? 'æœ¬é€±' : 'è©²é€±';
      DOM.bowelAnalysisSection.innerHTML = `<h3 class="text-lg font-semibold">ğŸ“Š æ’ä¾¿åˆ†æ</h3><p class="text-sm text-slate-600 dark:text-slate-400"><b>ä¸Šä¸€æ¬¡æ’ä¾¿ï¼š</b> ${lastBM ? lastBM.fromNow() : 'ç„¡ç´€éŒ„'}</p><div class="grid grid-cols-2 gap-4 text-center"><div class="bg-slate-100 dark:bg-slate-700 p-3 rounded-lg"><p class="text-2xl font-bold">${currentWeekStats.totalBMs} <span class="text-sm font-normal">æ¬¡</span></p><p class="text-xs text-slate-500 dark:text-slate-400">${weekLabel}</p><p class="text-xs text-slate-500 dark:text-slate-400 mt-1">ç›¸è¼ƒæ–¼å‰7å¤©çš„ ${previousWeekStats.totalBMs} æ¬¡</p></div><div class="bg-slate-100 dark:bg-slate-700 p-3 rounded-lg"><p class="text-2xl font-bold">${goodBMPercent}<span class="text-sm font-normal">%</span></p><p class="text-xs text-slate-500 dark:text-slate-400">${weekLabel}å¥åº·ä¾¿ä¾¿</p><p class="text-xs text-slate-500 dark:text-slate-400 mt-1">ç›¸è¼ƒæ–¼å‰7å¤©çš„ ${prevGoodBMPercent}%</p></div></div>`;
    }
    function updateSleepChart(weekStart, weekData) {
      const canvas = document.getElementById('sleep-chart');
      if (!canvas) return;
      const colors = getChartColors();
      if (appState.charts.sleep) appState.charts.sleep.destroy();
      appState.charts.sleep = new Chart(canvas, { type: 'line', data: { labels: weekData.labels, datasets: [{ label: 'ç¡çœ å“è³ª', data: weekData.sleep, borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', fill: true, tension: 0.3, spanGaps: true }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 1, max: 5, ticks: { stepSize: 1, color: colors.textColor }, grid: { color: colors.gridColor } }, x: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } } }, plugins: { legend: { display: false } } } });
      const validRecords = weekData.sleep.filter(p => p !== null && p > 0);
      DOM.statsSummarySleep.textContent = validRecords.length > 0 ? `æœ¬é€±å¹³å‡ç¡çœ å“è³ªç‚º ${(validRecords.reduce((a, b) => a + b, 0) / validRecords.length).toFixed(1)} é¡†æ˜Ÿã€‚` : 'æœ¬é€±æ²’æœ‰ç¡çœ å“è³ªç´€éŒ„ã€‚';
    }
    function updateNightToiletChart(weekStart, weekData) {
      const canvas = document.getElementById('night-toilet-chart');
      if (!canvas) return;
      const colors = getChartColors();
      if (appState.charts.nightToilet) appState.charts.nightToilet.destroy();
      appState.charts.nightToilet = new Chart(canvas, { type: 'bar', data: { labels: weekData.labels, datasets: [{ label: 'å¤œé–“å¦‚å»æ¬¡æ•¸', data: weekData.nightToilet, backgroundColor: 'rgba(139, 92, 246, 0.6)', borderColor: 'rgba(139, 92, 246, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, color: colors.textColor }, grid: { color: colors.gridColor } }, x: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } } }, plugins: { legend: { display: false } } } });
      const validRecords = weekData.nightToilet.filter(p => p !== null);
      DOM.statsSummaryNightToilet.textContent = validRecords.length > 0 ? `æœ¬é€±å¹³å‡å¤œé–“å¦‚å» ${(validRecords.reduce((a, b) => a + b, 0) / validRecords.length).toFixed(1)} æ¬¡ã€‚` : 'æœ¬é€±æ²’æœ‰å¤œé–“å¦‚å»ç´€éŒ„ã€‚';
    }
    function updateBowelTimeChart(weekStart, weekData) {
      const canvas = document.getElementById('bowel-time-chart');
      if (!canvas) return;
      const colors = getChartColors();
      const datasets = [];
      weekData.dates.forEach((dateStr, i) => {
        const log = appState.dailyLogs[dateStr];
        if (log && log.bowel && log.bowel.length > 0) {
          log.bowel.forEach(b => {
            if (b.bowelTimeOfDay) {
              const time = dayjs(b.bowelTimeOfDay, 'HH:mm');
              datasets.push({ x: i, y: time.hour() + time.minute() / 60, types: Array.isArray(b.types) ? b.types.join(', ') : '' });
            }
          });
        }
      });
      if (appState.charts.bowelTime) appState.charts.bowelTime.destroy();
      appState.charts.bowelTime = new Chart(canvas, { type: 'scatter', data: { datasets: [{ label: 'æ’ä¾¿æ™‚é–“', data: datasets, backgroundColor: 'rgba(59, 130, 246, 0.7)', pointRadius: 6, pointHoverRadius: 8 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'linear', position: 'bottom', ticks: { color: colors.textColor, stepSize: 1, callback: (value) => weekData.labels[value] || '' }, grid: { display: false } }, y: { reverse: true, min: 0, max: 24, ticks: { color: colors.textColor, stepSize: 3, callback: (value) => `${String(value).padStart(2, '0')}:00` }, grid: { color: colors.gridColor } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => { const d = c.dataset.data[c.dataIndex]; const h = Math.floor(d.y); const m = Math.round((d.y - h) * 60); return `æ™‚é–“: ${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')} (é¡å‹: ${d.types})`; } } } } } });
    }
    function updateBowelChart(weekStart, weekData) {
      const canvas = document.getElementById('bowel-chart');
      if (!canvas) return;
      const colors = getChartColors();
      const dataPoints = weekData.bowel.map(dayBowel => {
        if (dayBowel && dayBowel.length > 0) return dayBowel.reduce((a, b) => a + b, 0) / dayBowel.length;
        return null;
      });
      if (appState.charts.bowel) appState.charts.bowel.destroy();
      appState.charts.bowel = new Chart(canvas, { type: 'line', data: { labels: weekData.labels, datasets: [{ label: 'å¸ƒé‡Œæ–¯æ‰˜åˆ†é¡', data: dataPoints, borderColor: '#3B82F6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.3, spanGaps: true }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 1, max: 7, ticks: { stepSize: 1, color: colors.textColor }, grid: { color: colors.gridColor } }, x: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } } }, plugins: { legend: { display: false } } } });
      const validRecords = dataPoints.filter(p => p !== null);
      DOM.statsSummaryBowel.textContent = validRecords.length > 0 ? `æœ¬é€±å¹³å‡é¡å‹ç‚º ${(validRecords.reduce((a, b) => a + b, 0) / validRecords.length).toFixed(1)}ã€‚` : 'æœ¬é€±æ²’æœ‰æ’ä¾¿ç´€éŒ„ã€‚';
    }
    function updateRbdChart(weekStart, weekData) {
      const canvas = document.getElementById('rbd-chart');
      if (!canvas) return;
      const colors = getChartColors();
      const rbdSymptomMap = rbdSymptomsList.reduce((acc, s) => ({...acc, [s.id]: s.label}), {});
      const tooltipLabels = weekData.dates.map(dateStr => {
          const log = appState.dailyLogs[dateStr];
          if (log && Array.isArray(log.rbd.symptoms) && log.rbd.symptoms.length > 0 && !log.rbd.symptoms.includes('none')) {
              return log.rbd.symptoms.map(id => rbdSymptomMap[id] || id).join('ã€ ');
          }
          return 'ç„¡ç—‡ç‹€';
      });
      if (appState.charts.rbd) appState.charts.rbd.destroy();
      appState.charts.rbd = new Chart(canvas, { type: 'bar', data: { labels: weekData.labels, datasets: [{ label: 'ç—‡ç‹€æ¬¡æ•¸', data: weekData.rbd, backgroundColor: 'rgba(239, 68, 68, 0.6)', borderColor: 'rgba(239, 68, 68, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, color: colors.textColor }, grid: { color: colors.gridColor } }, x: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.parsed.y} æ¬¡`, afterLabel: (c) => tooltipLabels[c.dataIndex] } } } } });
      DOM.statsSummaryRbd.textContent = `æœ¬é€±å…±è¨˜éŒ„ ${weekData.rbd.reduce((a, b) => a + b, 0)} æ¬¡RBDç›¸é—œç—‡ç‹€ã€‚`;
    }
    
    function renderStaticHealthTips() {
        if (!DOM.healthTipsSection) return;
        DOM.healthTipsSection.innerHTML = `<h3 class="text-lg font-semibold">ğŸ’¡ å¥åº·å°æç¤º</h3><ul class="text-sm text-slate-600 dark:text-slate-400 space-y-2 list-disc list-inside"><li><b>ç†æƒ³ä¾¿ä¾¿ï¼š</b>ä»¥ã€Œå¸ƒé‡Œæ–¯æ‰˜å¤§ä¾¿åˆ†é¡æ³•ã€ç¬¬3â€“4å‹ç‚ºä½³ï¼Œç‰¹åˆ¥æ˜¯ç¬¬4å‹æœ€ç†æƒ³ã€‚</li><li><b>æ³¨æ„è­¦è¨Šï¼š</b>ç¬¬1â€“2å‹åç¡¬å¯èƒ½ä¾¿ç¥•ï¼›ç¬¬6â€“7å‹åç¨€å±¬è…¹ç€‰ï¼Œè‹¥æŒçºŒå‡ºç¾å»ºè­°å°±é†«ã€‚</li><li><b>å¥åº·é »ç‡ï¼š</b>ä¸€é€±ç´„7æ¬¡ã€å½¢æ…‹å¤šåœ¨ç¬¬3â€“4å‹ï¼Œé€šå¸¸ä»£è¡¨è…¸é“åŠŸèƒ½ä½³ã€‚</li><li><b>é¡è‰²è§€å¯Ÿï¼š</b>é»ƒè¤/æ£•è‰²å¸¸è¦‹ï¼›è‹¥æŒçºŒé»‘ã€ç´…æˆ–ç°ç™½è‰²éœ€æé«˜è­¦è¦ºã€‚</li><li><b>ç”Ÿæ´»ç¿’æ…£ï¼š</b>å½¢ç‹€å—æ°´åˆ†èˆ‡çº–ç¶­å½±éŸ¿å¤§ï¼›è¦å¾‹é‹å‹•èˆ‡æ’ä¾¿ç¿’æ…£åŒæ¨£é‡è¦ã€‚</li><li><b>å¤œé–“å¦‚å»ï¼š</b>å¹´è¼•äººæ¯æ™š 0-1 æ¬¡å±¬æ­£å¸¸ï¼›å¹´é•·è€… 1-2 æ¬¡å°šå±¬æ™®éã€‚è‹¥é•·æœŸé«˜æ–¼ 2 æ¬¡ä¸”å½±éŸ¿ç¡çœ ï¼Œå»ºè­°è«®è©¢é†«å¸«ã€‚</li></ul>`;
    }

    function setupEventListeners() {
      DOM.logDate.addEventListener('change', e => { appState.currentDate = e.target.value; loadLogForDate(appState.currentDate); });
      
      DOM.bowelStatusOptions.addEventListener('click', e => {
          const button = e.target.closest('.option-button');
          if (button) {
              DOM.bowelStatusOptions.querySelectorAll('.option-button').forEach(btn => btn.classList.remove('selected'));
              button.classList.add('selected');
              toggleBowelSection(button.dataset.value === 'yes');
          }
      });

      DOM.addBowelRecordBtn.addEventListener('click', () => {
          DOM.bowelRecordsContainer.insertAdjacentHTML('beforeend', createBowelFormHTML(getEmptyBowelRecord(), DOM.bowelRecordsContainer.children.length + 1));
      });
      DOM.bowelRecordsContainer.addEventListener('click', e => {
        const t = e.target;
        const bristolItem = t.closest('.bristol-item'); if (bristolItem) bristolItem.classList.toggle('bristol-selected');
        const colorItem = t.closest('.color-item'); 
        if (colorItem) { 
            const g = colorItem.closest('.color-options'); 
            g.querySelectorAll('.color-item').forEach(i => i.classList.remove('bristol-selected')); 
            colorItem.classList.add('bristol-selected');
            const colorName = colorItem.dataset.value;
            const colorInfo = bowelColorData.find(c => c.name === colorName);
            if (colorInfo) showColorInfoModal(colorInfo);
        }
        const optionButton = t.closest('.option-button'); if (optionButton) { const g = optionButton.closest('.option-button-group'); if (g.classList.contains('multi-select-group')) { if (optionButton.dataset.value === 'ç„¡') { g.querySelectorAll('.option-button').forEach(b => b.classList.remove('selected')); optionButton.classList.add('selected'); } else { const n = g.querySelector('[data-value="ç„¡"]'); if (n) n.classList.remove('selected'); optionButton.classList.toggle('selected'); } } else { g.querySelectorAll('.option-button').forEach(b => b.classList.remove('selected')); optionButton.classList.add('selected'); } }
        const removeBtn = t.closest('.remove-bowel-record-btn');
        if (removeBtn) {
            showConfirmation('åˆªé™¤ç´€éŒ„', 'æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ç­†æ’ä¾¿ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚', () => {
                removeBtn.closest('.bowel-record-form').remove();
                DOM.bowelRecordsContainer.querySelectorAll('h4').forEach((h, i) => h.textContent = `ç¬¬ ${i + 1} ç­†ç´€éŒ„`);
            });
        }
      });
      DOM.sleepQualityRating.addEventListener('click', e => { if (e.target.classList.contains('star')) updateStars(e.target.dataset.value); });
      DOM.nightToiletVisits.addEventListener('click', e => {
        const button = e.target.closest('.option-button');
        if (button) {
          DOM.nightToiletVisits.querySelectorAll('.option-button').forEach(btn => btn.classList.remove('selected'));
          button.classList.add('selected');
        }
      });
      DOM.rbdSymptoms.addEventListener('change', () => { const o = DOM.rbdSymptoms.querySelector('#other'); updateRbdCheckboxStates(); DOM.rbdOtherNotes.classList.toggle('hidden', !o.checked); if (!o.checked) DOM.rbdOtherNotes.value = ''; });
      DOM.saveLogButton.addEventListener('click', () => saveLogForDate(appState.currentDate));
      DOM.navItems.forEach(item => item.addEventListener('click', () => { triggerHapticFeedback(30); navigateTo(item.dataset.page); }));
      DOM.historyList.addEventListener('click', e => { const b = e.target.closest('.edit-log-btn'); if (b) { appState.currentDate = b.dataset.date; DOM.logDate.value = appState.currentDate; loadLogForDate(appState.currentDate); navigateTo('log-page'); } });
      DOM.prevWeekBtn.addEventListener('click', () => { appState.statsWeekOffset++; updateCharts(); });
      DOM.nextWeekBtn.addEventListener('click', () => { if (appState.statsWeekOffset > 0) { appState.statsWeekOffset--; updateCharts(); } });
      DOM.exportCsvBtn.addEventListener('click', exportDataAsCsv); 
      DOM.importCsvBtn.addEventListener('click', () => DOM.importFileInput.click());
      DOM.importFileInput.addEventListener('change', importData);
      DOM.themeToggle.addEventListener('click', toggleTheme);
      DOM.modalCancelBtn.addEventListener('click', () => DOM.confirmationModal.classList.add('hidden'));
      DOM.colorModalCloseBtn.addEventListener('click', () => DOM.colorInfoModal.classList.add('hidden'));
      DOM.colorModalOkBtn.addEventListener('click', () => DOM.colorInfoModal.classList.add('hidden'));
      DOM.manageMedsBtn.addEventListener('click', openMedsModal);
      DOM.medsModalCloseBtn.addEventListener('click', () => DOM.medsModal.classList.add('hidden'));
      DOM.addMedBtn.addEventListener('click', addCommonMed);
      DOM.medsList.addEventListener('click', e => { 
          const deleteBtn = e.target.closest('.delete-med-btn');
          if(deleteBtn) {
              const medName = deleteBtn.dataset.med;
              showConfirmation('åˆªé™¤å¸¸ç”¨è—¥ç‰©', `æ‚¨ç¢ºå®šè¦åˆªé™¤ã€Œ${medName}ã€å—ï¼Ÿ`, () => {
                  deleteCommonMed(medName);
              });
          }
      });
      DOM.clearMedsBtn.addEventListener('click', () => { DOM.medicationLog.value = ''; });
      DOM.commonMedsContainer.addEventListener('click', e => { if(e.target.classList.contains('common-med-btn')) addMedToLog(e.target.dataset.med); });
      DOM.weekFilter.addEventListener('change', e => renderHistoryList(e.target.value));
    }

    function setupGestureListeners() {
        let touchStartX = 0; let touchEndX = 0; const swipeThreshold = 50; 
        DOM.statsPage.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
        DOM.statsPage.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; handleSwipe(); }, { passive: true });
        function handleSwipe() {
            const swipeDistance = touchEndX - touchStartX;
            if (Math.abs(swipeDistance) < swipeThreshold) return; 
            if (swipeDistance > 0) { DOM.prevWeekBtn.click(); } 
            else { if (!DOM.nextWeekBtn.disabled) { DOM.nextWeekBtn.click(); } }
        }
    }

    function navigateTo(pageId) {
      appState.currentPage = pageId;
      DOM.pages.forEach(p => p.classList.toggle('active', p.id === pageId));
      const titles = { 'log-page': 'ğŸ“ å¥åº·æ—¥èªŒ', 'stats-page': 'ğŸ“Š çµ±è¨ˆåœ–è¡¨', 'history-page': 'ğŸ“œ æ­·å²ç´€éŒ„' };
      DOM.headerTitle.textContent = titles[pageId] || 'å¥åº·æ—¥èªŒ';
      DOM.navItems.forEach(item => item.classList.toggle('active', item.dataset.page === pageId));
      if (pageId === 'history-page') { populateWeekFilter(); renderHistoryList(); updateLastBackupInfo(); }
      else if (pageId === 'stats-page') { appState.statsWeekOffset = 0; updateCharts(); }
      else if (pageId === 'log-page') { renderCommonMeds(); }
    }
    function updateStars(v) { DOM.sleepQualityRating.querySelectorAll('.star').forEach(s => s.classList.toggle('selected', Number(s.dataset.value) <= Number(v))); }
    function updateRbdCheckboxStates() {
      const n = DOM.rbdSymptoms.querySelector('#none'), o = DOM.rbdSymptoms.querySelectorAll('input:not(#none)');
      if (n.checked) { o.forEach(c => { c.checked = false; c.disabled = true; }); } 
      else { const a = Array.from(o).some(c => c.checked); n.disabled = a; o.forEach(c => { c.disabled = false; }); }
    }
    function toggleBowelSection(show) {
      DOM.bowelRecordsSection.classList.toggle('hidden', !show);
      if (show && DOM.bowelRecordsContainer.children.length === 0) {
          renderBowelForms([]);
      }
    }
    let toastTimer;
    function showToast(message, type = 'error') {
      clearTimeout(toastTimer);
      const t = DOM.toast;
      t.textContent = message;
      const c = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
      t.className = 'px-6 py-3 rounded-full font-semibold text-white shadow-lg';
      t.classList.add(c[type], 'show');
      toastTimer = setTimeout(() => t.classList.remove('show'), 4000);
    }
    function showConfirmation(title, message, onConfirm) {
        DOM.modalTitle.textContent = title;
        DOM.modalMessage.textContent = message;
        DOM.confirmationModal.classList.remove('hidden');
        const confirmHandler = () => { onConfirm(); DOM.confirmationModal.classList.add('hidden'); };
        DOM.modalConfirmBtn.replaceWith(DOM.modalConfirmBtn.cloneNode(true));
        DOM.modalConfirmBtn = document.getElementById('modal-confirm-btn');
        DOM.modalConfirmBtn.addEventListener('click', confirmHandler, { once: true });
    }
    function showColorInfoModal(colorInfo) {
        DOM.colorModalTitle.textContent = colorInfo.infoTitle;
        DOM.colorModalMessage.textContent = colorInfo.infoText;
        DOM.colorInfoModal.classList.remove('hidden');
    }

    function setupTheme() {
      const savedTheme = localStorage.getItem('theme');
      const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
        DOM.html.classList.add('dark'); DOM.themeIconSun.classList.remove('hidden');
      } else {
        DOM.html.classList.remove('dark'); DOM.themeIconMoon.classList.remove('hidden');
      }
    }
    function toggleTheme() {
      const isDark = DOM.html.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      DOM.themeIconSun.classList.toggle('hidden', !isDark);
      DOM.themeIconMoon.classList.toggle('hidden', isDark);
      if (appState.currentPage === 'stats-page') updateCharts();
    }

    function validateLogForm() {
      const missing = [];
      if (DOM.sleepQualityRating.querySelectorAll('.star.selected').length === 0) missing.push('æ˜¨æ™šç¡çœ å“è³ª');
      if (document.querySelector('#night-toilet-visits .selected') === null) missing.push('å¤œé–“å¦‚å»æ¬¡æ•¸');
      if (document.querySelectorAll('#rbd-symptoms input:checked').length === 0) missing.push('RBD ç—‡ç‹€');
      
      const selectedBowelStatus = DOM.bowelStatusOptions.querySelector('.selected');
      if (!selectedBowelStatus) {
          missing.push('æ’ä¾¿ç‹€æ³');
      } else if (selectedBowelStatus.dataset.value === 'yes') {
        const bowelForms = document.querySelectorAll('.bowel-record-form');
        if (bowelForms.length === 0) missing.push('è‡³å°‘ä¸€ç­†æ’ä¾¿ç´€éŒ„');
        bowelForms.forEach((form, index) => {
          const r = `ç¬¬ ${index + 1} ç­†æ’ä¾¿`;
          if (form.querySelectorAll('.bristol-item.bristol-selected').length === 0) missing.push(`${r}çš„é¡å‹`);
          if (!form.querySelector('.bowel-time-of-day').value) missing.push(`${r}çš„æ™‚é–“`);
          if (!form.querySelector('.color-item.bristol-selected')) missing.push(`${r}çš„é¡è‰²`);
          if (!form.querySelector('.volume-options .selected')) missing.push(`${r}çš„æ’ä¾¿é‡`);
          if (!form.querySelector('.duration-options .selected')) missing.push(`${r}çš„æ’ä¾¿è€—æ™‚`);
          if (form.querySelectorAll('.symptoms-options .selected').length === 0) missing.push(`${r}çš„ç—‡ç‹€`);
          if (form.querySelectorAll('.status-options .selected').length === 0) missing.push(`${r}çš„é™„åŠ ç‹€æ…‹`);
        });
      }
      if (missing.length > 0) { showToast(`è«‹å®Œæˆä»¥ä¸‹æ¬„ä½ï¼š${missing.join('ã€')}`, 'error'); return false; }
      return true;
    }
    
    function formatCsvCell(value) {
        const strValue = String(value).replace(/"/g, '""');
        if (strValue.includes(',') || strValue.includes('"') || strValue.includes('\n')) return `"${strValue}"`;
        return strValue;
    }

    function exportDataAsCsv() {
        const headers = ['date', 'hadBowelMovement', 'bowelRecords', 'sleep', 'nightToiletVisits', 'rbdSymptoms', 'rbdOther', 'meds', 'dailyNotes'];
        const csvRows = [headers.join(',')];
        const sortedDates = Object.keys(appState.dailyLogs).sort();
        for (const date of sortedDates) {
            const log = appState.dailyLogs[date];
            const exportedVisits = (log.nightToiletVisits === -1 || log.nightToiletVisits == null) ? '' : log.nightToiletVisits;
            const row = [
                dayjs(date).format('YYYY/MM/DD'),
                log.hadBowelMovement,
                JSON.stringify(log.bowel || []),
                log.sleep || 0,
                exportedVisits,
                JSON.stringify(log.rbd ? log.rbd.symptoms : []),
                log.rbd ? log.rbd.other : '',
                log.meds || '',
                log.dailyNotes || ''
            ].map(formatCsvCell).join(',');
            csvRows.push(row);
        }
        const csvString = csvRows.join('\n');
        const blob = new Blob([`\uFEFF${csvString}`], { type: 'text/csv;charset=utf-8;' });
        const fileName = `health_log_${dayjs().format('YYYYMMDD_HHmmss')}.csv`;
        
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast('è³‡æ–™å·²é–‹å§‹ä¸‹è¼‰ï¼', 'success');
    }

    function importData(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            // New robust CSV parser function
            function parseCSV(csvString) {
                const rows = [];
                let currentRow = [];
                let currentField = '';
                let inQuotes = false;
                // Normalize line endings
                const cleanedString = csvString.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

                for (let i = 0; i < cleanedString.length; i++) {
                    const char = cleanedString[i];

                    if (inQuotes) {
                        if (char === '"') {
                            // Check for escaped quote
                            if (i + 1 < cleanedString.length && cleanedString[i + 1] === '"') {
                                currentField += '"';
                                i++; // Skip the second quote
                            } else {
                                inQuotes = false; // End of quoted field
                            }
                        } else {
                            currentField += char;
                        }
                    } else {
                        if (char === '"') {
                            inQuotes = true;
                        } else if (char === ',') {
                            currentRow.push(currentField);
                            currentField = '';
                        } else if (char === '\n') {
                            currentRow.push(currentField);
                            rows.push(currentRow);
                            currentRow = [];
                            currentField = '';
                        } else {
                            currentField += char;
                        }
                    }
                }
                // Push the last field and row
                if (currentField || currentRow.length > 0) {
                    currentRow.push(currentField);
                    rows.push(currentRow);
                }
                return rows.filter(row => row.length > 1 || (row.length === 1 && row[0] !== ''));
            }

            const rows = parseCSV(e.target.result);
            
            if (rows.length < 2) { showToast('CSV æª”æ¡ˆç‚ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¢ºã€‚', 'error'); return; }
            
            const headers = rows.shift().map(cleanInvisible);
            const requiredHeaders = ['date', 'bowelRecords', 'sleep'];
            if (!requiredHeaders.every(h => headers.includes(h))) { showToast('CSV æª”æ¡ˆç¼ºå°‘å¿…è¦çš„æ¬„ä½ã€‚', 'error'); return; }
            
            const isOldFormat = headers.includes('noBowel');

            const importedLogs = {}; let errorCount = 0;
            rows.forEach((values, index) => { // Now `rows` is an array of arrays
                try {
                    if (values.length < headers.length) {
                        // Skip potentially empty or malformed rows
                        return;
                    }
                    const rowData = headers.reduce((obj, h, i) => ({...obj, [h]: values[i]}), {});
                    
                    const dateString = rowData.date ? rowData.date.trim() : '';
                    if (!dateString) {
                         throw new Error(`ç¬¬ ${index + 2} è¡Œæ—¥æœŸç‚ºç©ºã€‚`);
                    }
                    const parsedDate = dayjs(dateString, ['YYYY/MM/DD', 'YYYY-MM-DD', 'YYYY/M/D'], true);
                    
                    if (!parsedDate.isValid()) {
                        throw new Error(`æ—¥æœŸæ ¼å¼ç„¡æ•ˆ: "${dateString}"`);
                    }
                    const date = parsedDate.format('YYYY-MM-DD');

                    const visits = parseInt(rowData.nightToiletVisits, 10);
                    
                    let hadBowelMovement;
                    if (isOldFormat) {
                        hadBowelMovement = rowData.noBowel === 'false';
                    } else {
                        hadBowelMovement = rowData.hadBowelMovement === 'true';
                    }

                    importedLogs[date] = {
                        hadBowelMovement: hadBowelMovement, 
                        bowel: JSON.parse(rowData.bowelRecords || '[]'),
                        sleep: parseInt(rowData.sleep, 10) || 0,
                        nightToiletVisits: isNaN(visits) ? -1 : visits,
                        rbd: { symptoms: JSON.parse(rowData.rbdSymptoms || '[]'), other: rowData.rbdOther || '' },
                        meds: rowData.meds || '', 
                        dailyNotes: rowData.dailyNotes || ''
                    };
                } catch (err) { 
                    errorCount++; 
                    console.error(`ç„¡æ³•è§£æç¬¬ ${index + 2} è¡Œ:`, err); 
                }
            });
            if(errorCount > 0) showToast(`åŒ¯å…¥å®Œæˆï¼Œä½†æœ‰ ${errorCount} è¡Œè³‡æ–™è§£æå¤±æ•—ã€‚`, 'error');
            showConfirmation('åŒ¯å…¥è³‡æ–™', `æˆåŠŸè§£æ ${Object.keys(importedLogs).length} ç­†ç´€éŒ„ã€‚ç¢ºå®šè¦åŒ¯å…¥ä¸¦è¦†è“‹ç¾æœ‰è³‡æ–™å—ï¼Ÿ`, () => {
                Object.assign(appState.dailyLogs, importedLogs);
                saveData();
                showToast('è³‡æ–™åŒ¯å…¥æˆåŠŸï¼', 'success');
                if (appState.currentPage === 'history-page') { populateWeekFilter(); renderHistoryList(); }
                loadLogForDate(appState.currentDate);
            });
        };
        reader.onerror = () => showToast('ç„¡æ³•è®€å–æª”æ¡ˆã€‚', 'error');
        reader.readAsText(file);
        event.target.value = '';
    }
    
    // Medication Management Functions
    function openMedsModal() {
        renderMedsList();
        DOM.medsModal.classList.remove('hidden');
        DOM.newMedInput.focus();
    }

    function renderMedsList() {
        DOM.medsList.innerHTML = appState.commonMeds.map(med => `
            <div class="flex justify-between items-center p-2 bg-slate-100 dark:bg-slate-700 rounded-md">
                <span class="text-slate-800 dark:text-slate-200">${med}</span>
                <button class="delete-med-btn text-red-500 hover:text-red-700 text-xs" data-med="${med}">åˆªé™¤</button>
            </div>
        `).join('');
    }

    function addCommonMed() {
        const medName = DOM.newMedInput.value.trim();
        if (medName && !appState.commonMeds.includes(medName)) {
            appState.commonMeds.push(medName);
            saveData();
            renderMedsList();
            renderCommonMeds();
            DOM.newMedInput.value = '';
        }
    }

    function deleteCommonMed(medName) {
        appState.commonMeds = appState.commonMeds.filter(med => med !== medName);
        saveData();
        renderMedsList();
        renderCommonMeds();
    }
    
    function renderCommonMeds() {
        DOM.commonMedsContainer.innerHTML = appState.commonMeds.map(med => 
            `<button class="common-med-btn text-xs py-1 px-3 rounded-full bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200" data-med="${med}">${med}</button>`
        ).join('');
    }
    
    function addMedToLog(medName) {
        const currentLog = DOM.medicationLog.value;
        const separator = currentLog.length > 0 && !/\s$/.test(currentLog) ? ', ' : '';
        DOM.medicationLog.value += separator + medName;
        DOM.medicationLog.focus();
    }

    // Week Filter Functions
    function populateWeekFilter() {
        const weeks = new Set();
        Object.keys(appState.dailyLogs).forEach(date => {
            const d = dayjs(date);
            weeks.add(`${d.year()}-${d.week()}`);
        });

        const sortedWeeks = Array.from(weeks).sort((a, b) => b.localeCompare(a));
        
        DOM.weekFilter.innerHTML = '<option value="all">å…¨éƒ¨ç´€éŒ„</option>';
        sortedWeeks.forEach(weekStr => {
            const [year, week] = weekStr.split('-');
            const weekStart = dayjs().year(year).week(week).startOf('week').format('MM/DD');
            const weekEnd = dayjs().year(year).week(week).endOf('week').format('MM/DD');
            DOM.weekFilter.innerHTML += `<option value="${weekStr}">${year}å¹´ (${weekStart} - ${weekEnd})</option>`;
        });
    }

    init();
  });
  </script>
</body>
</html>
