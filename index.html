<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>å¥åº·æ—¥èªŒ</title>
  
  <!-- PWA Manifest and Theme Color -->
  <meta name="theme-color" content="#f8fafc"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="å¥åº·æ—¥èªŒ">
  <link rel="apple-touch-icon" href="https://placehold.co/192x192/3B82F6/FFFFFF?text=Log">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs/plugin/relativeTime.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs/plugin/customParseFormat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs/locale/zh-tw.js"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
  <style>
    :root { color-scheme: light; }
    html.dark { color-scheme: dark; }
    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    .page { display: none; animation: fadeIn 0.3s ease-in-out; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }

    .nav-item {
        border-bottom: 3px solid transparent;
        transition: all 0.2s ease-in-out;
    }
    .nav-item.active {
        border-bottom-color: #3B82F6;
    }
    .nav-item.active svg, .nav-item.active .nav-text {
        color: #3B82F6;
    }
    .nav-item.active .nav-text {
        font-weight: 600;
    }

    #toast-notification {
      position: fixed; top: -100px; left: 50%;
      transform: translateX(-50%);
      transition: top 0.4s ease-in-out, opacity 0.4s ease-in-out;
      opacity: 0;
      z-index: 9999;
    }
    #toast-notification.show { top: 20px; opacity: 1; }

    .bristol-item, .color-item { transition: all 0.2s ease-in-out; }
    .bristol-item.bristol-selected, .color-item.bristol-selected {
      border-color: #3B82F6; background-color: #EFF6FF;
    }
    html.dark .bristol-item.bristol-selected, html.dark .color-item.bristol-selected {
      background-color: #0b3a75; border-color: #60a5fa;
    }
    html.dark .bristol-item svg path { fill-opacity: 0.9; }

    .star-rating .star { color: #d1d5db; cursor: pointer; transition: color 0.2s; }
    .star-rating .star:hover, .star-rating .star.selected { color: #f59e0b; }

    .custom-checkbox:checked {
      background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
      background-color: #3B82F6; border-color: #3B82F6;
    }
    .custom-checkbox:disabled { background-color: #e5e7eb; border-color: #d1d5db; }
    html.dark .custom-checkbox:disabled { background-color: #4b5563; border-color: #6b7280; }

    .option-button-group .option-button { transition: all 0.2s ease-in-out; }
    .option-button-group .option-button.selected { background-color: #3B82F6; color: white; border-color: #3B82F6; }

    .bowel-record-disabled { opacity: 0.5; pointer-events: none; }
    .modal-backdrop.hidden { display: none; }

    .form-section { border-top-width: 1px; padding-top: 10px; margin-top: 10px; }
    .form-section-label { display: inline-flex; align-items: center; gap: 6px; font-weight: 600; font-size: 0.9rem; }
    .form-section-label svg { width: 16px; height: 16px; }

    button:focus-visible, .option-button:focus-visible, .bristol-item:focus-visible, .color-item:focus-visible {
      outline: 2px solid #3B82F6; outline-offset: 2px;
    }

    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .spinner { animation: spin 1s linear infinite; }
    
    .chart-canvas { cursor: pointer; }

    /* --- å·²ç§»é™¤æ‰€æœ‰åˆ—å°å°ˆç”¨æ¨£å¼ --- */
  </style>
</head>
<body class="bg-slate-100 dark:bg-slate-950 transition-colors duration-300">
  <div id="app" class="max-w-lg mx-auto bg-slate-50 dark:bg-slate-900 min-h-screen shadow-lg relative transition-colors duration-300 overflow-x-hidden">
    <header id="app-header" class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm sticky top-0 z-10 shadow-sm transition-colors duration-300">
      <div id="app-header-top" class="text-slate-800 dark:text-slate-200 p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
        <div class="w-10 h-10"></div> <!-- Placeholder for alignment -->
        <h1 id="header-title" class="text-xl font-bold tracking-wide text-center">å¥åº·æ—¥èªŒ</h1>
        <button id="theme-toggle" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors" aria-label="åˆ‡æ›ä¸»é¡Œ">
          <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
          <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        </button>
      </div>
      <nav id="app-nav" class="border-b border-slate-200 dark:border-slate-700 flex justify-around">
        <button class="nav-item flex flex-col items-center justify-center w-full text-slate-500 dark:text-slate-400 py-2" data-page="log-page" aria-label="å‰å¾€æ—¥èªŒ">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
          <span class="nav-text text-xs mt-1">æ—¥èªŒ</span>
        </button>
        <button class="nav-item flex flex-col items-center justify-center w-full text-slate-500 dark:text-slate-400 py-2" data-page="stats-page" aria-label="å‰å¾€çµ±è¨ˆ">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="m19 9-5 5-4-4-3 3"></path></svg>
          <span class="nav-text text-xs mt-1">çµ±è¨ˆ</span>
        </button>
        <button class="nav-item flex flex-col items-center justify-center w-full text-slate-500 dark:text-slate-400 py-2" data-page="history-page" aria-label="å‰å¾€æ­·å²">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          <span class="nav-text text-xs mt-1">æ­·å²</span>
        </button>
      </nav>
    </header>

    <div id="toast-notification" class="px-6 py-3 rounded-full font-semibold text-white shadow-lg"></div>

    <main class="p-4">
      <!-- ========= æ—¥èªŒé é¢ ========= -->
      <div id="log-page" class="page active">
        <div class="space-y-6">
          <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm">
            <label for="log-date" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">ç´€éŒ„æ—¥æœŸ</label>
            <input type="date" id="log-date" class="w-full p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-200 rounded-md focus:ring-2 focus:ring-blue-500"/>
          </section>

          <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-4 text-slate-800 dark:text-slate-200">
            <div class="flex justify-between items-center">
                <h2 class="text-lg font-semibold">æ’ä¾¿ç´€éŒ„</h2>
                <div id="daily-bowel-summary" class="text-xs text-slate-500 dark:text-slate-400 font-mono"></div>
            </div>
            <label class="flex items-center select-none">
              <input type="checkbox" id="no-bowel-today" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 custom-checkbox mr-2"/>
              ä»Šå¤©ç„¡æ’ä¾¿
            </label>
            <div id="bowel-records-container" class="space-y-5"></div>
            <button id="add-bowel-record-btn" class="w-full mt-2 text-blue-600 font-semibold py-2 px-4 rounded-lg border-2 border-dashed border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/50 transition flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" class="mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
              æ–°å¢ä¸€ç­†æ’ä¾¿ç´€éŒ„
            </button>
          </section>

          <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm text-slate-800 dark:text-slate-200">
            <h3 class="text-base font-semibold mb-2">æ˜¨æ™šç¡çœ å“è³ª</h3>
            <div id="sleep-quality-rating" class="star-rating flex items-center justify-center space-x-2 text-4xl"></div>
          </section>
          
          <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm text-slate-800 dark:text-slate-200">
            <h3 class="text-base font-semibold mb-2">æ˜¨æ™šå¤œé–“èµ·åºŠæ¬¡æ•¸</h3>
            <div id="night-waking-options" class="option-button-group flex flex-wrap gap-2 justify-center">
                <button type="button" class="option-button text-sm py-2 px-4 rounded-full border border-slate-200 dark:border-slate-600" data-value="0">0 æ¬¡</button>
                <button type="button" class="option-button text-sm py-2 px-4 rounded-full border border-slate-200 dark:border-slate-600" data-value="1">1 æ¬¡</button>
                <button type="button" class="option-button text-sm py-2 px-4 rounded-full border border-slate-200 dark:border-slate-600" data-value="2">2 æ¬¡</button>
                <button type="button" class="option-button text-sm py-2 px-4 rounded-full border border-slate-200 dark:border-slate-600" data-value="3">3 æ¬¡</button>
                <button type="button" class="option-button text-sm py-2 px-4 rounded-full border border-slate-200 dark:border-slate-600" data-value="4">4 æ¬¡</button>
                <button type="button" class="option-button text-sm py-2 px-4 rounded-full border border-slate-200 dark:border-slate-600" data-value="5">5+ æ¬¡</button>
            </div>
          </section>

          <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm text-slate-800 dark:text-slate-200">
            <h3 class="text-base font-semibold mb-2">RBD ç—‡ç‹€ (æ˜¨æ™š)</h3>
            <div id="rbd-symptoms" class="space-y-2"></div>
            <textarea id="rbd-other-notes" rows="2" class="w-full mt-2 p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md hidden" placeholder="è«‹æè¿°å…¶ä»–ç—‡ç‹€"></textarea>
          </section>

          <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm text-slate-800 dark:text-slate-200">
            <h3 class="text-base font-semibold mb-2">ç”¨è—¥ç´€éŒ„</h3>
            <textarea id="medication-log" rows="3" class="w-full p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md" placeholder="è«‹è¨˜éŒ„æ‚¨ä»Šå¤©æœç”¨çš„è—¥ç‰©ã€æ™‚é–“å’ŒåŠ‘é‡ã€‚"></textarea>
          </section>

          <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm text-slate-800 dark:text-slate-200">
            <h3 class="text-base font-semibold mb-2">æ¯æ—¥å‚™è¨»</h3>
            <textarea id="daily-notes" rows="3" class="w-full p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md" placeholder="è¨˜éŒ„ä»»ä½•å…¶ä»–æƒ³è¨˜ä¸‹çš„äº‹æƒ…..."></textarea>
          </section>

          <button id="save-log-button" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform active:scale-95 flex items-center justify-center text-lg">
            <span id="save-log-button-content">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="mr-2 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
              å„²å­˜æœ¬æ—¥å®Œæ•´æ—¥èªŒ
            </span>
          </button>
        </div>
      </div>

      <!-- ========= çµ±è¨ˆé  ========= -->
      <div id="stats-page" class="page space-y-6">
        <div class="flex justify-between items-center bg-white dark:bg-slate-800 p-3 rounded-xl shadow-sm">
          <button id="prev-week-btn" class="px-3 py-2 rounded-md bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-800 dark:text-slate-200 transition-colors">&lt; ä¸Šä¸€é€±</button>
          <h2 id="stats-week-title" class="text-lg font-semibold text-slate-800 dark:text-slate-200 text-center">æœ¬é€±çµ±è¨ˆ</h2>
          <button id="next-week-btn" class="px-3 py-2 rounded-md bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-800 dark:text-slate-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>ä¸‹ä¸€é€± &gt;</button>
        </div>

        <section id="ai-insight-section" class="bg-blue-50 dark:bg-blue-900/50 border-l-4 border-blue-500 p-4 rounded-r-lg shadow-sm space-y-2 text-blue-800 dark:text-blue-200">
          <h3 class="text-lg font-semibold flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="m12 3-1.45 4.75L6 9l4.75 1.45L12 15l1.45-4.75L18 9l-4.75-1.45z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
            æœ¬é€±æ´å¯Ÿ
          </h3>
          <p id="ai-insight-text" class="text-sm"></p>
        </section>

        <section id="bowel-analysis-section" class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-4 text-slate-800 dark:text-slate-200"></section>
        <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-4 text-slate-800 dark:text-slate-200">
          <h3 class="text-lg font-semibold">æ˜¨æ™šç¡çœ å“è³ªè¶¨å‹¢</h3>
          <div class="relative h-64 md:h-80"><canvas id="sleep-chart" class="chart-canvas"></canvas></div>
          <div id="stats-summary-sleep" class="text-sm text-center text-slate-500 dark:text-slate-400 pt-2"></div>
        </section>
         <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-4 text-slate-800 dark:text-slate-200">
          <h3 class="text-lg font-semibold">å¤œé–“èµ·åºŠæ¬¡æ•¸</h3>
          <div class="relative h-64 md:h-80"><canvas id="night-waking-chart" class="chart-canvas"></canvas></div>
          <div id="stats-summary-night-waking" class="text-sm text-center text-slate-500 dark:text-slate-400 pt-2"></div>
        </section>
        <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-4 text-slate-800 dark:text-slate-200">
          <h3 class="text-lg font-semibold">æ’ä¾¿æ™‚é–“é»åˆ†ä½ˆ</h3>
          <div class="relative h-64 md:h-80"><canvas id="bowel-time-chart" class="chart-canvas"></canvas></div>
        </section>
        <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-4 text-slate-800 dark:text-slate-200">
          <h3 class="text-lg font-semibold">æ’ä¾¿é¡å‹è¶¨å‹¢</h3>
          <div class="relative h-64 md:h-80"><canvas id="bowel-chart" class="chart-canvas"></canvas></div>
          <div id="stats-summary-bowel" class="text-sm text-center text-slate-500 dark:text-slate-400 pt-2"></div>
        </section>
        <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-4 text-slate-800 dark:text-slate-200">
          <h3 class="text-lg font-semibold">RBD ç—‡ç‹€çµ±è¨ˆ</h3>
          <div class="relative h-64 md:h-80"><canvas id="rbd-chart" class="chart-canvas"></canvas></div>
          <div id="stats-summary-rbd" class="text-sm text-center text-slate-500 dark:text-slate-400 pt-2"></div>
        </section>
        <section id="health-tips-section" class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-3 text-slate-800 dark:text-slate-200"></section>
        <!-- å·²ç§»é™¤åŒ¯å‡º PDF æŒ‰éˆ•å€å¡Š -->
      </div>

      <!-- ========= æ­·å²é  ========= -->
      <div id="history-page" class="page">
        <section class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm text-slate-800 dark:text-slate-200">
          <h2 class="text-lg font-semibold mb-4">è³‡æ–™ç®¡ç†</h2>
          <div class="grid grid-cols-2 gap-2 mb-4">
            <button id="export-csv-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" class="mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
              åŒ¯å‡ºç‚º CSV
            </button>
            <button id="import-csv-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" class="mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
              åŒ¯å…¥ CSV
            </button>
          </div>
          <p id="last-backup-time" class="text-xs text-center text-slate-500 dark:text-slate-400 mb-4"></p>
          <input type="file" id="import-file-input" class="hidden" accept=".csv, text/csv"/>
          <h2 class="text-lg font-semibold mb-4 mt-6">æ‰€æœ‰æ—¥èªŒç´€éŒ„</h2>
          <div id="history-list" class="space-y-3"></div>
        </section>
      </div>
    </main>

    <!-- ç¢ºèª Modal -->
    <div id="confirmation-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
      <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 max-w-sm w-full">
        <h3 id="modal-title" class="text-lg font-bold text-slate-800 dark:text-slate-200 mb-2">ç¢ºèªæ“ä½œ</h3>
        <p id="modal-message" class="text-sm text-slate-600 dark:text-slate-400 mb-6">æ‚¨ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
        <div class="flex justify-end space-x-3">
          <button id="modal-cancel-btn" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 text-slate-800 dark:text-slate-200 rounded-md">å–æ¶ˆ</button>
          <button id="modal-confirm-btn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md">ç¢ºå®š</button>
        </div>
      </div>
    </div>
    
    <!-- åœ–è¡¨é»æ“Šè©³ç´°è³‡æ–™ Modal -->
    <div id="log-detail-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-5 max-w-sm w-full max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="log-detail-title" class="text-lg font-bold text-slate-800 dark:text-slate-200">è©²æ—¥è©³ç´°ç´€éŒ„</h3>
                <button id="log-detail-close-btn" class="text-slate-500 hover:text-slate-800 dark:hover:text-slate-200">&times;</button>
            </div>
            <div id="log-detail-content" class="text-sm text-slate-700 dark:text-slate-300 space-y-3"></div>
        </div>
    </div>

  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    dayjs.extend(dayjs_plugin_relativeTime);
    dayjs.extend(dayjs_plugin_customParseFormat);
    dayjs.locale('zh-tw');

    const bristolData = [
      { type: 1, d: "ä¸€é¡†é¡†ç¡¬çƒ", svg: `<path d="M10 6 a 2 2 0 0 1 0 4 a 2 2 0 0 1 0 -4 M14 5 a 2 2 0 0 1 0 4 a 2 2 0 0 1 0 -4 M18 6 a 2 2 0 0 1 0 4 a 2 2 0 0 1 0 -4 M12 9 a 2 2 0 0 1 0 4 a 2 2 0 0 1 0 -4 M16 9 a 2 2 0 0 1 0 4 a 2 2 0 0 1 0 -4" fill="#734c35"/>`},
      { type: 2, d: "å‡¹å‡¸çš„é¦™è…¸ç‹€", svg: `<path d="M6 8 C 8 6, 16 6, 18 8 S 16 12, 14 12 C 12 12, 10 14, 8 12 S 6 10, 6 8" fill="#8c5a3f"/>`},
      { type: 3, d: "æœ‰è£‚ç—•çš„é¦™è…¸ç‹€", svg: `<path d="M5 10 C 8 8, 16 8, 19 10 S 16 12, 12 12 S 8 12, 5 10 M8 9 l 1 2 M12 9 l 1 2 M16 9 l 1 2" fill="#a66d4a" stroke="#8c5a3f" stroke-width="0.5"/>`},
      { type: 4, d: "å…‰æ»‘çš„é¦™è…¸ç‹€", svg: `<path d="M5 10 C 8 8, 16 8, 19 10 S 16 12, 12 12 S 8 12, 5 10" fill="#c07e56"/>`},
      { type: 5, d: "æŸ”è»Ÿçš„å¡Šç‹€", svg: `<path d="M7 8 a 3 3 0 0 1 0 6 a 3 3 0 0 1 0 -6 M12 7 a 3 3 0 0 1 0 6 a 3 3 0 0 1 0 -6 M17 8 a 3 3 0 0 1 0 6 a 3 3 0 0 1 0 -6" fill="#d98f61"/>`},
      { type: 6, d: "ç³Šç‹€", svg: `<path d="M6 12 C 6 8, 10 7, 12 9 C 14 11, 18 10, 18 12 S 14 15, 12 14 C 10 13, 6 16, 6 12" fill="#e6a06d"/>`},
      { type: 7, d: "æ°´ç‹€", svg: `<path d="M5 12 C 5 9, 20 9, 20 12 S 5 15, 5 12" fill="#f2b178" fill-opacity="0.8"/>`}
    ];
    const bowelColorData = [
      { name: 'å•¡è‰²', colorClass: 'fill-[#7B4F34]' }, { name: 'ç¶ è‰²', colorClass: 'fill-[#5A6335]' },
      { name: 'é»‘è‰²', colorClass: 'fill-[#1E1E1E]' }, { name: 'ç°ç™½è‰²', colorClass: 'fill-[#A9A9A9]' },
      { name: 'ç´…è‰²', colorClass: 'fill-[#9E2B25]' }, { name: 'é»ƒè‰²', colorClass: 'fill-[#DAA520]' }
    ];
    const bowelVolumes = ['å°‘é‡', 'ä¸­ç­‰', 'å¤§é‡'];
    const bowelDurations = ['10åˆ†é˜ä»¥ä¸Š', '3-10åˆ†é˜', '1-3åˆ†é˜'];
    const bowelSymptoms = ['ç„¡', 'è‚šå­ç—›', 'èƒƒè„¹æ°£', 'å±çœ¼åœ¨ç‡’', 'è…¸çµç—›', 'è‚›é–€ç—›', 'è£¡æ€¥å¾Œé‡', 'ä¾¿æ„ç›ç„¶'];
    const bowelAdditionalStatus = ['ç„¡', 'æ€µç›®è¡€è·¡', 'ä¾¿ä¸­æœ‰é»æ¶²', 'å¤§ä¾¿æƒ¡è‡­çƒ˜çƒ˜', 'å¤§ä¾¿é»ç¨ ', 'å¤§ä¾¿ç´°å¦‚ç­†', 'æ¶ˆåŒ–ä¸è‰¯'];
    const rbdSymptomsList = [
      { id: 'none', label: 'ç„¡ç—‡ç‹€' }, { id: 'shouting', label: 'å¤§è²å«å–Š' },
      { id: 'movement', label: 'è‚¢é«”å‹•ä½œ' }, { id: 'vivid-dreams', label: 'ç”Ÿå‹•å¤¢å¢ƒ' },
      { id: 'sleep-talking', label: 'æ¿€å‹•å¤¢è©±' }, { id: 'self-injury', label: 'ä½¿è‡ªå·±å—å‚·' },
      { id: 'partner-injury', label: 'ä½¿ä¼´ä¾¶å—å‚·' }, { id: 'other', label: 'å…¶ä»–' }
    ];

    let appState = {
      dailyLogs: {},
      currentDate: dayjs().format('YYYY-MM-DD'),
      currentPage: 'log-page',
      charts: { bowel: null, rbd: null, bowelTime: null, sleep: null, nightWaking: null },
      statsWeekOffset: 0,
    };

    const DOM = {
      app: document.getElementById('app'),
      appHeaderTop: document.getElementById('app-header-top'),
      appNav: document.getElementById('app-nav'),
      html: document.documentElement,
      headerTitle: document.getElementById('header-title'),
      pages: document.querySelectorAll('.page'),
      navItems: document.querySelectorAll('.nav-item'),
      toast: document.getElementById('toast-notification'),
      logDate: document.getElementById('log-date'),
      noBowelToday: document.getElementById('no-bowel-today'),
      bowelRecordsContainer: document.getElementById('bowel-records-container'),
      addBowelRecordBtn: document.getElementById('add-bowel-record-btn'),
      dailyBowelSummary: document.getElementById('daily-bowel-summary'),
      sleepQualityRating: document.getElementById('sleep-quality-rating'),
      nightWakingOptions: document.getElementById('night-waking-options'),
      rbdSymptoms: document.getElementById('rbd-symptoms'),
      rbdOtherNotes: document.getElementById('rbd-other-notes'),
      medicationLog: document.getElementById('medication-log'),
      dailyNotes: document.getElementById('daily-notes'),
      saveLogButton: document.getElementById('save-log-button'),
      saveLogButtonContent: document.getElementById('save-log-button-content'),
      statsPage: document.getElementById('stats-page'), 
      aiInsightText: document.getElementById('ai-insight-text'), 
      historyList: document.getElementById('history-list'),
      lastBackupTime: document.getElementById('last-backup-time'),
      statsWeekTitle: document.getElementById('stats-week-title'),
      prevWeekBtn: document.getElementById('prev-week-btn'),
      nextWeekBtn: document.getElementById('next-week-btn'),
      bowelAnalysisSection: document.getElementById('bowel-analysis-section'),
      sleepChartCanvas: document.getElementById('sleep-chart'),
      nightWakingChartCanvas: document.getElementById('night-waking-chart'),
      bowelTimeChartCanvas: document.getElementById('bowel-time-chart'),
      bowelChartCanvas: document.getElementById('bowel-chart'),
      rbdChartCanvas: document.getElementById('rbd-chart'),
      statsSummarySleep: document.getElementById('stats-summary-sleep'),
      statsSummaryNightWaking: document.getElementById('stats-summary-night-waking'),
      statsSummaryBowel: document.getElementById('stats-summary-bowel'),
      statsSummaryRbd: document.getElementById('stats-summary-rbd'),
      healthTipsSection: document.getElementById('health-tips-section'),
      exportCsvBtn: document.getElementById('export-csv-btn'),
      importCsvBtn: document.getElementById('import-csv-btn'),
      importFileInput: document.getElementById('import-file-input'),
      confirmationModal: document.getElementById('confirmation-modal'),
      modalTitle: document.getElementById('modal-title'),
      modalMessage: document.getElementById('modal-message'),
      modalCancelBtn: document.getElementById('modal-cancel-btn'),
      modalConfirmBtn: document.getElementById('modal-confirm-btn'),
      logDetailModal: document.getElementById('log-detail-modal'),
      logDetailTitle: document.getElementById('log-detail-title'),
      logDetailContent: document.getElementById('log-detail-content'),
      logDetailCloseBtn: document.getElementById('log-detail-close-btn'),
      themeToggle: document.getElementById('theme-toggle'),
      themeIconSun: document.getElementById('theme-icon-sun'),
      themeIconMoon: document.getElementById('theme-icon-moon'),
    };

    function cleanInvisible(str) {
      if (str === null || str === undefined) return '';
      return String(str).replace(/\uFEFF/g, '').replace(/\r/g, '').replace(/\u200B/g, '').trim();
    }
    
    function triggerHapticFeedback(ms = 50) {
        if (navigator.vibrate) {
            navigator.vibrate(ms);
        }
    }

    function init() {
      setupPWA();
      setupTheme();
      loadData();
      renderStaticComponents();
      setupEventListeners();
      setupGestureListeners(); 
      DOM.logDate.value = appState.currentDate;
      loadLogForDate(appState.currentDate);
      navigateTo('log-page');
    }

    function setupPWA() {
        const manifest = {
            "name": "å¥åº·æ—¥èªŒ", "short_name": "å¥åº·æ—¥èªŒ", "start_url": ".",
            "display": "standalone", "background_color": "#f8fafc", "theme_color": "#3B82F6",
            "description": "æ‚¨çš„å€‹äººåŒ–å¥åº·èˆ‡æ’ä¾¿æ—¥èªŒã€‚",
            "icons": [{"src": "https://placehold.co/192x192/3B82F6/FFFFFF?text=Log", "sizes": "192x192", "type": "image/png"}, {"src": "https://placehold.co/512x512/3B82F6/FFFFFF?text=Log", "sizes": "512x512", "type": "image/png"}]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        if (!document.querySelector('link[rel="manifest"]')) {
            const manifestLink = document.createElement('link');
            manifestLink.rel = 'manifest';
            manifestLink.href = manifestURL;
            document.head.appendChild(manifestLink);
        }
    }

    function loadData() {
      try {
        const data = localStorage.getItem('healthLogApp');
        if (data) appState.dailyLogs = JSON.parse(data);
      } catch (error) { console.error("ç„¡æ³•è®€å– localStorage è³‡æ–™:", error); appState.dailyLogs = {}; }
    }
    function saveData() {
      localStorage.setItem('healthLogApp', JSON.stringify(appState.dailyLogs));
    }

    function getEmptyLog() {
      return { noBowel: false, bowel: [], sleep: 0, nightWakings: -1, rbd: { symptoms: [], other: '' }, meds: '', dailyNotes: '' };
    }
    function getEmptyBowelRecord() {
      return { id: Date.now(), bowelTimeOfDay: '', types: [], color: '', volume: '', duration: '', notes: '', symptoms: [], additionalStatus: [] };
    }

    function loadLogForDate(date) {
      const log = appState.dailyLogs[date] || getEmptyLog();
      DOM.noBowelToday.checked = log.noBowel;
      toggleBowelSection(log.noBowel);
      renderBowelForms(log.bowel);
      updateDailyBowelSummary();
      updateStars(log.sleep);
      
      DOM.nightWakingOptions.querySelectorAll('.option-button').forEach(btn => {
        btn.classList.toggle('selected', parseInt(btn.dataset.value) === log.nightWakings);
      });

      const rbdCheckboxes = DOM.rbdSymptoms.querySelectorAll('input[type="checkbox"]');
      rbdCheckboxes.forEach(input => {
        input.checked = log.rbd.symptoms.includes(input.id);
        input.disabled = false;
      });
      updateRbdCheckboxStates();
      DOM.rbdOtherNotes.value = log.rbd.other;
      DOM.rbdOtherNotes.classList.toggle('hidden', !log.rbd.symptoms.includes('other'));
      DOM.medicationLog.value = log.meds;
      DOM.dailyNotes.value = log.dailyNotes;
    }

    async function saveLogForDate(date) {
        if (!validateLogForm()) return;
        triggerHapticFeedback();
        const originalContent = DOM.saveLogButtonContent.innerHTML;
        DOM.saveLogButton.disabled = true;
        DOM.saveLogButtonContent.innerHTML = `<svg class="spinner w-6 h-6 mr-2 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>å„²å­˜ä¸­...`;
        await new Promise(resolve => setTimeout(resolve, 500));
        const bowelRecordsRaw = [];
        document.querySelectorAll('.bowel-record-form').forEach(form => {
            const getSelected = (className) => Array.from(form.querySelectorAll(`.${className} .selected`)).map(btn => btn.dataset.value);
            bowelRecordsRaw.push({
                id: form.dataset.id,
                bowelTimeOfDay: form.querySelector('.bowel-time-of-day').value,
                types: Array.from(form.querySelectorAll('.bristol-item.bristol-selected')).map(item => parseInt(item.dataset.type)),
                color: form.querySelector('.color-item.bristol-selected')?.dataset.value || '',
                volume: form.querySelector('.volume-options .selected')?.dataset.value || '',
                duration: form.querySelector('.duration-options .selected')?.dataset.value || '',
                notes: form.querySelector('.bowel-notes').value,
                symptoms: getSelected('symptoms-options'),
                additionalStatus: getSelected('status-options')
            });
        });
        const bowelRecords = bowelRecordsRaw.filter(r => r.types.length > 0);
        const selectedNightWaking = DOM.nightWakingOptions.querySelector('.option-button.selected');

        appState.dailyLogs[date] = {
            noBowel: DOM.noBowelToday.checked,
            bowel: DOM.noBowelToday.checked ? [] : bowelRecords,
            sleep: DOM.sleepQualityRating.querySelectorAll('.star.selected').length,
            nightWakings: selectedNightWaking ? parseInt(selectedNightWaking.dataset.value) : -1,
            rbd: {
                symptoms: Array.from(document.querySelectorAll('#rbd-symptoms input:checked')).map(el => el.id),
                other: DOM.rbdOtherNotes.value
            },
            meds: DOM.medicationLog.value,
            dailyNotes: DOM.dailyNotes.value
        };
        if (appState.dailyLogs[date].bowel && appState.dailyLogs[date].bowel.length > 0) {
            appState.dailyLogs[date].noBowel = false;
        }
        saveData();
        DOM.saveLogButtonContent.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="mr-2 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>å„²å­˜æˆåŠŸï¼`;
        setTimeout(() => {
            DOM.saveLogButton.disabled = false;
            DOM.saveLogButtonContent.innerHTML = originalContent;
            showToast('æœ¬æ—¥æ—¥èªŒå·²å„²å­˜ï¼', 'success');
        }, 1200);
    }

    function renderStaticComponents() {
      DOM.sleepQualityRating.innerHTML = '';
      for (let i = 1; i <= 5; i++) DOM.sleepQualityRating.innerHTML += `<span class="star" data-value="${i}">&#9733;</span>`;
      DOM.rbdSymptoms.innerHTML = rbdSymptomsList.map(s => `<label class="flex items-center has-[:disabled]:text-slate-400"><input type="checkbox" id="${s.id}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 custom-checkbox mr-2"> ${s.label}</label>`).join('');
      DOM.healthTipsSection.innerHTML = `<h3 class="text-lg font-semibold">ğŸ’¡ å¥åº·å°æç¤º</h3><ul class="text-sm text-slate-600 dark:text-slate-400 space-y-2 list-disc list-inside"><li><b>ç†æƒ³ä¾¿ä¾¿ï¼š</b>ä»¥ã€Œå¸ƒé‡Œæ–¯æ‰˜å¤§ä¾¿åˆ†é¡æ³•ã€ç¬¬3â€“4å‹ç‚ºä½³ï¼Œç‰¹åˆ¥æ˜¯ç¬¬4å‹æœ€ç†æƒ³ã€‚</li><li><b>æ³¨æ„è­¦è¨Šï¼š</b>ç¬¬1â€“2å‹åç¡¬å¯èƒ½ä¾¿ç¥•ï¼›ç¬¬6â€“7å‹åç¨€å±¬è…¹ç€‰ï¼Œè‹¥æŒçºŒå‡ºç¾å»ºè­°å°±é†«ã€‚</li><li><b>å¥åº·é »ç‡ï¼š</b>ä¸€é€±ç´„7æ¬¡ã€å½¢æ…‹å¤šåœ¨ç¬¬3â€“4å‹ï¼Œé€šå¸¸ä»£è¡¨è…¸é“åŠŸèƒ½ä½³ã€‚</li><li><b>é¡è‰²è§€å¯Ÿï¼š</b>é»ƒè¤/æ£•è‰²å¸¸è¦‹ï¼›è‹¥æŒçºŒé»‘ã€ç´…æˆ–ç°ç™½è‰²éœ€æé«˜è­¦è¦ºã€‚</li><li><b>ç”Ÿæ´»ç¿’æ…£ï¼š</b>å½¢ç‹€å—æ°´åˆ†èˆ‡çº–ç¶­å½±éŸ¿å¤§ï¼›è¦å¾‹é‹å‹•èˆ‡æ’ä¾¿ç¿’æ…£åŒæ¨£é‡è¦ã€‚</li></ul>`;
    }
    function renderBowelForms(records = []) {
      DOM.bowelRecordsContainer.innerHTML = '';
      if (records.length === 0 && !DOM.noBowelToday.checked) records.push(getEmptyBowelRecord());
      records.forEach((record, index) => DOM.bowelRecordsContainer.insertAdjacentHTML('beforeend', createBowelFormHTML(record, index + 1)));
    }
    function createBowelFormHTML(record, index) {
      return `<div class="bowel-record-form border-t-2 border-slate-200 dark:border-slate-700 pt-4" data-id="${record.id}"><div class="flex justify-between items-center mb-3"><h4 class="font-semibold text-md text-slate-700 dark:text-slate-300">ç¬¬ ${index} ç­†ç´€éŒ„</h4><button class="remove-bowel-record-btn text-sm font-medium text-red-500 hover:text-red-700">åˆªé™¤æ­¤ç­†</button></div><div class="form-section border-slate-200 dark:border-slate-700"><div class="grid grid-cols-3 gap-2">${bristolData.map(item => `<div class="bristol-item p-2 rounded-lg border-2 border-slate-200 dark:border-slate-600 cursor-pointer text-center flex flex-col justify-start ${record.types.includes(item.type) ? 'bristol-selected' : ''}" data-type="${item.type}" tabindex="0"><svg viewBox="0 0 24 18" class="w-12 h-8 mx-auto mb-1">${item.svg}</svg><p class="font-semibold text-xs text-slate-800 dark:text-slate-200">é¡å‹ ${item.type}</p><p class="text-[10px] text-slate-500 dark:text-slate-400 leading-tight mt-1">${item.d}</p></div>`).join('')}</div></div><div class="space-y-3 mt-3"><div class="form-section border-slate-200 dark:border-slate-700"><label class="form-section-label text-slate-600 dark:text-slate-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z" clip-rule="evenodd"/></svg>æ’ä¾¿æ™‚é–“é»</label><input type="time" class="bowel-time-of-day w-full p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-200 rounded-md" value="${record.bowelTimeOfDay || ''}"></div><div class="form-section border-slate-200 dark:border-slate-700"><label class="form-section-label text-slate-600 dark:text-slate-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 2zM10 15a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 15zM10 7a3 3 0 100 6 3 3 0 000-6z"/></svg>é¡è‰²</label><div class="color-options grid grid-cols-3 gap-2">${bowelColorData.map(color => `<div class="color-item p-2 rounded-lg border-2 border-slate-200 dark:border-slate-600 cursor-pointer text-center flex flex-col items-center justify-center ${record.color === color.name ? 'bristol-selected' : ''}" data-value="${color.name}"><svg viewBox="0 0 24 24" class="w-10 h-10 mb-1 ${color.colorClass}"><path d="M18,10c0,4-1.8,5-6,5s-6-1-6-5c0-2,1-5,6-5S18,8,18,10Z M17,14c0,2-1,3-5,3s-5-1-5-3c0-1,0-2,1-3c1.5-1.5,3.5-1.5,4-1.5s2.5,0,4,1.5C17,12,17,13,17,14Z M15,17c0,1-1,1.5-3,1.5s-3-.5-3-1.5c0,0,1-1,3-1S15,17,15,17Z"/></svg><p class="text-xs text-slate-600 dark:text-slate-400">${color.name}</p></div>`).join('')}</div></div><div class="grid grid-cols-2 gap-3">${createOptionGroup('æ’ä¾¿é‡', 'volume-options', bowelVolumes, record.volume, false)}${createOptionGroup('æ’ä¾¿è€—æ™‚', 'duration-options', bowelDurations, record.duration, false)}</div>${createOptionGroup('ç—‡ç‹€', 'symptoms-options', bowelSymptoms, record.symptoms, true)}${createOptionGroup('é™„åŠ ç‹€æ…‹', 'status-options', bowelAdditionalStatus, record.additionalStatus, true)}<div class="form-section border-slate-200 dark:border-slate-700"><label class="form-section-label text-slate-600 dark:text-slate-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z"/><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z"/></svg>å‚™è¨»</label><textarea class="bowel-notes w-full p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-200 rounded-md">${record.notes || ''}</textarea></div></div></div>`;
    }
    function createOptionGroup(label, className, options, selectedValues, isMultiSelect) {
      const groupClass = isMultiSelect ? `option-button-group ${className} multi-select-group flex flex-wrap gap-2` : `option-button-group ${className} flex flex-wrap gap-2`;
      const buttons = options.map(opt => `<button type="button" class="option-button text-sm py-1 px-3 rounded-full border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 ${(Array.isArray(selectedValues) ? selectedValues.includes(opt) : opt === selectedValues) ? 'selected' : ''}" data-value="${opt}">${opt}</button>`).join('');
      return `<div class="form-section border-slate-200 dark:border-slate-700"><label class="form-section-label text-sm text-slate-600 dark:text-slate-400">${label}</label><div class="${groupClass}">${buttons}</div></div>`;
    }
    
    function renderHistoryList() {
        const sortedDates = Object.keys(appState.dailyLogs).sort().reverse();
        DOM.lastBackupTime.textContent = localStorage.getItem('healthLogBackupTime') ? `ä¸Šæ¬¡å‚™ä»½æ™‚é–“ï¼š${dayjs(parseInt(localStorage.getItem('healthLogBackupTime'))).format('YYYY/MM/DD HH:mm')}` : 'å°šæœªå‚™ä»½éè³‡æ–™ã€‚';

        if (sortedDates.length === 0) {
            DOM.historyList.innerHTML = `<p class="text-center text-slate-500 dark:text-slate-400 py-8">ç›®å‰æ²’æœ‰ä»»ä½•æ—¥èªŒç´€éŒ„ã€‚</p>`;
            return;
        }
        DOM.historyList.innerHTML = sortedDates.map(date => {
            const log = appState.dailyLogs[date];
            const sleep = log.sleep > 0 ? `${'â˜…'.repeat(log.sleep)}${'â˜†'.repeat(5 - log.sleep)}` : 'æœªè¨˜éŒ„';
            const nightWakingsText = (log.nightWakings >= 0) ? `${log.nightWakings}${log.nightWakings === 5 ? '+' : ''} æ¬¡` : 'æœªè¨˜éŒ„';
            const rbdText = log.rbd.symptoms.length > 0 ? log.rbd.symptoms.map(id => rbdSymptomsList.find(s => s.id === id)?.label || '').join(', ') : 'ç„¡';
            
            const bowelSummary = log.noBowel ? '<span class="text-slate-500 dark:text-slate-400">ç•¶æ—¥ç„¡æ’ä¾¿</span>' : 
                (log.bowel && log.bowel.length > 0 ? 
                    `<ul class="list-none pl-1 text-xs space-y-1">${log.bowel.map(b => `<li>${b.bowelTimeOfDay ? `<b>${b.bowelTimeOfDay}</b> - ` : ''}é¡å‹ ${Array.isArray(b.types) && b.types.length ? b.types.join(',') : '?'} (${b.color||'N/A'})</li>`).join('')}</ul>` 
                    : '<span class="text-slate-500 dark:text-slate-400">æœªè¨˜éŒ„</span>');

            return `<div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                <div class="flex justify-between items-center mb-3">
                    <p class="font-bold text-lg text-slate-800 dark:text-slate-200">${dayjs(date).format('YYYYå¹´MæœˆDæ—¥')}</p>
                    <button class="edit-log-btn text-sm text-blue-600 hover:underline" data-date="${date}">æŸ¥çœ‹/ç·¨è¼¯</button>
                </div>
                <div class="text-sm text-slate-700 dark:text-slate-300 space-y-2">
                    <ul class="list-none pl-0 space-y-1">
                        <li><span class="inline-block w-6">ğŸ›Œ</span> ç¡çœ : ${sleep}</li>
                        <li><span class="inline-block w-6">ğŸŒ™</span> å¤œé–“èµ·åºŠ: ${nightWakingsText}</li>
                        <li class="flex items-start"><span class="inline-block w-6 pt-0.5">ğŸ’©</span> <div class="flex-1">æ’ä¾¿ç´€éŒ„: ${bowelSummary}</div></li>
                        <li><span class="inline-block w-6">ğŸ˜´</span> RBD ç—‡ç‹€: ${rbdText}</li>
                    </ul>
                </div>
            </div>`;
        }).join('');
    }


    function getChartColors() {
      const isDarkMode = DOM.html.classList.contains('dark');
      return { gridColor: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)', textColor: isDarkMode ? '#cbd5e1' : '#475569' };
    }

    function updateCharts() {
      const weekStart = dayjs().subtract(appState.statsWeekOffset, 'week').startOf('week');
      const weekEnd = dayjs().subtract(appState.statsWeekOffset, 'week').endOf('week');
      DOM.statsWeekTitle.textContent = `${weekStart.format('YYYY/M/D')} - ${weekEnd.format('M/D')}`;
      DOM.nextWeekBtn.disabled = appState.statsWeekOffset <= 0;
      const weekData = getWeekData(weekStart); 
      generateHealthInsights(weekData); 
      updateBowelAnalysis(weekStart);
      updateSleepChart(weekData);
      updateNightWakingChart(weekData);
      updateBowelTimeChart(weekData);
      updateBowelChart(weekData);
      updateRbdChart(weekData);
    }

    function getWeekData(weekStart) {
        const data = { labels: [], sleep: [], nightWakings: [], bowel: [], bowelCount: [], rbd: [], dates: [] };
        for (let i = 0; i < 7; i++) {
            const date = weekStart.add(i, 'day');
            const dateStr = date.format('YYYY-MM-DD');
            const log = appState.dailyLogs[dateStr];
            data.labels.push(date.format('M/D'));
            data.dates.push(dateStr);
            data.sleep.push(log ? log.sleep : null);
            data.nightWakings.push(log && log.nightWakings >= 0 ? log.nightWakings : null);
            data.bowel.push(log && log.bowel && log.bowel.length > 0 ? log.bowel.flatMap(b => b.types) : null);
            data.bowelCount.push(log && log.bowel ? log.bowel.length : 0);
            data.rbd.push(log && log.rbd && log.rbd.symptoms.length > 0 && !log.rbd.symptoms.includes('none') ? log.rbd.symptoms.length : 0);
        }
        return data;
    }

    function generateHealthInsights(weekData) {
        const insights = [];
        const validSleep = weekData.sleep.filter(s => s > 0);
        const avgSleep = validSleep.length > 0 ? validSleep.reduce((a, b) => a + b, 0) / validSleep.length : 0;
        const validWakings = weekData.nightWakings.filter(w => w !== null);
        const avgWakings = validWakings.length > 0 ? validWakings.reduce((a,b) => a+b, 0) / validWakings.length : 0;
        const allBowelTypes = weekData.bowel.flat().filter(b => b !== null);
        const avgBowel = allBowelTypes.length > 0 ? allBowelTypes.reduce((a, b) => a + b, 0) / allBowelTypes.length : 0;
        
        if (validSleep.length > 0 || allBowelTypes.length > 0 || validWakings.length > 0) {
            let summary = `æœ¬é€±å¹³å‡ç¡çœ å“è³ªç‚º ${avgSleep.toFixed(1)} é¡†æ˜Ÿï¼Œå¤œé–“å¹³å‡èµ·åºŠ ${avgWakings.toFixed(1)} æ¬¡ï¼Œå¹³å‡æ’ä¾¿é¡å‹ç‚º ${avgBowel.toFixed(1)} å‹ã€‚`;
            insights.push(summary);
        } else {
            insights.push('æœ¬é€±å°šç„¡è¶³å¤ æ•¸æ“šä¾†ç”¢ç”Ÿæ´å¯Ÿã€‚');
        }
        let poorSleepAndBowelDays = 0;
        for(let i=0; i<7; i++) {
            const sleep = weekData.sleep[i];
            const bowelTypes = weekData.bowel[i];
            if (sleep && sleep <= 2 && bowelTypes) {
                const dayAvgBowel = bowelTypes.reduce((a, b) => a + b, 0) / bowelTypes.length;
                if (dayAvgBowel <= 2 || dayAvgBowel >= 6) poorSleepAndBowelDays++;
            }
        }
        if (poorSleepAndBowelDays >= 2) insights.push('è§€å¯Ÿåˆ°æ‚¨ç¡çœ å“è³ªè¼ƒå·®çš„æ—¥å­ï¼Œæ’ä¾¿ç‹€æ³ä¼¼ä¹ä¹Ÿè¼ƒä¸ç†æƒ³ã€‚å……è¶³çš„ç¡çœ æœ‰åŠ©æ–¼è…¸é“å¥åº·ï¼Œå€¼å¾—å¤šåŠ ç•™æ„ã€‚');
        const totalRbd = weekData.rbd.reduce((a, b) => a + b, 0);
        if (totalRbd >= 3) insights.push(`æœ¬é€± RBD ç—‡ç‹€è¼ƒç‚ºé »ç¹ï¼ˆå…± ${totalRbd} æ¬¡ï¼‰ã€‚è‹¥æ­¤æƒ…æ³æŒçºŒï¼Œå»ºè­°è«®è©¢å°ˆæ¥­é†«å¸«ã€‚`);
        DOM.aiInsightText.innerHTML = insights.join('<br>');
    }

    function updateBowelAnalysis(weekStart) {
      const allLogs = appState.dailyLogs;
      let lastBM = null;
      const sortedDates = Object.keys(allLogs).sort().reverse();
      for (const date of sortedDates) {
        if (allLogs[date].bowel && allLogs[date].bowel.length > 0) {
          const sortedBMs = allLogs[date].bowel.filter(b => b.bowelTimeOfDay).sort((a, b) => b.bowelTimeOfDay.localeCompare(a.bowelTimeOfDay));
          if (sortedBMs.length > 0) { lastBM = dayjs(`${date} ${sortedBMs[0].bowelTimeOfDay}`); break; }
        }
      }
      const getStatsForPeriod = (startDate, endDate) => {
        let totalBMs = 0, goodBMs = 0;
        for (let d = startDate; d.isBefore(endDate) || d.isSame(endDate); d = d.add(1, 'day')) {
          const log = allLogs[d.format('YYYY-MM-DD')];
          if (log && log.bowel && log.bowel.length > 0) {
            totalBMs += log.bowel.length;
            log.bowel.forEach(b => { if (Array.isArray(b.types) && (b.types.includes(3) || b.types.includes(4))) goodBMs++; });
          }
        }
        return { totalBMs, goodBMs };
      };
      const currentWeekStats = getStatsForPeriod(weekStart, weekStart.add(6, 'day'));
      const previousWeekStats = getStatsForPeriod(weekStart.subtract(7, 'day'), weekStart.subtract(1, 'day'));
      const goodBMPercent = currentWeekStats.totalBMs > 0 ? Math.round((currentWeekStats.goodBMs / currentWeekStats.totalBMs) * 100) : 0;
      const prevGoodBMPercent = previousWeekStats.totalBMs > 0 ? Math.round((previousWeekStats.goodBMs / previousWeekStats.totalBMs) * 100) : 0;
      const weekLabel = appState.statsWeekOffset === 0 ? 'æœ¬é€±' : 'è©²é€±';
      DOM.bowelAnalysisSection.innerHTML = `<h3 class="text-lg font-semibold">æ’ä¾¿åˆ†æ</h3><p class="text-sm text-slate-600 dark:text-slate-400"><b>ä¸Šä¸€æ¬¡æ’ä¾¿ï¼š</b> ${lastBM ? lastBM.fromNow() : 'ç„¡ç´€éŒ„'}</p><div class="grid grid-cols-2 gap-4 text-center"><div class="bg-slate-100 dark:bg-slate-700 p-3 rounded-lg"><p class="text-2xl font-bold">${currentWeekStats.totalBMs} <span class="text-sm font-normal">æ¬¡</span></p><p class="text-xs text-slate-500 dark:text-slate-400">${weekLabel}</p><p class="text-xs text-slate-500 dark:text-slate-400 mt-1">ç›¸è¼ƒæ–¼å‰7å¤©çš„ ${previousWeekStats.totalBMs} æ¬¡</p></div><div class="bg-slate-100 dark:bg-slate-700 p-3 rounded-lg"><p class="text-2xl font-bold">${goodBMPercent}<span class="text-sm font-normal">%</span></p><p class="text-xs text-slate-500 dark:text-slate-400">${weekLabel}å¥½å¤§ä¾¿</p><p class="text-xs text-slate-500 dark:text-slate-400 mt-1">ç›¸è¼ƒæ–¼å‰7å¤©çš„ ${prevGoodBMPercent}%</p></div></div>`;
    }
    
    function createChartClickHandler(weekData) {
        return (evt) => {
            const chartId = evt.chart.canvas.id.replace('-chart', '');
            const chartInstance = appState.charts[chartId];
            if (!chartInstance) return;
            const points = chartInstance.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
            if (points.length) {
                const firstPoint = points[0];
                const date = weekData.dates[firstPoint.index];
                showLogDetailModal(date);
            }
        };
    }

    function updateSleepChart(weekData) {
      const colors = getChartColors();
      if (appState.charts.sleep) appState.charts.sleep.destroy();
      appState.charts.sleep = new Chart(DOM.sleepChartCanvas, { type: 'line', data: { labels: weekData.labels, datasets: [{ label: 'ç¡çœ å“è³ª', data: weekData.sleep, borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', fill: true, tension: 0.3, spanGaps: true }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 1, max: 5, ticks: { stepSize: 1, color: colors.textColor }, grid: { color: colors.gridColor } }, x: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } } }, plugins: { legend: { display: false } }, onClick: createChartClickHandler(weekData) } });
      const validRecords = weekData.sleep.filter(p => p !== null);
      DOM.statsSummarySleep.textContent = validRecords.length > 0 ? `æœ¬é€±å¹³å‡ç¡çœ å“è³ªç‚º ${(validRecords.reduce((a, b) => a + b, 0) / validRecords.length).toFixed(1)} é¡†æ˜Ÿã€‚` : 'æœ¬é€±æ²’æœ‰ç¡çœ å“è³ªç´€éŒ„ã€‚';
    }

    function updateNightWakingChart(weekData) {
        const colors = getChartColors();
        if (appState.charts.nightWaking) appState.charts.nightWaking.destroy();
        appState.charts.nightWaking = new Chart(DOM.nightWakingChartCanvas, {
            type: 'bar',
            data: {
                labels: weekData.labels,
                datasets: [{
                    label: 'å¤œé–“èµ·åºŠæ¬¡æ•¸',
                    data: weekData.nightWakings,
                    backgroundColor: 'rgba(139, 92, 246, 0.6)',
                    borderColor: 'rgba(139, 92, 246, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1, color: colors.textColor }, grid: { color: colors.gridColor } },
                    x: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } }
                },
                plugins: { legend: { display: false } },
                onClick: createChartClickHandler(weekData)
            }
        });
        const validRecords = weekData.nightWakings.filter(w => w !== null);
        DOM.statsSummaryNightWaking.textContent = validRecords.length > 0 ? `æœ¬é€±å¹³å‡å¤œé–“èµ·åºŠ ${(validRecords.reduce((a, b) => a + b, 0) / validRecords.length).toFixed(1)} æ¬¡ã€‚` : 'æœ¬é€±æ²’æœ‰å¤œé–“èµ·åºŠç´€éŒ„ã€‚';
    }

    function updateBowelTimeChart(weekData) {
      const colors = getChartColors();
      const datasets = [];
      weekData.dates.forEach((dateStr, i) => {
        const log = appState.dailyLogs[dateStr];
        if (log && log.bowel && log.bowel.length > 0) {
          log.bowel.forEach(b => {
            if (b.bowelTimeOfDay) {
              const time = dayjs(b.bowelTimeOfDay, 'HH:mm');
              datasets.push({ x: i, y: time.hour() + time.minute() / 60, types: Array.isArray(b.types) ? b.types.join(', ') : '' });
            }
          });
        }
      });
      if (appState.charts.bowelTime) appState.charts.bowelTime.destroy();
      appState.charts.bowelTime = new Chart(DOM.bowelTimeChartCanvas, { type: 'scatter', data: { datasets: [{ label: 'æ’ä¾¿æ™‚é–“', data: datasets, backgroundColor: 'rgba(59, 130, 246, 0.7)', pointRadius: 6, pointHoverRadius: 8 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'linear', position: 'bottom', ticks: { color: colors.textColor, stepSize: 1, callback: (value) => weekData.labels[value] || '' }, grid: { display: false } }, y: { reverse: true, min: 0, max: 24, ticks: { color: colors.textColor, stepSize: 3, callback: (value) => `${String(value).padStart(2, '0')}:00` }, grid: { color: colors.gridColor } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => { const d = c.dataset.data[c.dataIndex]; const h = Math.floor(d.y); const m = Math.round((d.y - h) * 60); return `æ™‚é–“: ${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')} (é¡å‹: ${d.types})`; } } } }, onClick: createChartClickHandler(weekData) } });
    }
    function updateBowelChart(weekData) {
      const colors = getChartColors();
      const dataPoints = weekData.bowel.map(dayBowel => {
        if (dayBowel && dayBowel.length > 0) return dayBowel.reduce((a, b) => a + b, 0) / dayBowel.length;
        return null;
      });
      if (appState.charts.bowel) appState.charts.bowel.destroy();
      appState.charts.bowel = new Chart(DOM.bowelChartCanvas, { type: 'line', data: { labels: weekData.labels, datasets: [{ label: 'å¸ƒé‡Œæ–¯æ‰˜åˆ†é¡', data: dataPoints, borderColor: '#3B82F6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.3, spanGaps: true }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 1, max: 7, ticks: { stepSize: 1, color: colors.textColor }, grid: { color: colors.gridColor } }, x: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } } }, plugins: { legend: { display: false } }, onClick: createChartClickHandler(weekData) } });
      const validRecords = dataPoints.filter(p => p !== null);
      DOM.statsSummaryBowel.textContent = validRecords.length > 0 ? `æœ¬é€±å¹³å‡é¡å‹ç‚º ${(validRecords.reduce((a, b) => a + b, 0) / validRecords.length).toFixed(1)}ã€‚` : 'æœ¬é€±æ²’æœ‰æ’ä¾¿ç´€éŒ„ã€‚';
    }
    function updateRbdChart(weekData) {
      const colors = getChartColors();
      const rbdSymptomMap = rbdSymptomsList.reduce((acc, s) => ({...acc, [s.id]: s.label}), {});
      const tooltipLabels = weekData.dates.map(dateStr => {
          const log = appState.dailyLogs[dateStr];
          if (log && Array.isArray(log.rbd.symptoms) && log.rbd.symptoms.length > 0 && !log.rbd.symptoms.includes('none')) {
              return log.rbd.symptoms.map(id => rbdSymptomMap[id] || id).join('ã€ ');
          }
          return 'ç„¡ç—‡ç‹€';
      });
      if (appState.charts.rbd) appState.charts.rbd.destroy();
      appState.charts.rbd = new Chart(DOM.rbdChartCanvas, { type: 'bar', data: { labels: weekData.labels, datasets: [{ label: 'ç—‡ç‹€æ¬¡æ•¸', data: weekData.rbd, backgroundColor: 'rgba(239, 68, 68, 0.6)', borderColor: 'rgba(239, 68, 68, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, color: colors.textColor }, grid: { color: colors.gridColor } }, x: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.parsed.y} æ¬¡`, afterLabel: (c) => tooltipLabels[c.dataIndex] } } }, onClick: createChartClickHandler(weekData) } });
      DOM.statsSummaryRbd.textContent = `æœ¬é€±å…±è¨˜éŒ„ ${weekData.rbd.reduce((a, b) => a + b, 0)} æ¬¡RBDç›¸é—œç—‡ç‹€ã€‚`;
    }

    function setupEventListeners() {
      DOM.logDate.addEventListener('change', e => { appState.currentDate = e.target.value; loadLogForDate(appState.currentDate); });
      DOM.noBowelToday.addEventListener('change', e => { toggleBowelSection(e.target.checked); updateDailyBowelSummary(); });
      DOM.addBowelRecordBtn.addEventListener('click', () => { DOM.bowelRecordsContainer.insertAdjacentHTML('beforeend', createBowelFormHTML(getEmptyBowelRecord(), DOM.bowelRecordsContainer.children.length + 1)); updateDailyBowelSummary(); });
      
      DOM.bowelRecordsContainer.addEventListener('click', e => {
        const t = e.target;
        let summaryNeedsUpdate = false;
        const bristolItem = t.closest('.bristol-item'); if (bristolItem) { bristolItem.classList.toggle('bristol-selected'); summaryNeedsUpdate = true; }
        const colorItem = t.closest('.color-item'); if (colorItem) { const g = colorItem.closest('.color-options'); g.querySelectorAll('.color-item').forEach(i => i.classList.remove('bristol-selected')); colorItem.classList.add('bristol-selected'); summaryNeedsUpdate = true; }
        const optionButton = t.closest('.option-button'); if (optionButton) { const g = optionButton.closest('.option-button-group'); if (g.classList.contains('multi-select-group')) { if (optionButton.dataset.value === 'ç„¡') { g.querySelectorAll('.option-button').forEach(b => b.classList.remove('selected')); optionButton.classList.add('selected'); } else { const n = g.querySelector('[data-value="ç„¡"]'); if (n) n.classList.remove('selected'); optionButton.classList.toggle('selected'); } } else { g.querySelectorAll('.option-button').forEach(b => b.classList.remove('selected')); optionButton.classList.add('selected'); } summaryNeedsUpdate = true; }
        
        if (t.classList.contains('remove-bowel-record-btn')) {
            const formToRemove = t.closest('.bowel-record-form');
            showConfirmation('æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ç­†æ’ä¾¿ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚', () => {
                formToRemove.remove();
                DOM.bowelRecordsContainer.querySelectorAll('h4').forEach((h, i) => h.textContent = `ç¬¬ ${i + 1} ç­†ç´€éŒ„`);
                updateDailyBowelSummary();
            });
        }
        if (summaryNeedsUpdate) updateDailyBowelSummary();
      });

      DOM.sleepQualityRating.addEventListener('click', e => { if (e.target.classList.contains('star')) updateStars(e.target.dataset.value); });
      DOM.nightWakingOptions.addEventListener('click', e => {
        const button = e.target.closest('.option-button');
        if (button) {
            DOM.nightWakingOptions.querySelectorAll('.option-button').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
        }
      });
      DOM.rbdSymptoms.addEventListener('change', () => { const o = DOM.rbdSymptoms.querySelector('#other'); updateRbdCheckboxStates(); DOM.rbdOtherNotes.classList.toggle('hidden', !o.checked); if (!o.checked) DOM.rbdOtherNotes.value = ''; });
      DOM.saveLogButton.addEventListener('click', () => saveLogForDate(appState.currentDate));
      DOM.navItems.forEach(item => item.addEventListener('click', () => { triggerHapticFeedback(30); navigateTo(item.dataset.page); }));
      DOM.historyList.addEventListener('click', e => { const b = e.target.closest('.edit-log-btn'); if (b) { appState.currentDate = b.dataset.date; DOM.logDate.value = appState.currentDate; loadLogForDate(appState.currentDate); navigateTo('log-page'); } });
      DOM.prevWeekBtn.addEventListener('click', () => { appState.statsWeekOffset++; updateCharts(); });
      DOM.nextWeekBtn.addEventListener('click', () => { if (appState.statsWeekOffset > 0) { appState.statsWeekOffset--; updateCharts(); } });
      DOM.exportCsvBtn.addEventListener('click', exportDataAsCsv); 
      DOM.importCsvBtn.addEventListener('click', () => DOM.importFileInput.click());
      DOM.importFileInput.addEventListener('change', importData);
      DOM.themeToggle.addEventListener('click', toggleTheme);
      DOM.modalCancelBtn.addEventListener('click', () => DOM.confirmationModal.classList.add('hidden'));
      DOM.logDetailCloseBtn.addEventListener('click', () => DOM.logDetailModal.classList.add('hidden'));
      
      // å·²ç§»é™¤ PDF æŒ‰éˆ•çš„äº‹ä»¶ç›£è½å™¨
    }

    function setupGestureListeners() {
        let touchStartX = 0; let touchEndX = 0; const swipeThreshold = 50; 
        DOM.statsPage.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
        DOM.statsPage.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; handleSwipe(); }, { passive: true });
        function handleSwipe() {
            const swipeDistance = touchEndX - touchStartX;
            if (Math.abs(swipeDistance) < swipeThreshold) return; 
            if (swipeDistance > 0) { DOM.prevWeekBtn.click(); } 
            else { if (!DOM.nextWeekBtn.disabled) { DOM.nextWeekBtn.click(); } }
        }
    }

    function navigateTo(pageId) {
      appState.currentPage = pageId;
      DOM.pages.forEach(p => p.classList.toggle('active', p.id === pageId));
      const titles = { 'log-page': 'å¥åº·æ—¥èªŒ', 'stats-page': 'çµ±è¨ˆåœ–è¡¨', 'history-page': 'æ­·å²ç´€éŒ„' };
      DOM.headerTitle.textContent = titles[pageId] || 'å¥åº·æ—¥èªŒ';
      DOM.navItems.forEach(item => item.classList.toggle('active', item.dataset.page === pageId));
      if (pageId === 'history-page') renderHistoryList();
      else if (pageId === 'stats-page') { appState.statsWeekOffset = 0; updateCharts(); }
    }
    function updateStars(v) { DOM.sleepQualityRating.querySelectorAll('.star').forEach(s => s.classList.toggle('selected', Number(s.dataset.value) <= Number(v))); }
    function updateRbdCheckboxStates() {
      const n = DOM.rbdSymptoms.querySelector('#none'), o = DOM.rbdSymptoms.querySelectorAll('input:not(#none)');
      if (n.checked) { o.forEach(c => { c.checked = false; c.disabled = true; }); } 
      else { const a = Array.from(o).some(c => c.checked); n.disabled = a; o.forEach(c => { c.disabled = false; }); }
    }
    function toggleBowelSection(disabled) {
      DOM.bowelRecordsContainer.classList.toggle('bowel-record-disabled', disabled);
      DOM.addBowelRecordBtn.classList.toggle('bowel-record-disabled', disabled);
      if (disabled) DOM.bowelRecordsContainer.innerHTML = '';
      else if (DOM.bowelRecordsContainer.children.length === 0) renderBowelForms([]);
    }
    let toastTimer;
    function showToast(message, type = 'error') {
      clearTimeout(toastTimer);
      const t = DOM.toast;
      t.textContent = message;
      const c = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
      t.className = 'px-6 py-3 rounded-full font-semibold text-white shadow-lg';
      t.classList.add(c[type], 'show');
      toastTimer = setTimeout(() => t.classList.remove('show'), 4000);
    }
    function showConfirmation(message, onConfirm) {
        DOM.modalMessage.textContent = message;
        DOM.confirmationModal.classList.remove('hidden');
        const confirmHandler = () => { onConfirm(); DOM.confirmationModal.classList.add('hidden'); };
        DOM.modalConfirmBtn.replaceWith(DOM.modalConfirmBtn.cloneNode(true));
        DOM.modalConfirmBtn = document.getElementById('modal-confirm-btn');
        DOM.modalConfirmBtn.addEventListener('click', confirmHandler, { once: true });
    }
    
    function showLogDetailModal(date) {
        const log = appState.dailyLogs[date];
        DOM.logDetailTitle.textContent = `${dayjs(date).format('YYYY/MM/DD')} è©³ç´°ç´€éŒ„`;
        if (!log) {
            DOM.logDetailContent.innerHTML = `<p class="text-center text-slate-500 dark:text-slate-400">è©²æ—¥ç„¡ç´€éŒ„ã€‚</p>`;
            DOM.logDetailModal.classList.remove('hidden');
            return;
        }
        
        const sleep = log.sleep > 0 ? `${'â˜…'.repeat(log.sleep)}${'â˜†'.repeat(5 - log.sleep)}` : 'æœªè¨˜éŒ„';
        const nightWakingsText = (log.nightWakings >= 0) ? `${log.nightWakings}${log.nightWakings === 5 ? '+' : ''} æ¬¡` : 'æœªè¨˜éŒ„';
        const rbdText = log.rbd.symptoms.length > 0 ? log.rbd.symptoms.map(id => rbdSymptomsList.find(s => s.id === id)?.label || '').join(', ') : 'ç„¡';
        const bowelDetails = (b) => [Array.isArray(b.symptoms) ? b.symptoms.join(', ') : '', Array.isArray(b.additionalStatus) ? b.additionalStatus.join(', ') : ''].filter(Boolean).join('; ');

        let contentHTML = `
            <p><b>ç¡çœ å“è³ª:</b> ${sleep}</p>
            <p><b>å¤œé–“èµ·åºŠ:</b> ${nightWakingsText}</p>
            <div><b>æ’ä¾¿ç´€éŒ„:</b> ${log.noBowel ? '<span class="text-slate-500">ç•¶æ—¥ç„¡æ’ä¾¿</span>' : (log.bowel && log.bowel.length > 0 ? `<ul class="list-disc list-inside pl-2 mt-1 text-xs space-y-1">${log.bowel.map(b => `<li>${b.bowelTimeOfDay ? `<b>${b.bowelTimeOfDay}</b> - ` : ''}é¡å‹ ${Array.isArray(b.types) && b.types.length ? b.types.join(',') : '?'} (${b.color || 'N/A'}, ${b.volume || 'N/A'}, ${b.duration || 'N/A'})<br><span class="text-slate-500 dark:text-slate-400 pl-4 text-[11px]">${bowelDetails(b)}</span></li>`).join('')}</ul>` : '<span class="text-slate-500">æœªè¨˜éŒ„</span>')}</div>
            <p><b>RBD ç—‡ç‹€:</b> ${rbdText}</p>
            ${log.rbd.other ? `<p class="pl-4 text-xs text-slate-500"><b>RBDå‚™è¨»:</b> ${log.rbd.other}</p>` : ''}
            ${log.meds ? `<p><b>ç”¨è—¥ç´€éŒ„:</b> ${log.meds}</p>` : ''}
            ${log.dailyNotes ? `<p><b>æ¯æ—¥å‚™è¨»:</b> ${log.dailyNotes}</p>` : ''}
        `;
        DOM.logDetailContent.innerHTML = contentHTML;
        DOM.logDetailModal.classList.remove('hidden');
    }

    function setupTheme() {
      const savedTheme = localStorage.getItem('theme');
      const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
        DOM.html.classList.add('dark'); DOM.themeIconSun.classList.remove('hidden');
      } else {
        DOM.html.classList.remove('dark'); DOM.themeIconMoon.classList.remove('hidden');
      }
    }
    function toggleTheme() {
      const isDark = DOM.html.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      DOM.themeIconSun.classList.toggle('hidden', !isDark);
      DOM.themeIconMoon.classList.toggle('hidden', isDark);
      if (appState.currentPage === 'stats-page') updateCharts();
    }

    function validateLogForm() {
      const missing = [];
      if (DOM.sleepQualityRating.querySelectorAll('.star.selected').length === 0) missing.push('æ˜¨æ™šç¡çœ å“è³ª');
      if (!DOM.nightWakingOptions.querySelector('.option-button.selected')) missing.push('å¤œé–“èµ·åºŠæ¬¡æ•¸');
      if (document.querySelectorAll('#rbd-symptoms input:checked').length === 0) missing.push('RBD ç—‡ç‹€');
      if (!DOM.noBowelToday.checked) {
        const bowelForms = document.querySelectorAll('.bowel-record-form');
        if (bowelForms.length === 0) missing.push('è‡³å°‘ä¸€ç­†æ’ä¾¿ç´€éŒ„');
        bowelForms.forEach((form, index) => {
          const r = `ç¬¬ ${index + 1} ç­†æ’ä¾¿`;
          if (form.querySelectorAll('.bristol-item.bristol-selected').length === 0) missing.push(`${r}çš„é¡å‹`);
          if (!form.querySelector('.bowel-time-of-day').value) missing.push(`${r}çš„æ™‚é–“`);
          if (!form.querySelector('.color-item.bristol-selected')) missing.push(`${r}çš„é¡è‰²`);
          if (!form.querySelector('.volume-options .selected')) missing.push(`${r}çš„æ’ä¾¿é‡`);
          if (!form.querySelector('.duration-options .selected')) missing.push(`${r}çš„æ’ä¾¿è€—æ™‚`);
          if (form.querySelectorAll('.symptoms-options .selected').length === 0) missing.push(`${r}çš„ç—‡ç‹€`);
          if (form.querySelectorAll('.status-options .selected').length === 0) missing.push(`${r}çš„é™„åŠ ç‹€æ…‹`);
        });
      }
      if (missing.length > 0) { showToast(`è«‹å®Œæˆä»¥ä¸‹æ¬„ä½ï¼š${missing.join('ã€')}`, 'error'); return false; }
      return true;
    }
    
    function updateDailyBowelSummary() {
        const forms = DOM.bowelRecordsContainer.querySelectorAll('.bowel-record-form');
        if (forms.length === 0 || DOM.noBowelToday.checked) {
            DOM.dailyBowelSummary.textContent = '';
            return;
        }

        const allTypes = [];
        const colorCounts = {};
        
        forms.forEach(form => {
            form.querySelectorAll('.bristol-item.bristol-selected').forEach(item => {
                allTypes.push(parseInt(item.dataset.type));
            });
            const selectedColor = form.querySelector('.color-item.bristol-selected');
            if (selectedColor) {
                const color = selectedColor.dataset.value;
                colorCounts[color] = (colorCounts[color] || 0) + 1;
            }
        });

        if (allTypes.length === 0) {
            DOM.dailyBowelSummary.textContent = '';
            return;
        }

        const avgType = allTypes.reduce((a, b) => a + b, 0) / allTypes.length;
        const mostFrequentColor = Object.keys(colorCounts).reduce((a, b) => colorCounts[a] > colorCounts[b] ? a : b, '');

        DOM.dailyBowelSummary.textContent = `ä»Šæ—¥å¹³å‡: é¡å‹ ${avgType.toFixed(1)}, ä¸»è¦é¡è‰²: ${mostFrequentColor || 'N/A'}`;
    }

    function parseCsvRow(rowString) {
      const values = []; let currentVal = ''; let inQuotes = false;
      for (let i = 0; i < rowString.length; i++) {
        const char = rowString[i];
        if (char === '"') { if (inQuotes && rowString[i + 1] === '"') { currentVal += '"'; i++; } else { inQuotes = !inQuotes; } } 
        else if (char === ',' && !inQuotes) { values.push(currentVal); currentVal = ''; } 
        else { currentVal += char; }
      }
      values.push(currentVal); return values;
    }
    function formatCsvCell(value) {
        const strValue = String(value === null || value === undefined ? '' : value).replace(/"/g, '""');
        if (strValue.includes(',') || strValue.includes('"') || strValue.includes('\n')) return `"${strValue}"`;
        return strValue;
    }

    function exportDataAsCsv() {
        const headers = [
            'date', 'sleep', 'nightWakings',
            'bowelTimeOfDay', 'types', 'color', 'volume', 'duration', 'symptoms', 'additionalStatus', 'notes',
            'rbdSymptoms', 'rbdOther',
            'meds', 'dailyNotes'
        ];
        const csvRows = [headers.join(',')];

        const sortedDates = Object.keys(appState.dailyLogs).sort();
        for (const date of sortedDates) {
            const log = appState.dailyLogs[date];
            const safeLog = { ...getEmptyLog(), ...log };
            const safeRbd = safeLog.rbd || { symptoms: [], other: '' };

            if (safeLog.bowel && safeLog.bowel.length > 0) {
                safeLog.bowel.forEach(bowel => {
                    csvRows.push([
                        date,
                        safeLog.sleep,
                        safeLog.nightWakings >= 0 ? safeLog.nightWakings : '',
                        bowel.bowelTimeOfDay || '',
                        bowel.types ? bowel.types.join('/') : '',
                        bowel.color || '',
                        bowel.volume || '',
                        bowel.duration || '',
                        bowel.symptoms ? bowel.symptoms.join('/') : '',
                        bowel.additionalStatus ? bowel.additionalStatus.join('/') : '',
                        bowel.notes || '',
                        safeRbd.symptoms ? safeRbd.symptoms.join('/') : '',
                        safeRbd.other || '',
                        safeLog.meds || '',
                        safeLog.dailyNotes || ''
                    ].map(formatCsvCell).join(','));
                });
            } else {
                csvRows.push([
                    date,
                    safeLog.sleep,
                    safeLog.nightWakings >= 0 ? safeLog.nightWakings : '',
                    '', '', '', '', '', '', '', '',
                    safeRbd.symptoms ? safeRbd.symptoms.join('/') : '',
                    safeRbd.other || '',
                    safeLog.meds || '',
                    safeLog.dailyNotes || ''
                ].map(formatCsvCell).join(','));
            }
        }

        const csvString = csvRows.join('\n');
        const blob = new Blob([`\uFEFF${csvString}`], { type: 'text/csv;charset=utf-8;' });
        const fileName = `health_log_${dayjs().format('YYYYMMDD_HHmmss')}.csv`;
        
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        localStorage.setItem('healthLogBackupTime', Date.now());
        if (appState.currentPage === 'history-page') renderHistoryList();
        showToast('è³‡æ–™å·²é–‹å§‹ä¸‹è¼‰ï¼', 'success');
    }

    function importData(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) { showToast('CSV æª”æ¡ˆç‚ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¢ºã€‚', 'error'); return; }
            
            const headers = parseCsvRow(lines.shift()).map(cleanInvisible);
            const requiredHeaders = ['date', 'sleep'];
            if (!requiredHeaders.every(h => headers.includes(h))) {
                showToast(`CSV æª”æ¡ˆç¼ºå°‘å¿…è¦çš„æ¬„ä½ (å¦‚: ${requiredHeaders.join(', ')})ã€‚`, 'error');
                return;
            }

            const importedLogs = {}; 
            let errorCount = 0; 
            let errorMessages = [];

            lines.forEach((line, index) => {
                try {
                    const values = parseCsvRow(line);
                    const rowData = headers.reduce((obj, h, i) => ({...obj, [h]: values[i] || ''}), {});
                    const date = dayjs(rowData.date).format('YYYY-MM-DD');
                    if (date === 'Invalid Date') throw new Error(`æ—¥æœŸæ ¼å¼ç„¡æ•ˆ: "${rowData.date}"`);

                    if (!importedLogs[date]) {
                        importedLogs[date] = {
                            bowel: [],
                            noBowel: true,
                            sleep: parseInt(rowData.sleep, 10) || 0,
                            nightWakings: rowData.nightWakings ? parseInt(rowData.nightWakings, 10) : -1,
                            rbd: {
                                symptoms: rowData.rbdSymptoms ? rowData.rbdSymptoms.split('/').filter(s => s) : [],
                                other: rowData.rbdOther || ''
                            },
                            meds: rowData.meds || '',
                            dailyNotes: rowData.dailyNotes || ''
                        };
                    }

                    if (rowData.bowelTimeOfDay || (rowData.types && rowData.types.length > 0)) {
                        importedLogs[date].bowel.push({
                            id: Date.now() + index,
                            bowelTimeOfDay: rowData.bowelTimeOfDay,
                            types: rowData.types ? rowData.types.split('/').map(Number) : [],
                            color: rowData.color,
                            volume: rowData.volume,
                            duration: rowData.duration,
                            symptoms: rowData.symptoms ? rowData.symptoms.split('/').filter(s => s) : [],
                            additionalStatus: rowData.additionalStatus ? rowData.additionalStatus.split('/').filter(s => s) : [],
                            notes: rowData.notes
                        });
                        importedLogs[date].noBowel = false;
                    }

                } catch (err) {
                    errorCount++;
                    if (errorMessages.length < 3) errorMessages.push(`ç¬¬ ${index + 2} è¡Œ: ${err.message}`);
                }
            });

            Object.values(importedLogs).forEach(log => {
                log.noBowel = log.bowel.length === 0;
            });

            if (errorCount > 0) {
                const detailedError = `åŒ¯å…¥å®Œæˆï¼Œä½†æœ‰ ${errorCount} è¡Œè³‡æ–™è§£æå¤±æ•—ã€‚\nå¸¸è¦‹éŒ¯èª¤:\n${errorMessages.join('\n')}`;
                showToast(detailedError, 'error');
            }

            showConfirmation(`æˆåŠŸè§£æ ${Object.keys(importedLogs).length} ç­†æ—¥èªŒã€‚ç¢ºå®šè¦åŒ¯å…¥ä¸¦è¦†è“‹ç¾æœ‰è³‡æ–™å—ï¼Ÿ`, () => {
                Object.assign(appState.dailyLogs, importedLogs);
                saveData();
                showToast('è³‡æ–™åŒ¯å…¥æˆåŠŸï¼', 'success');
                if (appState.currentPage === 'history-page') renderHistoryList();
                loadLogForDate(appState.currentDate);
            });
        };
        reader.onerror = () => showToast('ç„¡æ³•è®€å–æª”æ¡ˆã€‚', 'error');
        reader.readAsText(file);
        event.target.value = '';
    }
    
    init();
  });
  </script>
</body>
</html>
